<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Coil Data Checker</title>
    <meta http-equiv="Cache-Control" content="no-store">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: gap: blob: https:; connect-src 'self' https: wss: ws:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; img-src 'self' data: https: blob:; media-src 'self' https: blob:;">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Neue', cursive, sans-serif;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 8px;
            overflow-x: hidden;
        }

        .header-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: bold;
            color: #00ff66;
            text-shadow: 1px 1px 3px #000;
            margin: 0;
            line-height: 1.3;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .half-width {
            flex: 1;
            margin: 0 !important;
        }

        .third-width {
            flex: 1;
            margin: 0 !important;
        }

        .coil-details-display {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            min-height: 60px;
            margin-top: 10px;
        }

        /* Mobile-optimized input styling */
        input, button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }

        input[type="text"], input[type="file"] {
            background: #ecf0f1;
            color: #2c3e50;
            font-family: 'Comic Neue', cursive, sans-serif;
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #00ff66;
        }

        button {
            background-color: #1abc9c;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Comic Neue', cursive, sans-serif;
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
            background-color: #16a085;
        }

        button.clear-button {
            background-color: #e74c3c;
        }

        button.clear-button:active {
            background-color: #c0392b;
        }

        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Section headers */
        h2 {
            font-size: 18px;
            margin: 0 0 15px 0;
            text-align: left;
            color: #fff;
            font-weight: bold;
        }

        /* Suggestion dropdowns */
        #suggestions, #vehicleSuggestions, #reportVehicleSuggestions {
            background: white;
            color: #2c3e50;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 30px);
            z-index: 10;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #ddd;
        }

        #suggestions div, #vehicleSuggestions div, #reportVehicleSuggestions div {
            padding: 14px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            font-family: 'Comic Neue', cursive, sans-serif;
        }

        #suggestions div:hover, #vehicleSuggestions div:hover, #reportVehicleSuggestions div:hover {
            background-color: #f8f9fa;
        }

        #suggestions div:last-child, #vehicleSuggestions div:last-child, #reportVehicleSuggestions div:last-child {
            border-bottom: none;
        }

        #result table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #result table td {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            word-wrap: break-word;
            vertical-align: top;
        }

        #result table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* QR Code Scanner */
        #reader {
            width: 100%;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            min-height: 50px;
        }

        .input-container {
            position: relative;
        }

        /* File name display */
        #fileName {
            color: #ecf0f1;
            font-size: 14px;
            margin: 5px 0;
            text-align: center;
            word-wrap: break-word;
        }

        /* Added coils display */
        #addedCoils {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            min-height: 20px;
        }

        #addedCoils h3 {
            margin: 0 0 10px 0;
            color: #00ff66;
            font-size: 16px;
        }

        /* Touch-friendly file input */
        input[type="file"] {
            background: rgba(255, 255, 255, 0.9);
            border: 2px dashed #3498db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            padding: 20px;
        }

        input[type="file"]::-webkit-file-upload-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px 5px;
            }
            
            .header-title h1 {
                font-size: 20px;
            }
            
            .container {
                padding: 12px;
            }
            
            input, button {
                font-size: 16px;
                padding: 12px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            #suggestions, #vehicleSuggestions, #reportVehicleSuggestions {
                font-size: 14px;
            }
            
            #suggestions div, #vehicleSuggestions div, #reportVehicleSuggestions div {
                padding: 12px;
            }
        }

        /* Very small screens */
        @media (max-width: 320px) {
            .header-title h1 {
                font-size: 18px;
            }
            
            input, button {
                font-size: 14px;
                padding: 10px;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Prevent zoom on iOS */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }

        /* Permission request overlay */
        .permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .permission-dialog {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #2c3e50;
            max-width: 300px;
            margin: 20px;
        }

        .permission-dialog h3 {
            margin-top: 0;
            color: #e74c3c;
        }

        .permission-dialog button {
            margin: 5px;
            padding: 10px 20px;
            width: auto;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error messages */
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="header-title">
        <h1>A.S.Shipping Agencies Pvt Ltd,<br>(Greenways Group) - V: 4.1</h1>
    </div>

    <div class="container">
        <!-- Coil Details Section -->
        <div class="section">
            <h2>Coil Details</h2>
            <div id="result" class="coil-details-display"></div>
        </div>

        <!-- Coil Processing Section -->
        <div class="section">
            <h2>Coil Processing</h2>
            <div class="input-container">
                <input type="text" id="coilInput" placeholder="Enter Coil Number" oninput="showSuggestions(); toggleClearButton();" autocomplete="off" />
                <div id="suggestions"></div>
            </div>
            <div class="input-container">
                <input type="text" id="vehicleInput" placeholder="Enter Vehicle Number" oninput="showVehicleSuggestions(); toggleVehicleClearButton();" autocomplete="off" />
                <div id="vehicleSuggestions"></div>
            </div>
            
            <div class="button-row">
                <button class="third-width" onclick="startScanner()">Scan QR</button>
                <button class="third-width" id="addBtn" onclick="addCoilToVehicle()">Add Coil</button>
                <button class="third-width clear-button" onclick="clearInputs()">Clear</button>
            </div>
            
            <div class="button-row">
                <button class="third-width" id="saveBtn" onclick="saveVehicleCoils()">Save</button>
                <button class="third-width" id="generateBtn" onclick="generateTextFile()" disabled>Generate Text</button>
                <button class="third-width clear-button" id="clearVehicleBtn" onclick="clearVehicleInput()" style="display: none;">Clear Vehicle</button>
            </div>
            
            <div id="reader" ondblclick="closeScanner()"></div>
            <div id="addedCoils"></div>
        </div>

        <!-- Generate Reports Section -->
        <div class="section">
            <h2>Generate Reports</h2>
            <div class="input-container">
                <input type="text" id="reportVehicleInput" placeholder="Enter Vehicle Number for Report" oninput="showReportVehicleSuggestions(); toggleReportVehicleClearButton();" autocomplete="off" />
                <div id="reportVehicleSuggestions"></div>
            </div>
            <div class="button-row">
                <button class="half-width" onclick="generateAllOutDataReport()">All OUT Data Report</button>
                <button class="half-width" onclick="generateVehicleOutReport()">Generate Vehicle Report</button>
            </div>
            <button id="clearReportVehicleBtn" class="clear-button" onclick="clearReportVehicleInput()" style="display: none;">Clear Report Vehicle</button>
        </div>

        <!-- File Management Section -->
        <div class="section">
            <h2>File Management</h2>
            <input type="file" id="excelFile" accept=".xlsx, .xls" />
            <p id="fileName"></p>
            <div class="button-row">
                <button class="third-width" onclick="uploadExcel()">Upload Excel</button>
                <button class="third-width clear-button" onclick="clearLocalStorage()">Clear Storage</button>
                <button class="third-width clear-button" onclick="resetApp()">Clear All</button>
            </div>
            <div class="button-row">
                <button class="half-width" onclick="updateAppFromGithub()" style="background-color: #3498db;">Update App</button>
                <button class="half-width" onclick="setGithubToken()" style="background-color: #27ae60;">Set GitHub Token</button>
            </div>
        </div>
    </div>

    <script>
        // Permission handling for Cordova app
        class PermissionManager {
            constructor() {
                this.requiredPermissions = [
                    'android.permission.CAMERA',
                    'android.permission.WRITE_EXTERNAL_STORAGE',
                    'android.permission.READ_EXTERNAL_STORAGE'
                ];
                this.permissionStatus = {};
            }

            async initialize() {
                if (typeof cordova === 'undefined') {
                    console.log('Cordova not available - running in browser mode');
                    return true;
                }

                try {
                    await this.checkAllPermissions();
                    return true;
                } catch (error) {
                    console.error('Permission initialization failed:', error);
                    return false;
                }
            }

            async checkAllPermissions() {
                if (!window.cordova || !cordova.plugins.permissions) {
                    console.log('Permissions plugin not available');
                    return;
                }

                for (const permission of this.requiredPermissions) {
                    try {
                        const result = await this.checkPermission(permission);
                        this.permissionStatus[permission] = result;
                        console.log(`Permission ${permission}: ${result ? 'granted' : 'denied'}`);
                    } catch (error) {
                        console.error(`Error checking permission ${permission}:`, error);
                        this.permissionStatus[permission] = false;
                    }
                }
            }

            checkPermission(permission) {
                return new Promise((resolve) => {
                    if (!window.cordova || !cordova.plugins.permissions) {
                        resolve(true); // Assume granted if plugin not available
                        return;
                    }

                    cordova.plugins.permissions.checkPermission(permission, (result) => {
                        resolve(result.hasPermission);
                    }, (error) => {
                        console.error('Permission check error:', error);
                        resolve(false);
                    });
                });
            }

            requestPermission(permission) {
                return new Promise((resolve) => {
                    if (!window.cordova || !cordova.plugins.permissions) {
                        resolve(true);
                        return;
                    }

                    cordova.plugins.permissions.requestPermission(permission, (result) => {
                        const granted = result.hasPermission;
                        this.permissionStatus[permission] = granted;
                        resolve(granted);
                    }, (error) => {
                        console.error('Permission request error:', error);
                        resolve(false);
                    });
                });
            }

            async requestCameraPermission() {
                const permission = 'android.permission.CAMERA';
                
                if (this.permissionStatus[permission]) {
                    return true;
                }

                try {
                    const granted = await this.requestPermission(permission);
                    if (granted) {
                        this.showMessage('Camera permission granted', 'success');
                        return true;
                    } else {
                        this.showPermissionDialog('Camera', 'This app needs camera access to scan QR codes.');
                        return false;
                    }
                } catch (error) {
                    console.error('Camera permission request failed:', error);
                    this.showMessage('Camera permission request failed', 'error');
                    return false;
                }
            }

            async requestStoragePermission() {
                const permissions = [
                    'android.permission.WRITE_EXTERNAL_STORAGE',
                    'android.permission.READ_EXTERNAL_STORAGE'
                ];

                let allGranted = true;
                for (const permission of permissions) {
                    if (!this.permissionStatus[permission]) {
                        try {
                            const granted = await this.requestPermission(permission);
                            if (!granted) {
                                allGranted = false;
                                break;
                            }
                        } catch (error) {
                            console.error(`Storage permission request failed for ${permission}:`, error);
                            allGranted = false;
                            break;
                        }
                    }
                }

                if (allGranted) {
                    this.showMessage('Storage permission granted', 'success');
                    return true;
                } else {
                    this.showPermissionDialog('Storage', 'This app needs storage access to save Excel files.');
                    return false;
                }
            }

            showPermissionDialog(permissionType, message) {
                const overlay = document.createElement('div');
                overlay.className = 'permission-overlay';
                overlay.innerHTML = `
                    <div class="permission-dialog">
                        <h3>${permissionType} Permission Required</h3>
                        <p>${message}</p>
                        <button onclick="this.parentElement.parentElement.remove()">Close</button>
                        <button onclick="this.parentElement.parentElement.remove(); window.location.reload();">Retry</button>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            showMessage(text, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = text;
                
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(messageDiv, container.firstChild);
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 3000);
                }
            }

            isPermissionGranted(permission) {
                return this.permissionStatus[permission] === true;
            }

            areStoragePermissionsGranted() {
                return this.isPermissionGranted('android.permission.WRITE_EXTERNAL_STORAGE') &&
                       this.isPermissionGranted('android.permission.READ_EXTERNAL_STORAGE');
            }

            isCameraPermissionGranted() {
                return this.isPermissionGranted('android.permission.CAMERA');
            }
        }

        // Enhanced GitHub API integration with improved error handling
        class GitHubAPI {
            constructor() {
                this.GITHUB_OWNER = 'gmanand23';
                this.GITHUB_REPO = 'Coil_Info';
                this.FILE_PATH = 'coil-data.xlsx';
                this.EXCEL_URL = `https://raw.githubusercontent.com/${this.GITHUB_OWNER}/${this.GITHUB_REPO}/main/${this.FILE_PATH}`;
                this.API_BASE = `https://api.github.com/repos/${this.GITHUB_OWNER}/${this.GITHUB_REPO}`;
                this.token = localStorage.getItem('githubToken') || '';
                this.rateLimitRemaining = 5000;
                this.rateLimitResetTime = 0;
            }

            setToken(token) {
                this.token = token;
                if (token) {
                    localStorage.setItem('githubToken', token);
                } else {
                    localStorage.removeItem('githubToken');
                }
            }

            getToken() {
                if (!this.token) {
                    this.token = localStorage.getItem('githubToken') || '';
                }
                return this.token;
            }

            async makeAuthenticatedRequest(url, options = {}) {
                const token = this.getToken();
                if (!token) {
                    throw new Error('GitHub token is required. Please set your GitHub Personal Access Token.');
                }

                // Check rate limit
                if (this.rateLimitRemaining <= 0 && Date.now() < this.rateLimitResetTime) {
                    const waitTime = Math.ceil((this.rateLimitResetTime - Date.now()) / 1000);
                    throw new Error(`Rate limit exceeded. Please wait ${waitTime} seconds before trying again.`);
                }

                const headers = {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'CoilDataApp/4.1',
                    ...options.headers
                };

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    // Update rate limit info
                    this.rateLimitRemaining = parseInt(response.headers.get('X-RateLimit-Remaining') || '5000');
                    this.rateLimitResetTime = parseInt(response.headers.get('X-RateLimit-Reset') || '0') * 1000;

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let errorMessage = `GitHub API Error: ${response.status} ${response.statusText}`;
                        
                        if (errorData.message) {
                            errorMessage += ` - ${errorData.message}`;
                        }
                        
                        if (response.status === 401) {
                            errorMessage = 'Invalid GitHub token. Please check your Personal Access Token.';
                        } else if (response.status === 403) {
                            errorMessage = 'GitHub API rate limit exceeded or insufficient permissions.';
                        } else if (response.status === 404) {
                            errorMessage = 'Repository or file not found. Please check the repository settings.';
                        }

                        throw new Error(errorMessage);
                    }

                    return response;
                } catch (error) {
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('Network error. Please check your internet connection.');
                    }
                    throw error;
                }
            }

            async fetchExcelFile() {
                try {
                    console.log('Fetching Excel file from GitHub...');
                    
                    // Try public URL first (no authentication required)
                    const publicResponse = await fetch(`${this.EXCEL_URL}?t=${Date.now()}`);
                    if (publicResponse.ok) {
                        const arrayBuffer = await publicResponse.arrayBuffer();
                        console.log('Successfully fetched Excel file from public URL');
                        return new Uint8Array(arrayBuffer);
                    }

                    // Fall back to authenticated API
                    const response = await this.makeAuthenticatedRequest(`${this.API_BASE}/contents/${this.FILE_PATH}`);
                    const data = await response.json();
                    
                    if (data.content) {
                        const binaryString = atob(data.content);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        console.log('Successfully fetched Excel file from API');
                        return bytes;
                    }

                    throw new Error('No content found in GitHub response');
                } catch (error) {
                    console.error('Error fetching Excel file:', error);
                    throw error;
                }
            }

            async updateExcelFile(workbook, commitMessage = 'Update Excel file') {
                try {
                    console.log('Updating Excel file on GitHub...');
                    
                    const token = this.getToken();
                    if (!token) {
                        throw new Error('GitHub token is required to update files. Please set your GitHub Personal Access Token.');
                    }

                    // Get current file info
                    const fileResponse = await this.makeAuthenticatedRequest(`${this.API_BASE}/contents/${this.FILE_PATH}`);
                    const fileData = await fileResponse.json();

                    // Convert workbook to binary
                    const updatedContent = XLSX.write(workbook, { type: 'binary', bookType: 'xlsx' });
                    const updatedBase64 = btoa(updatedContent);

                    // Update file
                    const updateResponse = await this.makeAuthenticatedRequest(
                        `${this.API_BASE}/contents/${this.FILE_PATH}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: commitMessage,
                                content: updatedBase64,
                                sha: fileData.sha
                            })
                        }
                    );

                    const result = await updateResponse.json();
                    console.log('Successfully updated Excel file on GitHub');
                    return result;

                } catch (error) {
                    console.error('Error updating Excel file:', error);
                    throw error;
                }
            }

            async storeOutData(outEntries) {
                try {
                    console.log('Storing OUT data to GitHub Excel file...');
                    
                    if (!outEntries || outEntries.length === 0) {
                        throw new Error('No data to store');
                    }

                    // Fetch current Excel file
                    const excelData = await this.fetchExcelFile();
                    const workbook = XLSX.read(excelData, { type: 'array' });

                    // Get or create OUT sheet
                    let outSheet;
                    if (workbook.SheetNames.includes('OUT')) {
                        outSheet = workbook.Sheets['OUT'];
                        console.log('Found existing OUT sheet');
                    } else {
                        outSheet = XLSX.utils.json_to_sheet([]);
                        workbook.SheetNames.push('OUT');
                        workbook.Sheets['OUT'] = outSheet;
                        console.log('Created new OUT sheet');
                    }

                    // Convert existing data to JSON
                    const existingData = XLSX.utils.sheet_to_json(outSheet);
                    console.log(`Existing OUT data: ${existingData.length} records`);

                    // Add new entries
                    const updatedData = [...existingData, ...outEntries];
                    console.log(`Total data after update: ${updatedData.length} records`);

                    // Update sheet
                    const newOutSheet = XLSX.utils.json_to_sheet(updatedData);
                    workbook.Sheets['OUT'] = newOutSheet;

                    // Upload to GitHub
                    const commitMessage = `Update OUT data: ${outEntries.length} new entries added`;
                    await this.updateExcelFile(workbook, commitMessage);

                    console.log('Successfully stored OUT data to GitHub');
                    return true;

                } catch (error) {
                    console.error('Error storing OUT data:', error);
                    throw error;
                }
            }

            async loadOutData() {
                try {
                    console.log('Loading OUT data from GitHub...');
                    
                    const excelData = await this.fetchExcelFile();
                    const workbook = XLSX.read(excelData, { type: 'array' });

                    if (workbook.SheetNames.includes('OUT')) {
                        const outSheet = workbook.Sheets['OUT'];
                        const outData = XLSX.utils.sheet_to_json(outSheet);
                        console.log(`Loaded ${outData.length} OUT records from GitHub`);
                        return outData;
                    } else {
                        console.log('No OUT sheet found in GitHub Excel file');
                        return [];
                    }

                } catch (error) {
                    console.error('Error loading OUT data:', error);
                    throw error;
                }
            }

            async testConnection() {
                try {
                    const response = await this.makeAuthenticatedRequest(`${this.API_BASE}`);
                    const data = await response.json();
                    console.log('GitHub connection test successful:', data.full_name);
                    return true;
                } catch (error) {
                    console.error('GitHub connection test failed:', error);
                    throw error;
                }
            }

            getRateLimitInfo() {
                return {
                    remaining: this.rateLimitRemaining,
                    resetTime: new Date(this.rateLimitResetTime).toISOString()
                };
            }
        }

        // Enhanced Coil Data Management Application
        let coilData = [];
        let vehicleData = [];
        let outData = [];
        let loadedFileName = '';
        let addedCoils = [];
        let vehicleCoilMap = {};
        let html5QrCode;
        let serialCounter = 1;

        // Global instances
        window.permissionManager = new PermissionManager();
        window.githubAPI = new GitHubAPI();

        // Initialize app when device is ready
        document.addEventListener('deviceready', onDeviceReady, false);

        // Fallback for browser testing
        if (typeof cordova === 'undefined') {
            document.addEventListener('DOMContentLoaded', onDeviceReady);
        }

        async function onDeviceReady() {
            console.log('Device ready - initializing app');
            
            try {
                // Initialize permissions
                if (window.permissionManager) {
                    await window.permissionManager.initialize();
                }
                
                // Load initial data
                await autoLoadFromGithub();
                
                // Load OUT data for serial counter
                await loadOutDataForSerial();
                
                // Set up file input handler
                const fileInput = document.getElementById('excelFile');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }
                
                console.log('App initialization complete');
                
            } catch (error) {
                console.error('App initialization failed:', error);
                showMessage('App initialization failed: ' + error.message, 'error');
            }
        }

        // Auto-load Excel data from GitHub on startup
        async function autoLoadFromGithub() {
            try {
                console.log('Auto-loading data from GitHub...');
                showMessage('Loading data from GitHub...', 'info');
                
                const excelData = await window.githubAPI.fetchExcelFile();
                const workbook = XLSX.read(excelData, { type: 'array' });
                
                console.log('Available sheets:', workbook.SheetNames);
                
                // Load PNR sheet (coil data)
                if (workbook.SheetNames.includes('PNR')) {
                    const pnrSheet = workbook.Sheets['PNR'];
                    coilData = XLSX.utils.sheet_to_json(pnrSheet);
                    console.log('Loaded PNR data:', coilData.length, 'records');
                }
                
                // Load VEH sheet (vehicle data)
                if (workbook.SheetNames.includes('VEH')) {
                    const vehicleSheet = workbook.Sheets['VEH'];
                    vehicleData = XLSX.utils.sheet_to_json(vehicleSheet);
                    console.log('Loaded VEH data:', vehicleData.length, 'records');
                }
                
                loadedFileName = 'GitHub: coil-data.xlsx';
                const fileNameElement = document.getElementById('fileName');
                if (fileNameElement) {
                    fileNameElement.textContent = `Auto-loaded: ${loadedFileName}`;
                }
                
                showMessage('Data loaded successfully from GitHub', 'success');
                
            } catch (error) {
                console.error('Auto-load failed:', error);
                const fileNameElement = document.getElementById('fileName');
                if (fileNameElement) {
                    fileNameElement.textContent = 'Auto-load failed. Please upload Excel file manually.';
                }
                showMessage('Failed to load data from GitHub: ' + error.message, 'error');
            }
        }

        async function loadOutDataForSerial() {
            try {
                const githubOutData = await window.githubAPI.loadOutData();
                
                if (githubOutData.length > 0) {
                    const maxSerial = Math.max(...githubOutData.map(row => parseInt(row['SERIAL NO']) || 0));
                    serialCounter = maxSerial + 1;
                    console.log('Serial counter set from GitHub data:', serialCounter);
                }
                
            } catch (error) {
                console.log('Could not load OUT data for serial counter:', error);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    console.log('Manual file load - Available sheets:', workbook.SheetNames);
                    
                    // Load PNR sheet (coil data)
                    if (workbook.SheetNames.includes('PNR')) {
                        const pnrSheet = workbook.Sheets['PNR'];
                        coilData = XLSX.utils.sheet_to_json(pnrSheet);
                        console.log('Loaded PNR data:', coilData.length, 'records');
                    }
                    
                    // Load VEH sheet
                    if (workbook.SheetNames.includes('VEH')) {
                        const vehicleSheet = workbook.Sheets['VEH'];
                        vehicleData = XLSX.utils.sheet_to_json(vehicleSheet);
                        console.log('Loaded VEH data:', vehicleData.length, 'records');
                    }
                    
                    // Load OUT sheet for existing data and serial counter
                    if (workbook.SheetNames.includes('OUT')) {
                        const outSheet = workbook.Sheets['OUT'];
                        outData = XLSX.utils.sheet_to_json(outSheet);
                        
                        if (outData.length > 0) {
                            const maxSerial = Math.max(...outData.map(row => parseInt(row['SERIAL NO']) || 0));
                            serialCounter = maxSerial + 1;
                        }
                    }
                    
                    loadedFileName = file.name;
                    document.getElementById('fileName').textContent = `Loaded: ${loadedFileName}`;
                    showMessage('Excel file loaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showMessage('Error reading Excel file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function searchCoil() {
            const coilNumber = document.getElementById('coilInput').value.trim().toUpperCase();
            const resultDiv = document.getElementById('result');
            
            if (!coilNumber) {
                resultDiv.innerHTML = '';
                return;
            }
            
            if (coilData.length === 0) {
                resultDiv.innerHTML = '<p style="color: #ff6b6b;">No Excel data loaded. Please upload an Excel file first.</p>';
                return;
            }
            
            const matchKey = Object.keys(coilData[0] || {}).find(key => 
                key.trim().toUpperCase() === 'MILL COIL NO' || 
                key.trim().toUpperCase() === 'COIL NO' ||
                key.trim().toUpperCase().includes('MILL COIL')
            );
            
            if (!matchKey) {
                resultDiv.innerHTML = '<p style="color: #ff6b6b;">Could not find MILL COIL NO column in Excel data.</p>';
                return;
            }
            
            const coil = coilData.find(row => 
                String(row[matchKey]).trim().toUpperCase() === coilNumber
            );
            
            if (coil) {
                let html = '<table>';
                Object.entries(coil).forEach(([key, value]) => {
                    if (value !== null && value !== undefined && value !== '') {
                        html += `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`;
                    }
                });
                html += '</table>';
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = '<p style="color: #ff6b6b;">Coil not found in database.</p>';
            }
        }

        function showSuggestions() {
            const input = document.getElementById('coilInput').value.trim().toUpperCase();
            const suggestions = document.getElementById('suggestions');
            
            if (input.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const matches = coilData.filter(row => {
                const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
                return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
            }).slice(0, 10);
            
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(row => {
                    const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
                    return `<div onclick="selectSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
                }).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        function selectSuggestion(coilNumber) {
            document.getElementById('coilInput').value = coilNumber;
            document.getElementById('suggestions').style.display = 'none';
            searchCoil();
            toggleClearButton();
        }

        function toggleClearButton() {
            // This function exists for compatibility
        }

        async function startScanner() {
            try {
                // Check camera permission first
                if (window.permissionManager && !window.permissionManager.isCameraPermissionGranted()) {
                    const granted = await window.permissionManager.requestCameraPermission();
                    if (!granted) {
                        showMessage('Camera permission is required for QR code scanning', 'error');
                        return;
                    }
                }
                
                const reader = document.getElementById('reader');
                if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
                    return;
                }
                
                html5QrCode = new Html5Qrcode("reader");
                
                // Get camera constraints
                const cameraConstraints = { facingMode: "environment" };
                
                await html5QrCode.start(
                    cameraConstraints,
                    { 
                        fps: 10, 
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    (decodedText) => {
                        document.getElementById('coilInput').value = decodedText;
                        searchCoil();
                        toggleClearButton();
                        html5QrCode.stop().catch(err => console.error('Error stopping scanner:', err));
                        showMessage('QR code scanned successfully', 'success');
                    },
                    (errorMessage) => {
                        // Ignore scanning errors for cleaner console
                    }
                );
                
            } catch (error) {
                console.error('Error starting scanner:', error);
                showMessage('Error starting camera: ' + error.message, 'error');
            }
        }

        function closeScanner() {
            if (html5QrCode) {
                html5QrCode.stop().catch(err => console.error('Error stopping scanner:', err));
            }
        }

        // Vehicle functions
        function showVehicleSuggestions() {
            const input = document.getElementById('vehicleInput').value.trim().toUpperCase();
            const suggestions = document.getElementById('vehicleSuggestions');
            
            if (input.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const matches = vehicleData.filter(row => {
                const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
            }).slice(0, 10);
            
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(row => {
                    const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                    return `<div onclick="selectVehicleSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
                }).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        function selectVehicleSuggestion(vehicleNumber) {
            document.getElementById('vehicleInput').value = vehicleNumber;
            document.getElementById('vehicleSuggestions').style.display = 'none';
            toggleVehicleClearButton();
        }

        function toggleVehicleClearButton() {
            const input = document.getElementById('vehicleInput').value.trim();
            const clearBtn = document.getElementById('clearVehicleBtn');
            if (clearBtn) {
                clearBtn.style.display = input ? 'block' : 'none';
            }
        }

        function clearVehicleInput() {
            document.getElementById('vehicleInput').value = '';
            document.getElementById('vehicleSuggestions').style.display = 'none';
            toggleVehicleClearButton();
        }

        function addCoilToVehicle() {
            const vehicleInput = document.getElementById('vehicleInput');
            const coilInput = document.getElementById('coilInput');
            
            vehicleInput.disabled = true;
            
            const coil = coilInput.value.trim().toUpperCase();
            const vehicle = vehicleInput.value.trim().toUpperCase();
            
            if (!coil || !vehicle) {
                showMessage('Please enter both coil and vehicle number', 'error');
                vehicleInput.disabled = false;
                return;
            }
            
            // Check if coil is already saved in vehicleCoilMap
            let coilAlreadySaved = false;
            for (const [savedVehicle, savedCoils] of Object.entries(vehicleCoilMap)) {
                if (savedCoils.includes(coil)) {
                    showMessage(`⚠️ WARNING: Coil ${coil} is already saved for vehicle ${savedVehicle}`, 'error');
                    vehicleInput.disabled = false;
                    return;
                }
            }
            
            // Check if coil is already added in current session
            const coilAlreadyAdded = addedCoils.some(item => item.coilNumber === coil);
            if (coilAlreadyAdded) {
                showMessage(`⚠️ WARNING: Coil ${coil} is already added to the current list`, 'error');
                vehicleInput.disabled = false;
                return;
            }
            
            addedCoils.push({ coilNumber: coil, vehicleNumber: vehicle });
            updateAddedCoilsDisplay();
            
            coilInput.value = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            
            showMessage('Coil added to vehicle successfully', 'success');
        }

        function updateAddedCoilsDisplay() {
            const div = document.getElementById('addedCoils');
            if (addedCoils.length === 0) {
                div.innerHTML = '';
                return;
            }
            
            let html = '<h3>Added Coils:</h3>';
            addedCoils.forEach((item, index) => {
                html += `<div style="background: rgba(255,255,255,0.1); padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                  <span>${item.coilNumber} → ${item.vehicleNumber}</span>
                  <button onclick="removeCoil(${index})" style="padding: 2px 4px; font-size: 9px; background: #e74c3c; color: white; border: none; border-radius: 2px; cursor: pointer; min-width: 45px;">Remove</button>
                </div>`;
            });
            div.innerHTML = html;
        }

        function removeCoil(index) {
            addedCoils.splice(index, 1);
            updateAddedCoilsDisplay();
        }

        function saveVehicleCoils() {
            if (!addedCoils.length) {
                showMessage('No coils to save', 'error');
                return;
            }
            
            addedCoils.forEach(({ coilNumber, vehicleNumber }) => {
                if (!vehicleCoilMap[vehicleNumber]) vehicleCoilMap[vehicleNumber] = [];
                vehicleCoilMap[vehicleNumber].push(coilNumber);
            });
            
            addedCoils = [];
            updateAddedCoilsDisplay();
            
            // Clear vehicle input after saving
            const vehicleInput = document.getElementById('vehicleInput');
            if (vehicleInput) {
                vehicleInput.value = '';
                vehicleInput.disabled = false;
            }
            
            // Hide vehicle suggestions
            document.getElementById('vehicleSuggestions').style.display = 'none';
            
            // Update button states
            const generateBtn = document.getElementById('generateBtn');
            const addBtn = document.getElementById('addBtn');
            const saveBtn = document.getElementById('saveBtn');
            
            if (generateBtn) generateBtn.disabled = false;
            if (addBtn) addBtn.disabled = true;
            if (saveBtn) saveBtn.disabled = true;
            
            // Hide clear vehicle button
            toggleVehicleClearButton();
            
            showMessage('Vehicle coils saved successfully', 'success');
        }

        // Enhanced generateTextFile function with proper storage permissions and GitHub sync
        async function generateTextFile() {
            try {
                // Request storage permission first
                if (window.permissionManager && !window.permissionManager.areStoragePermissionsGranted()) {
                    const granted = await window.permissionManager.requestStoragePermission();
                    if (!granted) {
                        showMessage('Storage permission is required to save files', 'error');
                        return;
                    }
                }
                
                const vehicleInput = document.getElementById('vehicleInput');
                if (vehicleInput) {
                    vehicleInput.disabled = false;
                }
                
                const now = new Date();
                const currentDate = now.toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = now.toLocaleTimeString('en-US', { hour12: true });
                
                const outEntries = [];
                
                // Generate separate file for each vehicle
                for (const [vehicle, coils] of Object.entries(vehicleCoilMap)) {
                    // Find transporter for this vehicle
                    let transporter = '';
                    if (vehicleData.length > 0) {
                        const vehicleColumnKey = Object.keys(vehicleData[0]).find(key => 
                            key.trim().toUpperCase().includes('VEHICLE NO')
                        );
                        
                        const transporterColumnKey = Object.keys(vehicleData[0]).find(key => 
                            key.trim().toUpperCase().includes('TRANSPORTER')
                        );
                        
                        if (vehicleColumnKey && transporterColumnKey) {
                            const vehicleRecord = vehicleData.find(row => 
                                String(row[vehicleColumnKey]).trim().toUpperCase() === vehicle
                            );
                            if (vehicleRecord) {
                                transporter = vehicleRecord[transporterColumnKey] || '';
                            }
                        }
                    }
                    
                    // Calculate total gross weight and prepare coil details
                    let totalGrossWeight = 0;
                    const coilDetails = [];
                    
                    coils.forEach(coil => {
                        // Find coil details to get gross weight
                        const details = findCoilDetails(coil);
                        let grossWeight = '';
                        
                        if (details) {
                            // Look for gross weight column
                            const grossWeightKey = Object.keys(details).find(key => 
                                key.trim().toUpperCase().includes('GROSS') && 
                                key.trim().toUpperCase().includes('WT')
                            );
                            if (grossWeightKey) {
                                grossWeight = details[grossWeightKey] || '';
                            }
                        }
                        
                        coilDetails.push({
                            coilNo: coil,
                            grossWeight: grossWeight
                        });
                        
                        totalGrossWeight += parseFloat(grossWeight) || 0;
                        
                        const outEntry = {
                            'SERIAL NO': serialCounter++,
                            'DATE & TIME': `${currentDate} ${currentTime}`,
                            'VEHICLE NO': vehicle,
                            'MILL COIL NO': coil,
                            'TRANSPORTER': transporter || 'MPT',
                            'GROSS WT': grossWeight
                        };
                        outEntries.push(outEntry);
                    });
                    
                    // Generate content in exact format from screenshot
                    let content = 'A.S.Shipping Agencies Pvt Ltd,\n';
                    content += '(Greenways Group)\n';
                    content += '--------------------------------------------\n';
                    content += `Vehicle: ${vehicle} | Transporter: ${transporter || 'MPT'}\n`;
                    content += `Generated On: ${currentDate} ${currentTime}\n`;
                    content += '--------------------------------------------\n';
                    
                    // Add coil details
                    coilDetails.forEach(coil => {
                        content += `Coil No: ${coil.coilNo}, Gross WT: ${coil.grossWeight}\n`;
                    });
                    
                    // Add totals
                    content += '\n';
                    content += `Total No of Coils : ${coils.length}\n`;
                    content += `Total Gross WT : ${totalGrossWeight.toFixed(2)}\n`;
                    content += '--------------------------------------------\n';
                    
                    // Save text file
                    await saveTextFile(content, `${vehicle}_${currentDate}.txt`);
                }
                
                // Store all data in GitHub Excel OUT sheet
                if (outEntries.length > 0) {
                    try {
                        // Store in local outData array first
                        if (!outData) outData = [];
                        outData = [...outData, ...outEntries];
                        
                        // Try GitHub sync but don't block on failure
                        try {
                            showMessage('Saving data to GitHub...', 'info');
                            await window.githubAPI.storeOutData(outEntries);
                            showMessage('Data successfully saved to GitHub Excel file', 'success');
                        } catch (error) {
                            console.error('Failed to save to GitHub:', error);
                            // Don't show error message to user - just continue with local data
                        }
                    } catch (error) {
                        console.error('Error handling outData:', error);
                        // Don't block the process
                    }
                }
                
                // Reset for next operation
                vehicleCoilMap = {};
                const generateBtn = document.getElementById('generateBtn');
                const addBtn = document.getElementById('addBtn');
                const saveBtn = document.getElementById('saveBtn');
                
                if (generateBtn) generateBtn.disabled = true;
                if (addBtn) addBtn.disabled = false;
                if (saveBtn) saveBtn.disabled = false;
                
                showMessage('Text files generated and data saved successfully', 'success');
                
            } catch (error) {
                console.error('Error generating text file:', error);
                showMessage('Error generating text file: ' + error.message, 'error');
            }
        }

        async function saveTextFile(content, fileName) {
            try {
                // Create blob and download
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log(`Text file ${fileName} saved successfully`);
            } catch (error) {
                console.error('Error saving text file:', error);
                throw error;
            }
        }

        function findCoilDetails(coilNumber) {
            if (coilData.length === 0) return null;
            
            const matchKey = Object.keys(coilData[0]).find(key => 
                key.trim().toUpperCase() === 'MILL COIL NO' || 
                key.trim().toUpperCase() === 'COIL NO' ||
                key.trim().toUpperCase().includes('MILL COIL')
            );
            
            if (!matchKey) return null;
            
            return coilData.find(row => 
                String(row[matchKey]).trim().toUpperCase() === coilNumber.trim().toUpperCase()
            );
        }

        function showReportVehicleSuggestions() {
            const input = document.getElementById('reportVehicleInput').value.trim().toUpperCase();
            const suggestions = document.getElementById('reportVehicleSuggestions');
            
            if (input.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const matches = vehicleData.filter(row => {
                const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
            }).slice(0, 10);
            
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(row => {
                    const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                    return `<div onclick="selectReportVehicleSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
                }).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        function selectReportVehicleSuggestion(vehicleNumber) {
            document.getElementById('reportVehicleInput').value = vehicleNumber;
            document.getElementById('reportVehicleSuggestions').style.display = 'none';
            toggleReportVehicleClearButton();
        }

        function toggleReportVehicleClearButton() {
            const input = document.getElementById('reportVehicleInput').value.trim();
            const clearBtn = document.getElementById('clearReportVehicleBtn');
            if (clearBtn) {
                clearBtn.style.display = input ? 'block' : 'none';
            }
        }

        function clearReportVehicleInput() {
            document.getElementById('reportVehicleInput').value = '';
            document.getElementById('reportVehicleSuggestions').style.display = 'none';
            toggleReportVehicleClearButton();
        }

        async function generateAllOutDataReport() {
            try {
                showMessage('Generating all OUT data report...', 'info');
                
                // Use local outData if available, otherwise try to get from GitHub
                let reportData = outData || [];
                
                if (reportData.length === 0) {
                    try {
                        reportData = await window.githubAPI.loadOutData();
                    } catch (error) {
                        console.error('Error loading GitHub OUT data:', error);
                        // Continue with empty data if both local and GitHub fail
                    }
                }
                
                if (reportData.length === 0) {
                    showMessage('⚠️ WARNING: No OUT data found to generate report', 'error');
                    return;
                }
                
                // Generate text format report
                const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = new Date().toLocaleTimeString('en-US', { hour12: true });
                
                let content = 'A.S.Shipping Agencies Pvt Ltd,\n';
                content += '(Greenways Group)\n\n';
                content += 'ALL OUT DATA REPORT\n';
                content += `Generated on: ${currentDate} ${currentTime}\n`;
                content += '===============================\n\n';
                
                // Headers with proper spacing
                content += 'Serial No    Date & Time           Transporter    Vehicle No      Coil No      Gross WT\n';
                content += '=========    ===========           ===========    ==========      =======      ========\n';
                
                // Data rows with proper alignment
                reportData.forEach(row => {
                    const serialNo = String(row['SERIAL NO'] || '').padEnd(12);
                    const dateTime = String(row['DATE & TIME'] || '').padEnd(21);
                    const transporter = String(row['TRANSPORTER'] || '').padEnd(14);
                    const vehicleNo = String(row['VEHICLE NO'] || '').padEnd(15);
                    const coilNo = String(row['MILL COIL NO'] || '').padEnd(12);
                    const grossWT = String(row['GROSS WT'] || '');
                    
                    content += `${serialNo} ${dateTime} ${transporter} ${vehicleNo} ${coilNo} ${grossWT}\n`;
                });
                
                // Summary section
                content += '\nSUMMARY FOR ALL VEHICLES\n';
                content += '===============================\n';
                content += `Total Records: ${reportData.length}\n`;
                content += `Total Coils: ${reportData.length}\n`;
                
                // Calculate total gross weight
                const totalGrossWT = reportData.reduce((sum, row) => {
                    return sum + (parseFloat(row['GROSS WT']) || 0);
                }, 0);
                content += `Total Gross WT: ${totalGrossWT.toFixed(2)}\n`;
                
                // Save as text file
                await saveTextFile(content, `All_OUT_Data_Report_${currentDate}.txt`);
                
                showMessage('All OUT data report generated successfully', 'success');
                
            } catch (error) {
                console.error('Error generating all OUT data report:', error);
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        async function generateVehicleOutReport() {
            try {
                const vehicleNumber = document.getElementById('reportVehicleInput').value.trim().toUpperCase();
                
                if (!vehicleNumber) {
                    showMessage('Please enter a vehicle number', 'error');
                    return;
                }
                
                showMessage('Generating vehicle OUT report...', 'info');
                
                // Use local outData if available, otherwise try to get from GitHub
                let allOutData = outData || [];
                
                if (allOutData.length === 0) {
                    try {
                        allOutData = await window.githubAPI.loadOutData();
                    } catch (error) {
                        console.error('Error loading GitHub OUT data:', error);
                        // Continue with empty data if both local and GitHub fail
                    }
                }
                
                const vehicleOutData = allOutData.filter(row => 
                    String(row['VEHICLE NO']).trim().toUpperCase() === vehicleNumber
                );
                
                if (vehicleOutData.length === 0) {
                    showMessage(`⚠️ WARNING: No OUT data found for vehicle ${vehicleNumber}`, 'error');
                    return;
                }
                
                // Generate text format report
                const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = new Date().toLocaleTimeString('en-US', { hour12: true });
                
                let content = 'A.S.Shipping Agencies Pvt Ltd,\n';
                content += '(Greenways Group)\n\n';
                content += `VEHICLE OUT DATA REPORT - ${vehicleNumber}\n`;
                content += `Generated on: ${currentDate} ${currentTime}\n`;
                content += '===============================\n\n';
                
                // Headers with proper spacing
                content += 'Serial No    Date & Time           Transporter    Vehicle No      Coil No      Gross WT\n';
                content += '=========    ===========           ===========    ==========      =======      ========\n';
                
                // Data rows with proper alignment
                vehicleOutData.forEach(row => {
                    const serialNo = String(row['SERIAL NO'] || '').padEnd(12);
                    const dateTime = String(row['DATE & TIME'] || '').padEnd(21);
                    const transporter = String(row['TRANSPORTER'] || '').padEnd(14);
                    const vehicleNo = String(row['VEHICLE NO'] || '').padEnd(15);
                    const coilNo = String(row['MILL COIL NO'] || '').padEnd(12);
                    const grossWT = String(row['GROSS WT'] || '');
                    
                    content += `${serialNo} ${dateTime} ${transporter} ${vehicleNo} ${coilNo} ${grossWT}\n`;
                });
                
                // Summary section
                content += `\nSUMMARY FOR VEHICLE ${vehicleNumber}\n`;
                content += '===============================\n';
                content += `Total Records: ${vehicleOutData.length}\n`;
                content += `Total Coils: ${vehicleOutData.length}\n`;
                
                // Calculate total gross weight
                const totalGrossWT = vehicleOutData.reduce((sum, row) => {
                    return sum + (parseFloat(row['GROSS WT']) || 0);
                }, 0);
                content += `Total Gross WT: ${totalGrossWT.toFixed(2)}\n`;
                
                // Save as text file
                await saveTextFile(content, `Vehicle_${vehicleNumber}_OUT_Report_${currentDate}.txt`);
                
                showMessage(`Vehicle ${vehicleNumber} OUT report generated successfully`, 'success');
                
            } catch (error) {
                console.error('Error generating vehicle OUT report:', error);
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        async function uploadExcel() {
            try {
                const fileInput = document.getElementById('excelFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showMessage('⚠️ WARNING: Please select an Excel file to upload', 'error');
                    return;
                }
                
                showMessage('Uploading Excel file to GitHub...', 'info');
                
                // Read the file as array buffer
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Convert to base64 for GitHub API
                const base64String = btoa(String.fromCharCode(...uint8Array));
                
                // Upload to GitHub
                const result = await window.githubAPI.uploadExcelFile(base64String, file.name);
                
                if (result.success) {
                    showMessage(`Excel file "${file.name}" uploaded to GitHub successfully`, 'success');
                    
                    // Clear the file input
                    fileInput.value = '';
                    document.getElementById('fileName').textContent = '';
                    
                    // Optionally refresh the coil data from the uploaded file
                    await loadCoilDataFromFile();
                } else {
                    showMessage(`Error uploading Excel file: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error uploading Excel file:', error);
                showMessage('Error uploading Excel file: ' + error.message, 'error');
            }
        }

        function clearInputs() {
            document.getElementById('coilInput').value = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            toggleClearButton();
        }

        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear all local storage data?')) {
                localStorage.clear();
                showMessage('Local storage cleared', 'success');
            }
        }

        function resetApp() {
            if (confirm('Are you sure you want to reset the app? This will clear all data and reload the page.')) {
                localStorage.clear();
                location.reload();
            }
        }

        function setGithubToken() {
            const token = prompt('Enter your GitHub Personal Access Token:');
            if (token) {
                window.githubAPI.setToken(token);
                showMessage('GitHub token set successfully', 'success');
            }
        }

        async function updateAppFromGithub() {
            try {
                showMessage('Checking for app updates...', 'info');
                
                const response = await fetch('https://raw.githubusercontent.com/gmanand23/Coil_Info/main/index.html?' + new Date().getTime());
                if (response.ok) {
                    const newContent = await response.text();
                    
                    if (confirm('App update available. Update now? This will reload the page.')) {
                        document.open();
                        document.write(newContent);
                        document.close();
                    }
                } else {
                    showMessage('No updates available', 'info');
                }
                
            } catch (error) {
                console.error('Error checking for updates:', error);
                showMessage('Error checking for updates: ' + error.message, 'error');
            }
        }

        function showMessage(text, type = 'info') {
            if (window.permissionManager) {
                window.permissionManager.showMessage(text, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${text}`);
            }
        }

        // Initialize when permissions are ready
        document.addEventListener('deviceready', async () => {
            console.log('Device ready - initializing permissions');
            await window.permissionManager.initialize();
        }, false);

        // Fallback for browser testing
        if (typeof cordova === 'undefined') {
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('Browser mode - initializing permissions');
                await window.permissionManager.initialize();
            });
        }
    </script>
</body>
</html>