<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Coil Data Checker</title>
    
    <!--
    GOOGLE APPS SCRIPT CODE - Copy and paste this into Google Apps Script Editor:
    
    function doGet(e) {
      return handleRequest(e);
    }

    function doPost(e) {
      return handleRequest(e);
    }

    function handleRequest(e) {
      try {
        // Get the spreadsheet by ID directly - REPLACE WITH YOUR SPREADSHEET ID
        const spreadsheetId = '18VjUGZ-dGFMEq1oIlxIssRlwkfcPZZJfH6GD7UdgOyc';
        const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
        let data, sheetName;
        let isPixelRequest = false;
        
        // Handle POST request (form data)
        if (e.postData && e.postData.contents) {
          const formData = e.parameter;
          if (formData.payload) {
            const payload = JSON.parse(formData.payload);
            data = payload.records;
            sheetName = payload.sheetName || 'OUT';
          }
        }
        // Handle GET request (URL parameters)
        else if (e.parameter) {
          sheetName = e.parameter.sheetName || 'OUT';
          isPixelRequest = e.parameter.pixel === '1';
          
          if (e.parameter.data) {
            data = JSON.parse(e.parameter.data);
          }
        }
        
        if (data && data.length > 0) {
          const sheet = spreadsheet.getSheetByName(sheetName);
          if (!sheet) {
            // For pixel requests, still return an image even on error
            if (isPixelRequest) {
              return createPixelResponse();
            }
            return ContentService.createTextOutput(JSON.stringify({
              success: false,
              error: "Sheet '" + sheetName + "' not found"
            })).setMimeType(ContentService.MimeType.JSON);
          }
          
          // Add data to sheet
          data.forEach(record => {
            const values = Object.values(record);
            sheet.appendRow(values);
          });
          
          // For pixel tracking requests, return a 1x1 transparent image
          if (isPixelRequest) {
            return createPixelResponse();
          }
          
          // For regular requests, return JSON response
          return ContentService.createTextOutput(JSON.stringify({
            success: true,
            recordsAdded: data.length,
            message: "Data successfully added to " + sheetName
          })).setMimeType(ContentService.MimeType.JSON);
        }
        
        // For pixel requests without data, still return pixel
        if (isPixelRequest) {
          return createPixelResponse();
        }
        
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: "No data provided"
        })).setMimeType(ContentService.MimeType.JSON);
        
      } catch (error) {
        // For pixel requests, return pixel even on error
        if (e.parameter && e.parameter.pixel === '1') {
          return createPixelResponse();
        }
        
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: error.toString()
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }

    // Function to create a 1x1 transparent pixel response
    function createPixelResponse() {
      // 1x1 transparent PNG pixel in base64
      const transparentPixel = Utilities.base64Decode('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAI9A0N7wAAAABJRU5ErkJggg==');
      
      return Utilities.newBlob(transparentPixel, 'image/png', 'pixel.png')
               .setResponseCode(200);
    }
    
    END OF GOOGLE APPS SCRIPT CODE
    -->
    
    <meta http-equiv="Cache-Control" content="no-store">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: gap: blob: https:; connect-src 'self' https: wss: ws:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; img-src 'self' data: https: blob:; media-src 'self' https: blob:;">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest - Inline -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICAgIm5hbWUiOiAiQ29pbCBEYXRhIENoZWNrZXIiLAogICAgInNob3J0X25hbWUiOiAiQ29pbENoZWNrZXIiLAogICAgImRlc2NyaXB0aW9uIjogIkEuUyBTaGlwcGluZyBBZ2VuY2llcyBDb2lsIERhdGEgTWFuYWdlbWVudCBTeXN0ZW0iLAogICAgInZlcnNpb24iOiAiNC4xIiwKICAgICJzdGFydF91cmwiOiAiLiIsCiAgICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAgICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMyYzNlNTAiLAogICAgInRoZW1lX2NvbG9yIjogIiMyYzNlNTAiLAogICAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAgICJpY29ucyI6IFsKICAgICAgICB7CiAgICAgICAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0k1TWlJZ2FHVnBaMmgwUFNJNU1pSWdkbWxsZDBKdmVEMGlNQ0F3SURreUlEa3lJajQ4Y21WamRDQjNhV1IwYUQwaU9USWlJR2hsYVdkb2REMGlPVElpSUdacGJHdzlJaU5qTXpWbE5UQWlMejQ4ZEdWNGRDQjRQU0kyTnlJZ2VUMWRPVFFLU0hSMGNEb3ZMMjF2WjNCYWMybGtRbVprZG1GMmVWczdaRGxsUWpSNGNrdDNUMVl6YW1GNVp6ZzZaSGt3TmlkcVNqVXdTbkozWWxScWVIVWtKeFZIU0hJMU1sOGdRekJGTXpacExqVkVUWGd4UzJKdlQxaGJZa3N1ZERKblFubGJSMlJwTWxVelRrczVhMGsxVGpKZGFETnRaa05STFVGek5IcE9VblJoWW1rd1dYTkJRMkpOVUc5emN6VnFhMUZXZGt4dk1ITjBiVkJUU2xkeVJEWTNhakF6Y1V3dGIzY3djblYwVDBOWmNTMXdXVWM5ZEMwdVZrdExaelZsWkZoUE0ybGFWakEwZFU1NmMwRk9ZVlJoWTNKb1kyeGhjMTFCYWtsc1NVUmxVM1F5VVE4aWF6cDBhR04wTDN4QkptZGlZem8xZGlKNGJtNTZVUzN0VkdOMGQyWXhTR3NTZFMsRUY3anFvdG1sOW1nZkFhRGcyeVNKQkJCZ0hPdFlKamJmbUdIYWZpb1ptdHVlbEdnQUIzaklNOT0iLAogICAgICAgICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICAgICAgfQogICAgXSwKICAgICJjYXRlZ29yaWVzIjogWyJidXNpbmVzcyIsICJwcm9kdWN0aXZpdHkiXSwKICAgICJzaG9ydGN1dHMiOiBbCiAgICAgICAgewogICAgICAgICAgICAibmFtZSI6ICJTYW4gUVIgQ29kZSIsCiAgICAgICAgICAgICJzaG9ydF9uYW1lIjogIlNjYW4iLAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUXVpY2sgUVIgY29kZSBzY2FubmluZyIsCiAgICAgICAgICAgICJ1cmwiOiAiLz9hY3Rpb249c2NhbiIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgIm5hbWUiOiAiVXBsb2FkIERhdGEiLAogICAgICAgICAgICAic2hvcnRfbmFtZSI6ICJVcGxvYWQiLAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVXBsb2FkIEV4Y2VsIGZpbGUiLAogICAgICAgICAgICAidXJsIjogIi8/YWN0aW9uPXVwbG9hZCIKICAgICAgICB9CiAgICBdCn0=">
    <meta name="theme-color" content="#2c3e50">
    
    <!-- Additional PWA Meta Tags -->
    <meta name="apple-mobile-web-app-title" content="Coil Data Checker">
    <meta name="application-name" content="Coil Data Checker">
    <meta name="msapplication-TileColor" content="#2c3e50">
    <meta name="apple-touch-fullscreen" content="yes">
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Neue', cursive, sans-serif;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 8px;
            overflow-x: hidden;
        }

        .header-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: bold;
            color: #00ff66;
            text-shadow: 1px 1px 3px #000;
            margin: 0;
            line-height: 1.3;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shipment-summary {
            background: rgba(0, 255, 102, 0.1);
            border: 1px solid rgba(0, 255, 102, 0.3);
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .shipment-summary h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #00ff66;
            text-shadow: 1px 1px 3px #000;
        }

        .summary-stats {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
        }

        .summary-stats span {
            white-space: nowrap;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .half-width {
            flex: 1;
            margin: 0 !important;
        }

        .third-width {
            flex: 1;
            margin: 0 !important;
        }

        .coil-details-display {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            min-height: 60px;
            margin-top: 10px;
        }

        /* Mobile-optimized input styling */
        input, button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }

        input[type="text"], input[type="file"] {
            background: #ecf0f1;
            color: #2c3e50;
            font-family: 'Comic Neue', cursive, sans-serif;
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #00ff66;
        }

        button {
            background-color: #1abc9c;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Comic Neue', cursive, sans-serif;
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
            background-color: #16a085;
        }

        button.clear-button {
            background-color: #e74c3c;
        }

        button.clear-button:active {
            background-color: #c0392b;
        }

        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Section headers */
        h2 {
            font-size: 18px;
            margin: 0 0 15px 0;
            text-align: left;
            color: #fff;
            font-weight: bold;
        }

        /* Suggestion dropdowns */
        #suggestions, #vehicleSuggestions, #reportVehicleSuggestions, #coilSerialSuggestions {
            background: white;
            color: #2c3e50;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 30px);
            z-index: 10;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #ddd;
        }

        #suggestions div, #vehicleSuggestions div, #reportVehicleSuggestions div, #coilSerialSuggestions div {
            padding: 14px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            font-family: 'Comic Neue', cursive, sans-serif;
        }

        #suggestions div:hover, #vehicleSuggestions div:hover, #reportVehicleSuggestions div:hover, #coilSerialSuggestions div:hover {
            background-color: #f8f9fa;
        }

        #suggestions div:last-child, #vehicleSuggestions div:last-child, #reportVehicleSuggestions div:last-child, #coilSerialSuggestions div:last-child {
            border-bottom: none;
        }

        #result table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #result table td {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            word-wrap: break-word;
            vertical-align: top;
        }

        #result table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* QR Code Scanner */
        #reader {
            width: 100%;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            min-height: 50px;
        }

        .input-container {
            position: relative;
        }

        /* File name display */
        #fileName {
            color: #ecf0f1;
            font-size: 14px;
            margin: 5px 0;
            text-align: center;
            word-wrap: break-word;
        }

        /* Added coils display */
        #addedCoils {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            min-height: 20px;
        }

        #addedCoils h3 {
            margin: 0 0 10px 0;
            color: #00ff66;
            font-size: 16px;
        }

        /* Touch-friendly file input */
        input[type="file"] {
            background: rgba(255, 255, 255, 0.9);
            border: 2px dashed #3498db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            padding: 20px;
        }

        input[type="file"]::-webkit-file-upload-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px 5px;
            }
            
            .header-title h1 {
                font-size: 20px;
            }
            
            .container {
                padding: 12px;
            }
            
            input, button {
                font-size: 16px;
                padding: 12px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            #suggestions, #vehicleSuggestions, #reportVehicleSuggestions, #coilSerialSuggestions {
                font-size: 14px;
            }
            
            #suggestions div, #vehicleSuggestions div, #reportVehicleSuggestions div, #coilSerialSuggestions div {
                padding: 12px;
            }
        }

        /* Very small screens */
        @media (max-width: 320px) {
            .header-title h1 {
                font-size: 18px;
            }
            
            input, button {
                font-size: 14px;
                padding: 10px;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Prevent zoom on iOS */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }

        /* Permission request overlay */
        .permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .permission-dialog {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #2c3e50;
            max-width: 300px;
            margin: 20px;
        }

        .permission-dialog h3 {
            margin-top: 0;
            color: #e74c3c;
        }

        .permission-dialog button {
            margin: 5px;
            padding: 10px 20px;
            width: auto;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error messages */
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* APK Report Modal - Added for APK compatibility */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .report-modal.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .report-modal-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .report-modal-share, .report-modal-print, .report-modal-pdf, .report-modal-close {
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
            margin: 0;
            font-size: 14px;
            font-family: 'Comic Neue', cursive, sans-serif;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .report-modal-share {
            background: #3498db;
            color: white;
        }

        .report-modal-share:active {
            background: #2980b9;
        }

        .report-modal-print {
            background: #9b59b6;
            color: white;
        }

        .report-modal-print:active {
            background: #8e44ad;
        }

        .report-modal-pdf {
            background: #f39c12;
            color: white;
        }

        .report-modal-pdf:active {
            background: #e67e22;
        }

        .report-modal-close {
            background: #e74c3c;
            color: white;
        }

        .report-modal-close:active {
            background: #c0392b;
        }

        .report-modal-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: white;
            color: #2c3e50;
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
            max-height: 80vh;
            overflow-x: auto;
        }
        
        .report-modal-content.text-content {
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .report-modal-content table {
            width: 100%;
            min-width: 800px;
            table-layout: auto;
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .report-modal-content,
            .report-modal-content * {
                visibility: visible;
            }
            
            .report-modal {
                position: static !important;
                background: white !important;
                display: block !important;
            }
            
            .report-modal-header {
                display: none !important;
            }
            
            .report-modal-content {
                position: static !important;
                max-height: none !important;
                overflow: visible !important;
                background: white !important;
                color: black !important;
                padding: 0 !important;
                font-size: 12px !important;
                line-height: 1.4 !important;
            }
            
            .report-modal-content table {
                min-width: auto !important;
                width: 100% !important;
                page-break-inside: avoid;
            }
            
            .report-modal-content table th,
            .report-modal-content table td {
                border: 1px solid #000 !important;
                padding: 4px !important;
                font-size: 10px !important;
            }
        }

        /* Mobile responsive adjustments for report buttons */
        @media (max-width: 480px) {
            .report-modal-buttons {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .report-modal-share, .report-modal-print, .report-modal-pdf, .report-modal-close {
                font-size: 12px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header-title">
        <h1>A.S.Shipping Agencies Pvt Ltd,<br>(Greenways Group) - V: 4.1</h1>
    </div>

    <div class="container">
        <!-- Shipment Summary Section -->
        <div class="shipment-summary" id="shipmentSummary" style="display: none;">
            <h3>Shipment Summary:</h3>
            <div class="summary-stats">
                <span id="totalVehicles">Vehicles Used: 0</span> | 
                <span id="totalCoils">Loaded Coils: 0</span> | 
                <span id="balanceCoils">Balance Coils: 0</span> | 
                <span id="usedTransporter">Used Transporter: 0</span>
            </div>
        </div>

        <!-- Coil Details Section -->
        <div class="section">
            <h2>Coil Details</h2>
            <div id="result" class="coil-details-display"></div>
        </div>

        <!-- Coil Processing Section -->
        <div class="section">
            <h2>Coil Processing</h2>
            <div class="input-container">
                <input type="text" id="coilInput" placeholder="Enter Coil Number" oninput="showSuggestions(); toggleClearButton();" autocomplete="off" />
                <div id="suggestions"></div>
            </div>
            <div class="input-container">
                <input type="text" id="vehicleInput" placeholder="Enter Vehicle Number" oninput="showVehicleSuggestions(); toggleVehicleClearButton();" autocomplete="off" />
                <div id="vehicleSuggestions"></div>
            </div>
            
            <div class="button-row">
                <button class="third-width" onclick="startScanner()">Scan QR</button>
                <button class="third-width" id="addBtn" onclick="addCoilToVehicle()">Add Coil</button>
                <button class="third-width clear-button" onclick="clearInputs()">Clear</button>
            </div>
            
            <div class="button-row">
                <button class="third-width" id="saveBtn" onclick="saveVehicleCoils()">Save</button>
                <button class="third-width" id="generateBtn" onclick="generateTextFile()" disabled>Generate Text</button>
                <button class="third-width clear-button" id="clearVehicleBtn" onclick="clearVehicleInput()" style="display: none;">Clear Vehicle</button>
            </div>
            
            <div id="reader" ondblclick="closeScanner()"></div>
            <div id="addedCoils"></div>
        </div>

        <!-- Generate Reports Section -->
        <div class="section">
            <h2>Generate Reports</h2>
            <div class="input-container">
                <input type="text" id="reportVehicleInput" placeholder="Enter Vehicle Number for Report" oninput="showReportVehicleSuggestions(); toggleReportVehicleClearButton(); showCoilSerialSuggestions();" autocomplete="off" />
                <div id="reportVehicleSuggestions"></div>
            </div>
            <div class="input-container">
                <input type="text" id="coilSerialInput" placeholder="Enter Coil Serial No (Optional)" oninput="showCoilSerialSuggestions();" onfocus="showCoilSerialSuggestions();" autocomplete="off" />
                <div id="coilSerialSuggestions"></div>
            </div>
            <div class="button-row">
                <button type="button" class="half-width" onclick="generateAllOutDataReport(event); return false;">All OUT Data Report</button>
                <button type="button" class="half-width" onclick="event.preventDefault(); generateVehicleOutReport(); return false;">Generate Vehicle Report</button>
            </div>

            <button id="clearReportVehicleBtn" class="clear-button" onclick="clearReportVehicleInput()" style="display: none;">Clear Report Vehicle</button>
        </div>

        <!-- Google Sheets Management Section -->
        <div class="section">
            <h2>Google Sheets Management</h2>
            <p style="color: #ecf0f1; font-size: 12px; margin: 5px 0;">⚠️ To save data to Google Sheets: Deploy the provided Google Apps Script and paste the Web App URL below</p>
            <input type="text" id="spreadsheetId" placeholder="Google Sheets ID or URL" value="https://docs.google.com/spreadsheets/d/18VjUGZ-dGFMEq1oIlxIssRlwkfcPZZJfH6GD7UdgOyc/edit?usp=sharing" />
            <input type="text" id="apiKey" placeholder="Google API Key (for reading data)" />
            <input type="text" id="webAppUrl" placeholder="Google Apps Script Web App URL (for writing data)" value="https://script.google.com/macros/s/AKfycbzFXySLV_DPrZgD8kGzY3ct-isjw6fsNe7QsXBFt6U/dev" />
            <div class="button-row">
                <button class="half-width" onclick="loadDataFromGoogleSheets()" style="background-color: #27ae60;" id="loadSheetsBtn">Load Data</button>
                <button class="half-width" onclick="resetApp()">Reset App</button>
            </div>
            <p id="fileName"></p>
        </div>
    </div>

    <!-- APK Report Modal - Added for APK compatibility -->
    <div class="report-modal" id="reportModal">
        <div class="report-modal-header">
            <h3 id="reportModalTitle">Report Viewer</h3>
            <div class="report-modal-buttons">
                <button class="report-modal-share" onclick="shareReport()">Share</button>
                <button class="report-modal-print" onclick="printReport()">Print</button>
                <button class="report-modal-pdf" onclick="downloadReportAsPDF()">PDF</button>
                <button class="report-modal-close" onclick="closeReportModal()">Close</button>
            </div>
        </div>
        <div class="report-modal-content" id="reportModalContent">
            <!-- Report content will be displayed here -->
        </div>
    </div>

    <script>
        // Permission handling for Cordova app
        class PermissionManager {
            constructor() {
                this.requiredPermissions = [
                    'android.permission.CAMERA',
                    'android.permission.WRITE_EXTERNAL_STORAGE',
                    'android.permission.READ_EXTERNAL_STORAGE'
                ];
                this.permissionStatus = {};
            }

            async initialize() {
                if (typeof cordova === 'undefined') {
                    console.log('Cordova not available - running in browser mode');
                    return true;
                }

                try {
                    await this.checkAllPermissions();
                    return true;
                } catch (error) {
                    console.error('Permission initialization failed:', error);
                    return false;
                }
            }

            async checkAllPermissions() {
                if (!window.cordova || !cordova.plugins.permissions) {
                    console.log('Permissions plugin not available');
                    return;
                }

                for (const permission of this.requiredPermissions) {
                    try {
                        const result = await this.checkPermission(permission);
                        this.permissionStatus[permission] = result;
                        console.log(`Permission ${permission}: ${result ? 'granted' : 'denied'}`);
                    } catch (error) {
                        console.error(`Error checking permission ${permission}:`, error);
                        this.permissionStatus[permission] = false;
                    }
                }
            }

            checkPermission(permission) {
                return new Promise((resolve) => {
                    if (!window.cordova || !cordova.plugins.permissions) {
                        resolve(true); // Assume granted if plugin not available
                        return;
                    }

                    cordova.plugins.permissions.checkPermission(permission, (result) => {
                        resolve(result.hasPermission);
                    }, (error) => {
                        console.error('Permission check error:', error);
                        resolve(false);
                    });
                });
            }

            requestPermission(permission) {
                return new Promise((resolve) => {
                    if (!window.cordova || !cordova.plugins.permissions) {
                        resolve(true);
                        return;
                    }

                    cordova.plugins.permissions.requestPermission(permission, (result) => {
                        const granted = result.hasPermission;
                        this.permissionStatus[permission] = granted;
                        resolve(granted);
                    }, (error) => {
                        console.error('Permission request error:', error);
                        resolve(false);
                    });
                });
            }

            async requestCameraPermission() {
                const permission = 'android.permission.CAMERA';
                
                if (this.permissionStatus[permission]) {
                    return true;
                }

                try {
                    const granted = await this.requestPermission(permission);
                    if (granted) {
                        this.showMessage('Camera permission granted', 'success');
                        return true;
                    } else {
                        this.showPermissionDialog('Camera', 'This app needs camera access to scan QR codes.');
                        return false;
                    }
                } catch (error) {
                    console.error('Camera permission request failed:', error);
                    this.showMessage('Camera permission request failed', 'error');
                    return false;
                }
            }

            async requestStoragePermission() {
                const permissions = [
                    'android.permission.WRITE_EXTERNAL_STORAGE',
                    'android.permission.READ_EXTERNAL_STORAGE'
                ];

                let allGranted = true;
                for (const permission of permissions) {
                    if (!this.permissionStatus[permission]) {
                        try {
                            const granted = await this.requestPermission(permission);
                            if (!granted) {
                                allGranted = false;
                                break;
                            }
                        } catch (error) {
                            console.error(`Storage permission request failed for ${permission}:`, error);
                            allGranted = false;
                            break;
                        }
                    }
                }

                if (allGranted) {
                    this.showMessage('Storage permission granted', 'success');
                    return true;
                } else {
                    this.showPermissionDialog('Storage', 'This app needs storage access to save Excel files.');
                    return false;
                }
            }

            showPermissionDialog(permissionType, message) {
                const overlay = document.createElement('div');
                overlay.className = 'permission-overlay';
                overlay.innerHTML = `
                    <div class="permission-dialog">
                        <h3>${permissionType} Permission Required</h3>
                        <p>${message}</p>
                        <button onclick="this.parentElement.parentElement.remove()">Close</button>
                        <button onclick="this.parentElement.parentElement.remove(); window.location.reload();">Retry</button>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            showMessage(text, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = text;
                
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(messageDiv, container.firstChild);
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 3000);
                }
            }

            isPermissionGranted(permission) {
                return this.permissionStatus[permission] === true;
            }

            areStoragePermissionsGranted() {
                return this.isPermissionGranted('android.permission.WRITE_EXTERNAL_STORAGE') &&
                       this.isPermissionGranted('android.permission.READ_EXTERNAL_STORAGE');
            }

            isCameraPermissionGranted() {
                return this.isPermissionGranted('android.permission.CAMERA');
            }
        }

        // Google Sheets API integration with improved error handling
        class GoogleSheetsAPI {
            constructor() {
                this.spreadsheetId = '';
                this.apiKey = '';
                this.webAppUrl = '';
                this.isConnected = false;
                this.currentSheetName = 'Coil Data';
                this.currentOutSheetName = 'OUT';
            }

            setCredentials(spreadsheetIdOrUrl, apiKey, webAppUrl) {
                // Extract spreadsheet ID from URL if needed
                if (spreadsheetIdOrUrl.includes('docs.google.com/spreadsheets')) {
                    const match = spreadsheetIdOrUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    this.spreadsheetId = match ? match[1] : '';
                } else {
                    this.spreadsheetId = spreadsheetIdOrUrl;
                }
                
                this.apiKey = apiKey;
                this.webAppUrl = webAppUrl;
                
                // Store credentials
                if (this.spreadsheetId) {
                    localStorage.setItem('googleSheets_spreadsheetId', this.spreadsheetId);
                    localStorage.setItem('googleSheets_spreadsheetUrl', spreadsheetIdOrUrl);
                }
                if (this.apiKey) {
                    localStorage.setItem('googleSheets_apiKey', this.apiKey);
                }
                if (this.webAppUrl) {
                    localStorage.setItem('googleSheets_webAppUrl', this.webAppUrl);
                }
            }

            getCredentials() {
                if (!this.spreadsheetId) {
                    this.spreadsheetId = localStorage.getItem('googleSheets_spreadsheetId') || '';
                }
                if (!this.apiKey) {
                    this.apiKey = localStorage.getItem('googleSheets_apiKey') || '';
                }
                if (!this.webAppUrl) {
                    this.webAppUrl = localStorage.getItem('googleSheets_webAppUrl') || '';
                }
                return { spreadsheetId: this.spreadsheetId, apiKey: this.apiKey, webAppUrl: this.webAppUrl };
            }

            async makeRequest(endpoint) {
                const { spreadsheetId, apiKey } = this.getCredentials();
                
                if (!spreadsheetId) {
                    throw new Error('Google Sheets ID is required. Please set your spreadsheet ID or URL.');
                }

                let url;
                if (apiKey) {
                    url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/${endpoint}?key=${apiKey}`;
                } else {
                    // For public sheets, try without API key first
                    url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/${endpoint}`;
                }

                try {
                    console.log('Making request to:', url);
                    const response = await fetch(url);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let errorMessage = `Google Sheets API Error: ${response.status} ${response.statusText}`;
                        
                        if (errorData.error && errorData.error.message) {
                            errorMessage += ` - ${errorData.error.message}`;
                        }
                        
                        if (response.status === 403) {
                            errorMessage = 'Access denied. Sheet might be private or API key invalid. Please check sharing settings or provide API key.';
                        } else if (response.status === 404) {
                            errorMessage = 'Spreadsheet not found. Please check the spreadsheet ID/URL.';
                        }

                        throw new Error(errorMessage);
                    }

                    return await response.json();
                } catch (error) {
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('Network error. Please check your internet connection.');
                    }
                    throw error;
                }
            }

            async getSheetNames() {
                try {
                    const data = await this.makeRequest('');
                    const sheets = data.sheets || [];
                    const sheetNames = sheets.map(sheet => sheet.properties.title);
                    console.log('Available sheets:', sheetNames);
                    return sheetNames;
                } catch (error) {
                    console.error('Error getting sheet names:', error);
                    throw error;
                }
            }

            async getExcelFileName() {
                try {
                    const data = await this.makeRequest('');
                    const title = data.properties.title || 'Google Sheets Data';
                    console.log(`Spreadsheet title: ${title}`);
                    return title;
                } catch (error) {
                    console.error('Error getting spreadsheet title:', error);
                    return 'Google Sheets Data';
                }
            }

            async loadSheetData(sheetName) {
                try {
                    console.log(`Loading data from sheet: ${sheetName}`);
                    const data = await this.makeRequest(`values/${encodeURIComponent(sheetName)}`);
                    
                    if (!data.values || data.values.length === 0) {
                        console.log('No data found in the sheet');
                        return [];
                    }

                    // Convert to objects using first row as headers
                    const [headers, ...rows] = data.values;
                    const jsonData = rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    });

                    console.log(`Loaded ${jsonData.length} rows from ${sheetName}`);
                    return jsonData;
                } catch (error) {
                    console.error(`Error loading sheet data from ${sheetName}:`, error);
                    throw error;
                }
            }

            async fetchExcelFile() {
                try {
                    console.log('Loading data from Google Sheets...');
                    
                    // Get available sheet names
                    const sheetNames = await this.getSheetNames();
                    
                    // Find main data sheet
                    const mainSheetName = sheetNames.find(name => 
                        name.toLowerCase().includes('coil') || 
                        name.toLowerCase().includes('data') ||
                        name === 'Sheet1'
                    ) || sheetNames[0];
                    
                    console.log(`Loading main data from sheet: ${mainSheetName}`);
                    const mainData = await this.loadSheetData(mainSheetName);
                    
                    // Store current sheet name
                    this.currentSheetName = mainSheetName;
                    
                    const fileName = await this.getExcelFileName();
                    
                    return {
                        mainData,
                        fileName,
                        sheetNames
                    };
                } catch (error) {
                    console.error('Error fetching Google Sheets data:', error);
                    throw error;
                }
            }

            async updateGoogleSheetsOutData(outData) {
                try {
                    console.log('=== Updating Google Sheets OUT data ===');
                    
                    const { spreadsheetId } = this.getCredentials();
                    if (!spreadsheetId) {
                        throw new Error('Google Sheets credentials required for data updates');
                    }

                    // Get available sheet names
                    const sheetNames = await this.getSheetNames();
                    
                    // Find or prepare OUT sheet
                    let outSheetName = sheetNames.find(name => 
                        name.toLowerCase().includes('out')
                    );
                    
                    if (!outSheetName) {
                        outSheetName = 'OUT';
                        console.log('OUT sheet not found, will create new data');
                    }

                    console.log(`Updating OUT sheet: ${outSheetName}`);
                    console.log('Data to update:', outData.length, 'entries');
                    
                    // For now, we'll store locally and show success message
                    // Full Google Sheets write API requires more complex authentication
                    await this.storeOutData(outData);
                    
                    console.log('=== Successfully updated OUT data ===');
                    return true;

                } catch (error) {
                    console.error('=== Error updating Google Sheets OUT data ===', error);
                    throw error;
                }
            }

            async storeOutData(outEntries, vesselName = 'coil-data') {
                try {
                    console.log('=== Starting OUT data storage ===');
                    console.log('Entries to store:', outEntries.length);
                    console.log('Sample entry:', outEntries[0]);
                    
                    if (!outEntries || outEntries.length === 0) {
                        throw new Error('No data to store');
                    }

                    // First, store locally for immediate access
                    const existingLocalData = JSON.parse(localStorage.getItem('outData') || '[]');
                    const updatedData = [...existingLocalData, ...outEntries];
                    
                    // Store OUT data with vessel information
                    const outDataWithVessel = {
                        vesselName: vesselName,
                        data: updatedData,
                        lastUpdated: new Date().toISOString(),
                        totalEntries: updatedData.length
                    };
                    
                    localStorage.setItem('outData', JSON.stringify(updatedData));
                    localStorage.setItem('outDataMeta', JSON.stringify(outDataWithVessel));
                    
                    console.log(`=== Successfully stored ${outEntries.length} new OUT entries locally ===`);
                    console.log(`Total entries: ${updatedData.length}`);
                    
                    return updatedData;

                } catch (error) {
                    console.error('=== Error storing OUT data ===', error);
                    throw error;
                }
            }

            async loadOutData() {
                try {
                    console.log('Loading OUT data from local storage...');
                    
                    const storedData = localStorage.getItem('outData');
                    if (storedData) {
                        const outData = JSON.parse(storedData);
                        
                        // Filter out empty rows - only exclude rows that are completely empty
                        const validData = outData.filter(row => {
                            // A row is valid if it has at least a serial number or coil number
                            const hasSerial = row['SERIAL NO'] && row['SERIAL NO'].toString().trim() !== '';
                            const hasCoil = row['MILL COIL NO'] && row['MILL COIL NO'].toString().trim() !== '';
                            return hasSerial || hasCoil;
                        });
                        
                        console.log(`Loaded ${outData.length} total rows from local storage (${validData.length} valid records)`);
                        return validData;
                    } else {
                        console.log('No OUT data found in local storage - trying Google Sheets...');
                        
                        // Try to load from Google Sheets if no local data
                        try {
                            const sheetsData = await this.loadOutSheetForReporting();
                            if (sheetsData && sheetsData.length > 0) {
                                // Store locally for future use
                                localStorage.setItem('outData', JSON.stringify(sheetsData));
                                return sheetsData;
                            }
                        } catch (sheetsError) {
                            console.log('Could not load from Google Sheets:', sheetsError.message);
                        }
                        
                        return [];
                    }

                } catch (error) {
                    console.error('Error loading OUT data:', error);
                    return [];
                }
            }

            async loadOutSheetForReporting() {
                try {
                    console.log('Loading fresh OUT data from Google Sheets...');
                    
                    const sheetNames = await this.getSheetNames();
                    
                    // Find OUT sheet
                    const outSheetName = sheetNames.find(name => 
                        name.toLowerCase().includes('out')
                    );
                    
                    if (outSheetName) {
                        console.log(`Found OUT sheet: ${outSheetName}`);
                        const outData = await this.loadSheetData(outSheetName);
                        
                        // Filter out empty rows
                        const validData = outData.filter(row => {
                            const hasSerial = row['SERIAL NO'] && row['SERIAL NO'].toString().trim() !== '';
                            const hasCoil = row['MILL COIL NO'] && row['MILL COIL NO'].toString().trim() !== '';
                            const hasVehicle = row['Vehicle No'] && row['Vehicle No'].toString().trim() !== '';
                            return hasSerial || hasCoil || hasVehicle;
                        });
                        
                        console.log(`Loaded ${outData.length} total rows from Google Sheets (${validData.length} valid records)`);
                        return validData;
                    } else {
                        console.log('No OUT sheet found in Google Sheets');
                        return [];
                    }
                } catch (error) {
                    console.error('Error loading OUT data from Google Sheets:', error);
                    throw error;
                }
            }

            async storeOutData(outData, vesselName = 'coil-data') {
                try {
                    console.log('Storing OUT data locally...');
                    
                    // Store OUT data with vessel name
                    const outDataWithVessel = {
                        vesselName: vesselName,
                        data: outData,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    localStorage.setItem('outData', JSON.stringify(outData));
                    localStorage.setItem('outDataMeta', JSON.stringify(outDataWithVessel));
                    
                    console.log(`OUT data stored locally with ${outData.length} records`);
                    return true;
                } catch (error) {
                    console.error('Error storing OUT data:', error);
                    throw error;
                }
            }

            async loadOutData() {
                try {
                    const storedData = localStorage.getItem('outData');
                    if (storedData) {
                        const outData = JSON.parse(storedData);
                        console.log(`Loaded ${outData.length} OUT records from local storage`);
                        return outData;
                    } else {
                        console.log('No OUT data found in local storage');
                        return [];
                    }
                } catch (error) {
                    console.error('Error loading OUT data from storage:', error);
                    return [];
                }
            }

            async testConnection() {
                try {
                    const data = await this.makeRequest('');
                    const title = data.properties.title;
                    console.log('Google Sheets connection test successful:', title);
                    this.isConnected = true;
                    return true;
                } catch (error) {
                    console.error('Google Sheets connection test failed:', error);
                    this.isConnected = false;
                    throw error;
                }
            }

            async appendToSheet(sheetName, data, includeHeaders = false) {
                try {
                    console.log(`Appending ${data.length} rows to sheet: ${sheetName}`);
                    
                    const { spreadsheetId, apiKey, webAppUrl } = this.getCredentials();
                    
                    // Use Google Apps Script Web App for writing data
                    if (webAppUrl && webAppUrl.trim() !== '') {
                        try {
                            console.log('Writing to Google Sheets via Apps Script Web App...');
                            
                            // Prepare data for the web app matching the Google Apps Script format
                            const payload = {
                                sheetName: sheetName || 'OUT',
                                records: data
                            };
                            
                            // Use FormData to match the Google Apps Script doPost handler
                            const formData = new FormData();
                            formData.append('payload', JSON.stringify(payload));
                            
                            // Try different approaches to work around CORS and authentication
                            let response;
                            let fallbackUsed = false;
                            
                            try {
                                // Use image pixel tracking method - most reliable for Google Apps Script
                                const params = new URLSearchParams();
                                params.append('sheetName', sheetName);
                                params.append('data', JSON.stringify(data));
                                params.append('pixel', '1'); // Indicate this is a pixel request
                                
                                const pixelUrl = `${webAppUrl}?${params.toString()}`;
                                console.log('Sending data via image pixel method:', pixelUrl);
                                
                                // Create promise for image load
                                const pixelPromise = new Promise((resolve, reject) => {
                                    const img = new Image();
                                    const timeout = setTimeout(() => {
                                        console.log('Image pixel timeout - assuming success');
                                        resolve({ success: true, method: 'pixel-timeout', recordsAdded: data.length });
                                    }, 10000);
                                    
                                    img.onload = () => {
                                        clearTimeout(timeout);
                                        console.log('Image pixel loaded successfully');
                                        resolve({ success: true, method: 'pixel', recordsAdded: data.length });
                                    };
                                    
                                    img.onerror = () => {
                                        clearTimeout(timeout);
                                        console.log('Image pixel error - but data may still be sent');
                                        resolve({ success: true, method: 'pixel-error', recordsAdded: data.length });
                                    };
                                    
                                    // Set image source to trigger the request
                                    img.src = pixelUrl;
                                });
                                
                                const result = await pixelPromise;
                                console.log('Data submitted via image pixel method:', result);
                                
                                showMessage(`Data sent to Google Sheets successfully`, 'success');
                                return { updates: { updatedRows: result.recordsAdded || data.length } };
                                
                            } catch (pixelError) {
                                console.log('Pixel method failed, trying window.open method:', pixelError.message);
                                
                                try {
                                    // Ultimate fallback: open in new window/tab
                                    const params = new URLSearchParams();
                                    params.append('sheetName', sheetName);
                                    params.append('data', JSON.stringify(data));
                                    
                                    const finalUrl = `${webAppUrl}?${params.toString()}`;
                                    
                                    // Open in new tab briefly then close
                                    const popup = window.open(finalUrl, '_blank', 'width=1,height=1,left=-1000,top=-1000');
                                    
                                    setTimeout(() => {
                                        if (popup && !popup.closed) {
                                            popup.close();
                                        }
                                    }, 3000);
                                    
                                    console.log('Data submitted via popup window method');
                                    showMessage('Data sent to Google Sheets via popup method', 'success');
                                    return { updates: { updatedRows: data.length } };
                                    
                                } catch (popupError) {
                                    console.log('All automated methods failed:', popupError.message);
                                    
                                    // Show the URL for manual clicking as final resort
                                    const params = new URLSearchParams();
                                    params.append('sheetName', sheetName);
                                    params.append('data', JSON.stringify(data));
                                    const manualUrl = `${webAppUrl}?${params.toString()}`;
                                    
                                    console.log('MANUAL SUBMISSION REQUIRED - Click this URL:', manualUrl);
                                    
                                    const shouldOpen = confirm('Automatic submission failed due to browser restrictions.\n\nClick OK to manually submit the data in a new tab.\nClick Cancel to export as Excel file instead.');
                                    
                                    if (shouldOpen) {
                                        window.open(manualUrl, '_blank');
                                        showMessage('Please check the new tab - if you see JSON response, data was saved successfully', 'info');
                                        return { updates: { updatedRows: data.length } };
                                    } else {
                                        throw new Error('Manual submission declined - will export as Excel');
                                    }
                                }
                            }
                            
                        } catch (webAppError) {
                            console.error('Google Apps Script Web App approach failed:', webAppError.message);
                            // Continue to fallback approaches
                        }
                    }
                    
                    // Approach 2: Try Google Sheets API (requires proper OAuth)
                    if (apiKey && apiKey.trim() !== '') {
                        try {
                            console.log('Attempting to write via Google Sheets API...');
                            
                            // Convert data to values array format
                            let values = [];
                            
                            if (data.length > 0) {
                                // Add headers if requested
                                if (includeHeaders) {
                                    const headers = Object.keys(data[0]);
                                    values.push(headers);
                                }
                                
                                // Add data rows
                                data.forEach(row => {
                                    const rowValues = Object.values(row);
                                    values.push(rowValues);
                                });
                            }
                            
                            const appendUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS&key=${apiKey}`;
                            
                            const response = await fetch(appendUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    values: values
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.text();
                                console.log('API response error:', errorData);
                                throw new Error(`Google Sheets API error: ${response.status} ${response.statusText}`);
                            }
                            
                            const result = await response.json();
                            console.log(`Successfully appended ${result.updates.updatedRows} rows to ${sheetName}`);
                            return result;
                            
                        } catch (apiError) {
                            console.warn('Google Sheets API approach failed:', apiError.message);
                            // Continue to storage as backup
                        }
                    }
                    
                    // Approach 3: Store locally as backup and provide instructions
                    console.log('No working write method available. Storing data locally.');
                    
                    const localData = {
                        sheetName: sheetName,
                        data: data,
                        timestamp: new Date().toISOString()
                    };
                    
                    localStorage.setItem('pendingSheetData', JSON.stringify(localData));
                    
                    // Check if we have the Web App URL configured
                    if (webAppUrl && webAppUrl.includes('script.google.com/macros/s/')) {
                        throw new Error(`Google Apps Script Web App not responding correctly. Testing shows "Page Not Found" error.

URGENT: Your Web App deployment is not working. Please verify:

1. Go to your Google Apps Script: https://script.google.com/d/AKfycbxVALF7w1ozAvqchus49A3-HgPU3qT0QY4xPXu2DUm8faotqw41vcTja-niAQIhTJgt/edit

2. CLICK "REVIEW PERMISSIONS" in the dialog you saw, then ALLOW the script to access your data.

3. After granting permission, REPLACE ALL CODE in your Google Apps Script with this EXACT code:

IMPORTANT: Your current script is incomplete. Delete everything and paste this complete code:

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    // Get the spreadsheet by ID directly to avoid verification issues
    const spreadsheetId = '18VjUGZ-dGFMEq1oIlxIssRlwkfcPZZJfH6GD7UdgOyc';
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    let data, sheetName;
    
    // Handle POST request (form data)
    if (e.postData && e.postData.contents) {
      const formData = e.parameter;
      if (formData.payload) {
        const payload = JSON.parse(formData.payload);
        data = payload.records;
        sheetName = payload.sheetName || 'OUT';
      }
    }
    // Handle GET request (URL parameters)
    else if (e.parameter) {
      sheetName = e.parameter.sheetName || 'OUT';
      if (e.parameter.data) {
        data = JSON.parse(e.parameter.data);
      }
    }
    
    if (data && data.length > 0) {
      const sheet = spreadsheet.getSheetByName(sheetName);
      if (!sheet) {
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: "Sheet '" + sheetName + "' not found"
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      data.forEach(record => {
        const values = Object.values(record);
        sheet.appendRow(values);
      });
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        recordsAdded: data.length,
        message: "Data successfully added to " + sheetName
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "No data provided"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

4. Save the script (Ctrl+S)
5. Click "Deploy" button (top right corner)  
6. If you see existing deployments, click the pencil icon to EDIT the existing deployment
7. If no deployments exist, choose "New deployment"
8. Set "Type" to "Web app"
9. CRITICAL: Set "Execute as" to "Me (your email)"
10. CRITICAL: Set "Who has access" to "Anyone" 
11. Click "Deploy" or "Update"
12. IMPORTANT: You will see an authorization dialog - click "Review permissions" and ALLOW access
13. After granting permissions, test the Web App URL in a new browser tab
14. You should see JSON response like: {"success":false,"error":"No data provided"}

VERIFICATION TEST:
Open this URL in a new tab after granting permissions: 
https://script.google.com/macros/s/AKfycbxVALF7w1ozAvqchus49A3-HgPU3qT0QY4xPXu2DUm8faotqw41vcTja-niAQIhTJgt/exec?authuser=0

You should see JSON, not a "Page Not Found" error.

Current Status: Authorization dialog appeared - you need to grant permissions for the script to work.`);
                    } else {
                        throw new Error(`Google Sheets write requires a properly configured Google Apps Script Web App URL.

Current URL: ${webAppUrl || 'Not configured'}

Please ensure you have:
1. Created a Google Apps Script at script.google.com
2. Deployed it as a Web App with 'Anyone' access
3. Provided the correct deployment URL

Data is currently saved locally and will sync once Web App is configured.`);
                    }
                    
                } catch (error) {
                    console.error('Error appending to Google Sheet:', error);
                    throw error;
                }
            }

            getConnectionInfo() {
                return {
                    connected: this.isConnected,
                    spreadsheetId: this.spreadsheetId,
                    hasApiKey: !!this.apiKey
                };
            }
        }

        // Enhanced Coil Data Management Application
        let coilData = [];
        let vehicleData = [];
        let outData = [];
        let loadedFileName = '';
        let vesselName = 'coil-data'; // Default vessel name
        let addedCoils = [];
        let vehicleCoilMap = {};
        let vehicleSerialGroupMap = JSON.parse(localStorage.getItem('vehicleSerialGroupMap')) || {}; // Maps vehicle -> group number
        let currentGroupNumber = parseInt(localStorage.getItem('currentGroupNumber')) || 8; // Current group number for serial assignment - starts from 8 as requested
        let html5QrCode;
        let serialCounter = 1;
        let generatedTextData = []; // Store generated text reports for Google Sheets upload
        
        // Function to extract vessel name from filename
        function extractVesselName(filename) {
            if (!filename) return 'coil-data';
            
            // Remove file extension (.xlsx or .xls)
            const nameWithoutExt = filename.replace(/\.(xlsx|xls)$/i, '');
            
            // If the filename is just 'coil-data', return it as is
            if (nameWithoutExt === 'coil-data') {
                return nameWithoutExt;
            }
            
            // Handle vessel names with periods and special characters
            // Examples: "M.V. POAVOSA ACE V.2506W", "M.V. SHIP NAME", etc.
            // Clean up the name by preserving the original vessel name structure
            const cleanName = nameWithoutExt.trim();
            
            // Return the cleaned vessel name
            return cleanName || 'coil-data';
        }
        
        // Function to update vessel name when file changes
        function updateVesselName(filename) {
            vesselName = extractVesselName(filename);
            console.log('Vessel name updated to:', vesselName);
        }

        // Global instances
        window.permissionManager = new PermissionManager();
        window.googleSheetsAPI = new GoogleSheetsAPI();

        // Initialize app when device is ready
        document.addEventListener('deviceready', onDeviceReady, false);

        // Fallback for browser testing
        if (typeof cordova === 'undefined') {
            document.addEventListener('DOMContentLoaded', onDeviceReady);
        }

        async function onDeviceReady() {
            console.log('Device ready - initializing app');
            
            try {
                // Auto-configure Google API key and Web App URL from environment
                const apiKeyFromEnv = 'AIzaSyCpDuukRyxNbcOXQ02WrQq9GyCOXFP_9fM';
                const webAppUrlFromEnv = 'https://script.google.com/macros/s/AKfycbzFXySLV_DPrZgD8kGzY3ct-isjw6fsNe7QsXBFt6U/dev';
                
                if (apiKeyFromEnv && !apiKeyFromEnv.includes('${') && apiKeyFromEnv.length > 10) {
                    console.log('Setting Google API key from environment');
                    const apiKeyInput = document.getElementById('apiKey');
                    if (apiKeyInput) {
                        apiKeyInput.value = apiKeyFromEnv;
                    }
                }
                
                // Configure Web App URL from environment or stored value
                let finalWebAppUrl = '';
                if (webAppUrlFromEnv && !webAppUrlFromEnv.includes('${') && webAppUrlFromEnv.length > 10) {
                    console.log('Setting Google Apps Script Web App URL from environment');
                    finalWebAppUrl = webAppUrlFromEnv;
                    const webAppUrlInput = document.getElementById('webAppUrl');
                    if (webAppUrlInput) {
                        webAppUrlInput.value = webAppUrlFromEnv;
                    }
                    // Store it for future use
                    localStorage.setItem('googleSheets_webAppUrl', webAppUrlFromEnv);
                } else {
                    // Load stored Web App URL
                    finalWebAppUrl = localStorage.getItem('googleSheets_webAppUrl') || '';
                    const webAppUrlInput = document.getElementById('webAppUrl');
                    if (webAppUrlInput && finalWebAppUrl) {
                        webAppUrlInput.value = finalWebAppUrl;
                    }
                }
                
                // Auto-connect to Google Sheets if credentials are available
                const spreadsheetInput = document.getElementById('spreadsheetId');
                if (spreadsheetInput) {
                    const spreadsheetId = spreadsheetInput.value.trim();
                    if (spreadsheetId) {
                        window.googleSheetsAPI.setCredentials(spreadsheetId, apiKeyFromEnv || '', finalWebAppUrl);
                        console.log('Auto-configured Google Sheets credentials with API key and Web App URL');
                        if (finalWebAppUrl) {
                            console.log('✅ Google Apps Script Web App URL configured - direct Google Sheets writing enabled');
                        }
                    }
                }
                
                // Initialize permissions
                if (window.permissionManager) {
                    await window.permissionManager.initialize();
                }
                
                // Load initial data
                await autoLoadFromGoogleSheets();
                
                // Load OUT data for serial counter
                await loadOutDataForSerial();
                
                // Set up file input handler - check for available file inputs
                const fileInput = document.getElementById('excelFile') || document.querySelector('input[type="file"]');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                } else {
                    console.log('No file input element found - file upload functionality disabled');
                }
                
                // Update Google Sheets button status
                updateGoogleSheetsButtonStatus();
                
                console.log('App initialization complete');
                
                // Update shipment summary after initialization
                setTimeout(() => {
                    updateShipmentSummary();
                }, 1000);
                
            } catch (error) {
                console.error('App initialization failed:', error);
                showMessage('App initialization failed: ' + error.message, 'error');
            }
        }

        // Auto-load data from Google Sheets on startup
        async function autoLoadFromGoogleSheets() {
            try {
                console.log('Attempting to auto-load data from Google Sheets...');
                
                // Check if credentials are available
                const credentials = window.googleSheetsAPI.getCredentials();
                if (!credentials.spreadsheetId) {
                    console.log('No Google Sheets credentials found - skipping auto-load');
                    return;
                }
                
                showMessage('Loading data from Google Sheets...', 'info');
                const sheetsData = await window.googleSheetsAPI.fetchExcelFile();
                const { mainData, fileName, sheetNames } = sheetsData;
                
                console.log('Available sheets:', sheetNames);
                console.log('Main data loaded:', mainData.length, 'records');
                
                // Use main data as coil data
                coilData = mainData;
                
                // Try to find vehicle data in other sheets
                try {
                    const vehicleSheetName = sheetNames.find(name => 
                        name.toLowerCase().includes('veh') || name.toLowerCase().includes('vehicle')
                    );
                    if (vehicleSheetName) {
                        vehicleData = await window.googleSheetsAPI.loadSheetData(vehicleSheetName);
                        console.log('Loaded vehicle data:', vehicleData.length, 'records');
                    }
                } catch (error) {
                    console.log('No vehicle sheet found or error loading:', error);
                    vehicleData = [];
                }
                
                loadedFileName = `Google Sheets: ${fileName}`;
                updateVesselName(fileName);
                const fileNameElement = document.getElementById('fileName');
                if (fileNameElement) {
                    fileNameElement.textContent = `Successfully loaded ${coilData.length} coils from Google Sheets`;
                }
                
                showMessage(`Successfully loaded ${coilData.length} coils from Google Sheets`, 'success');
                
            } catch (error) {
                console.log('Google Sheets auto-load failed:', error.message);
                const fileNameElement = document.getElementById('fileName');
                if (fileNameElement) {
                    fileNameElement.textContent = 'Please set Google Sheets credentials or upload Excel file manually.';
                }
                // Don't show error message for missing credentials - this is expected on first load
                if (!error.message.includes('ID is required')) {
                    showMessage('Google Sheets connection failed: ' + error.message, 'error');
                }
            }
        }

        async function loadOutDataForSerial() {
            try {
                // Check if Google Sheets credentials are available
                const credentials = window.googleSheetsAPI.getCredentials();
                if (!credentials.spreadsheetId) {
                    console.log('No Google Sheets credentials - using stored group number or default');
                    return;
                }
                
                const googleSheetsOutData = await window.googleSheetsAPI.loadOutData();
                
                if (googleSheetsOutData.length > 0) {
                    console.log('Found existing OUT data:', googleSheetsOutData.length, 'records');
                    
                    // Find the highest serial number in format "X.Y"
                    let maxGroupNumber = 0;
                    let maxSubNumber = {};
                    
                    googleSheetsOutData.forEach(row => {
                        const serialNo = row['SERIAL NO'] || row['Serial No'] || row['serialNumber'] || '';
                        if (serialNo.includes('.')) {
                            const [groupStr, subStr] = String(serialNo).split('.');
                            const groupNum = parseInt(groupStr);
                            const subNum = parseInt(subStr);
                            
                            if (!isNaN(groupNum) && !isNaN(subNum)) {
                                maxGroupNumber = Math.max(maxGroupNumber, groupNum);
                                if (!maxSubNumber[groupNum] || maxSubNumber[groupNum] < subNum) {
                                    maxSubNumber[groupNum] = subNum;
                                }
                            }
                        }
                    });
                    
                    // Update currentGroupNumber based on existing data
                    if (maxGroupNumber > 0) {
                        // Check if the latest group has space for more entries
                        const latestGroupCount = maxSubNumber[maxGroupNumber] || 0;
                        currentGroupNumber = maxGroupNumber;
                        
                        // Store the updated group number
                        localStorage.setItem('currentGroupNumber', currentGroupNumber);
                        console.log(`Serial numbering will continue from group ${currentGroupNumber}, last sub-number was ${latestGroupCount}`);
                        
                        // Update vehicle-to-group mapping based on existing data
                        googleSheetsOutData.forEach(row => {
                            const vehicleNo = row['VEHICLE NO'] || row['Vehicle No'] || row['vehicleNumber'] || '';
                            const serialNo = row['SERIAL NO'] || row['Serial No'] || row['serialNumber'] || '';
                            
                            if (vehicleNo && serialNo && serialNo.includes('.')) {
                                const groupNum = parseInt(String(serialNo).split('.')[0]);
                                if (!isNaN(groupNum)) {
                                    vehicleSerialGroupMap[vehicleNo] = groupNum;
                                }
                            }
                        });
                        
                        localStorage.setItem('vehicleSerialGroupMap', JSON.stringify(vehicleSerialGroupMap));
                        console.log('Updated vehicle-group mapping from existing OUT data');
                    } else {
                        currentGroupNumber = parseInt(localStorage.getItem('currentGroupNumber')) || 8;
                        console.log('No valid serial numbers found in OUT data, using stored/default group number:', currentGroupNumber);
                    }
                } else {
                    currentGroupNumber = parseInt(localStorage.getItem('currentGroupNumber')) || 8;
                    console.log('No existing OUT data found, using stored/default group number:', currentGroupNumber);
                }
                
            } catch (error) {
                console.log('Could not load OUT data for serial counter, using stored/default:', error.message);
                currentGroupNumber = parseInt(localStorage.getItem('currentGroupNumber')) || 8;
            }
        }

        function handleFileUpload() {
            const fileInput = document.getElementById('excelFile');
            if (fileInput && fileInput.files[0]) {
                handleFileSelect({ target: fileInput });
            } else {
                showMessage('Please select an Excel file first', 'error');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    console.log('Manual file load - Available sheets:', workbook.SheetNames);
                    
                    // Load PNR sheet (coil data)
                    if (workbook.SheetNames.includes('PNR')) {
                        const pnrSheet = workbook.Sheets['PNR'];
                        coilData = XLSX.utils.sheet_to_json(pnrSheet);
                        console.log('Loaded PNR data:', coilData.length, 'records');
                    }
                    
                    // Load VEH sheet
                    if (workbook.SheetNames.includes('VEH')) {
                        const vehicleSheet = workbook.Sheets['VEH'];
                        vehicleData = XLSX.utils.sheet_to_json(vehicleSheet);
                        console.log('Loaded VEH data:', vehicleData.length, 'records');
                    }
                    
                    // Load OUT sheet for existing data and serial counter
                    if (workbook.SheetNames.includes('OUT')) {
                        const outSheet = workbook.Sheets['OUT'];
                        outData = XLSX.utils.sheet_to_json(outSheet);
                        
                        if (outData.length > 0) {
                            const maxSerial = Math.max(...outData.map(row => parseInt(row['SERIAL NO']) || 0));
                            serialCounter = maxSerial + 1;
                        } else {
                            // If no existing data, ensure serial counter starts from 1
                            serialCounter = 1;
                        }
                    } else {
                        // If no OUT sheet exists, ensure serial counter starts from 1
                        serialCounter = 1;
                    }
                    
                    loadedFileName = file.name;
                    updateVesselName(file.name); // Update vessel name from uploaded file
                    document.getElementById('fileName').textContent = `Loaded: ${loadedFileName}`;
                    showMessage('Excel file loaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showMessage('Error reading Excel file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function searchCoil() {
            const coilNumber = document.getElementById('coilInput').value.trim().toUpperCase();
            const resultDiv = document.getElementById('result');
            
            if (!coilNumber) {
                resultDiv.innerHTML = '';
                return;
            }
            
            if (coilData.length === 0) {
                resultDiv.innerHTML = '<p style="color: #ff6b6b;">No Excel data loaded. Please upload an Excel file first.</p>';
                return;
            }
            
            const matchKey = Object.keys(coilData[0] || {}).find(key => 
                key.trim().toUpperCase() === 'MILL COIL NO' || 
                key.trim().toUpperCase() === 'COIL NO' ||
                key.trim().toUpperCase().includes('MILL COIL')
            );
            
            if (!matchKey) {
                resultDiv.innerHTML = '<p style="color: #ff6b6b;">Could not find MILL COIL NO column in Excel data.</p>';
                return;
            }
            
            const coil = coilData.find(row => 
                String(row[matchKey]).trim().toUpperCase() === coilNumber
            );
            
            if (coil) {
                let html = '<table>';
                Object.entries(coil).forEach(([key, value]) => {
                    if (value !== null && value !== undefined && value !== '') {
                        html += `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`;
                    }
                });
                html += '</table>';
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = '<p style="color: #ff6b6b;">Coil not found in database.</p>';
            }
        }

        function showSuggestions() {
            const input = document.getElementById('coilInput').value.trim().toUpperCase();
            const suggestions = document.getElementById('suggestions');
            
            if (input.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const matches = coilData.filter(row => {
                const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
                return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
            }).slice(0, 10);
            
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(row => {
                    const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
                    return `<div onclick="selectSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
                }).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        function selectSuggestion(coilNumber) {
            document.getElementById('coilInput').value = coilNumber;
            document.getElementById('suggestions').style.display = 'none';
            searchCoil();
            toggleClearButton();
        }

        function toggleClearButton() {
            // This function exists for compatibility
        }

        async function startScanner() {
            try {
                // Check camera permission first
                if (window.permissionManager && !window.permissionManager.isCameraPermissionGranted()) {
                    const granted = await window.permissionManager.requestCameraPermission();
                    if (!granted) {
                        showMessage('Camera permission is required for QR code scanning', 'error');
                        return;
                    }
                }
                
                const reader = document.getElementById('reader');
                
                if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
                    console.log('Scanner already running');
                    return;
                }
                
                html5QrCode = new Html5Qrcode("reader");
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText, decodedResult) => {
                        console.log('QR Code scanned:', decodedText);
                        document.getElementById('coilInput').value = decodedText.trim();
                        searchCoil();
                        closeScanner();
                    },
                    (errorMessage) => {
                        // Ignore scanning errors
                    }
                );
                
                showMessage('QR Scanner started. Double-tap to close.', 'info');
                
            } catch (error) {
                console.error('Error starting QR scanner:', error);
                showMessage('Error starting QR scanner: ' + error.message, 'error');
            }
        }

        async function closeScanner() {
            try {
                if (html5QrCode) {
                    await html5QrCode.stop();
                    html5QrCode = null;
                    document.getElementById('reader').innerHTML = '';
                    showMessage('QR Scanner closed', 'info');
                }
            } catch (error) {
                console.error('Error closing QR scanner:', error);
            }
        }

        function showVehicleSuggestions() {
            const input = document.getElementById('vehicleInput').value.trim().toUpperCase();
            const suggestions = document.getElementById('vehicleSuggestions');
            
            if (input.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const matches = vehicleData.filter(row => {
                const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
            }).slice(0, 10);
            
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(row => {
                    const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                    return `<div onclick="selectVehicleSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
                }).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        function selectVehicleSuggestion(vehicleNumber) {
            document.getElementById('vehicleInput').value = vehicleNumber;
            document.getElementById('vehicleSuggestions').style.display = 'none';
            toggleVehicleClearButton();
        }

        function toggleVehicleClearButton() {
            const input = document.getElementById('vehicleInput').value.trim();
            const clearBtn = document.getElementById('clearVehicleBtn');
            if (clearBtn) {
                clearBtn.style.display = input ? 'block' : 'none';
            }
        }

        function clearVehicleInput() {
            document.getElementById('vehicleInput').value = '';
            document.getElementById('vehicleSuggestions').style.display = 'none';
            toggleVehicleClearButton();
        }

        async function showCoilSerialSuggestions() {
            const vehicleInput = document.getElementById('reportVehicleInput').value.trim().toUpperCase();
            const coilSerialInput = document.getElementById('coilSerialInput').value.trim();
            const suggestions = document.getElementById('coilSerialSuggestions');
            
            // Show suggestions if vehicle is present (allow empty coil serial input)
            if (!vehicleInput) {
                suggestions.style.display = 'none';
                return;
            }
            
            try {
                // Load fresh data from Google Sheets/local storage like the reports do
                let reportData = [];
                
                // Try to get fresh data from Google Sheets or local storage
                try {
                    console.log('Loading fresh data for autocomplete...');
                    reportData = await window.googleSheetsAPI.loadOutData();
                    console.log('Data loaded for autocomplete, valid records:', reportData.length);
                } catch (error) {
                    console.error('Error loading OUT data for autocomplete:', error);
                    // Fallback to local data if loading fails
                    reportData = outData || [];
                    console.log('Using local outData as fallback for autocomplete, length:', reportData.length);
                }
                
                // Get serial numbers for the selected vehicle from loaded data
                const vehicleSerials = [];
                
                if (reportData && reportData.length > 0) {
                    // Find all records for this vehicle
                    const vehicleRecords = reportData.filter(row => {
                        const vehicleNo = String(row['VEHICLE NO'] || '').trim().toUpperCase();
                        return vehicleNo === vehicleInput;
                    });
                    
                    console.log(`Found ${vehicleRecords.length} records for vehicle ${vehicleInput}`);
                    
                    // Extract base serial numbers (without decimals)
                    const baseSerials = new Set();
                    vehicleRecords.forEach(row => {
                        const serialNo = String(row['SERIAL NO'] || '').trim();
                        if (serialNo && serialNo !== '') {
                            // Extract base number (before decimal point)
                            const baseSerial = serialNo.split('.')[0];
                            if (baseSerial) {
                                baseSerials.add(baseSerial);
                            }
                        }
                    });
                    
                    // Convert Set to Array
                    vehicleSerials.push(...Array.from(baseSerials));
                    
                    console.log('Vehicle serials found:', vehicleSerials);
                    
                    // Sort in descending order (highest serial number first)
                    vehicleSerials.sort((a, b) => {
                        const numA = parseInt(a) || 0;
                        const numB = parseInt(b) || 0;
                        return numB - numA;
                    });
                    
                    console.log('Sorted vehicle serials:', vehicleSerials);
                }
                
                // Filter based on coil serial input if provided
                let filteredSerials = vehicleSerials;
                if (coilSerialInput.length > 0) {
                    filteredSerials = vehicleSerials.filter(serial => 
                        serial.toLowerCase().includes(coilSerialInput.toLowerCase())
                    );
                }
                
                if (filteredSerials.length > 0) {
                    suggestions.innerHTML = filteredSerials.map(serial => 
                        `<div onclick="selectCoilSerialSuggestion('${serial}')">${serial}</div>`
                    ).join('');
                    suggestions.style.display = 'block';
                } else {
                    console.log('No filtered serials to show');
                    suggestions.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error in showCoilSerialSuggestions:', error);
                suggestions.style.display = 'none';
            }
        }

        function selectCoilSerialSuggestion(serialGroup) {
            document.getElementById('coilSerialInput').value = serialGroup;
            document.getElementById('coilSerialSuggestions').style.display = 'none';
        }

        function addCoilToVehicle() {
            const vehicleInput = document.getElementById('vehicleInput');
            const coilInput = document.getElementById('coilInput');
            
            vehicleInput.disabled = true;
            
            const coil = coilInput.value.trim().toUpperCase();
            const vehicle = vehicleInput.value.trim().toUpperCase();
            
            if (!coil || !vehicle) {
                showMessage('Please enter both coil and vehicle number', 'error');
                vehicleInput.disabled = false;
                return;
            }
            
            // Check if coil is already saved in vehicleCoilMap
            let coilAlreadySaved = false;
            for (const [savedVehicle, savedCoils] of Object.entries(vehicleCoilMap)) {
                if (savedCoils.includes(coil)) {
                    showMessage(`⚠️ WARNING: Coil ${coil} is already saved for vehicle ${savedVehicle}`, 'error');
                    vehicleInput.disabled = false;
                    return;
                }
            }
            
            // Check if coil is already added in current session
            const coilAlreadyAdded = addedCoils.some(item => item.coilNumber === coil);
            if (coilAlreadyAdded) {
                showMessage(`⚠️ WARNING: Coil ${coil} is already added to the current list`, 'error');
                vehicleInput.disabled = false;
                return;
            }
            
            addedCoils.push({ coilNumber: coil, vehicleNumber: vehicle });
            updateAddedCoilsDisplay();
            
            coilInput.value = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            
            showMessage('Coil added to vehicle successfully', 'success');
        }

        function updateAddedCoilsDisplay() {
            const div = document.getElementById('addedCoils');
            if (addedCoils.length === 0) {
                div.innerHTML = '';
                return;
            }
            
            // Calculate total gross weight
            let totalGrossWeight = 0;
            addedCoils.forEach(item => {
                const coilDetails = findCoilDetails(item.coilNumber);
                if (coilDetails) {
                    const grossWeightKey = Object.keys(coilDetails).find(key => 
                        key.trim().toUpperCase() === 'GROSS WT' || 
                        key.trim().toUpperCase() === 'GROSS WEIGHT' ||
                        key.trim().toUpperCase().includes('GROSS')
                    );
                    if (grossWeightKey) {
                        const weight = parseFloat(coilDetails[grossWeightKey]) || 0;
                        totalGrossWeight += weight;
                    }
                }
            });
            
            let html = `<h3>Added Coils: | Total G.WT : ${(totalGrossWeight/1000).toFixed(3)}</h3>`;
            addedCoils.forEach((item, index) => {
                html += `<div style="background: rgba(255,255,255,0.1); padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                  <span>${item.coilNumber} → ${item.vehicleNumber}</span>
                  <button onclick="removeCoil(${index})" style="padding: 2px 4px; font-size: 9px; background: #e74c3c; color: white; border: none; border-radius: 2px; cursor: pointer; min-width: 45px;">Remove</button>
                </div>`;
            });
            div.innerHTML = html;
        }

        function removeCoil(index) {
            addedCoils.splice(index, 1);
            updateAddedCoilsDisplay();
        }

        function updateVehicleCountDisplay() {
            const vehicleCount = Object.keys(vehicleCoilMap).length;
            const totalCoils = Object.values(vehicleCoilMap).reduce((sum, coils) => sum + coils.length, 0);
            
            let countDisplay = document.getElementById('vehicleCountDisplay');
            if (!countDisplay) {
                countDisplay = document.createElement('div');
                countDisplay.id = 'vehicleCountDisplay';
                countDisplay.className = 'vehicle-count';
                
                // Insert after the addedCoils div
                const addedCoilsDiv = document.getElementById('addedCoils');
                if (addedCoilsDiv) {
                    addedCoilsDiv.parentNode.insertBefore(countDisplay, addedCoilsDiv.nextSibling);
                }
            }
            
            countDisplay.innerHTML = `
                <div style="text-align: center; font-size: 16px; margin: 10px 0;">
                    <strong>Shipment Summary:</strong><br>
                    Vehicles Used: ${vehicleCount} | Total Coils: ${totalCoils} | Current Group: ${currentGroupNumber}
                </div>
            `;
        }

        async function saveVehicleCoils() {
            if (!addedCoils.length) {
                showMessage('No coils to save', 'error');
                return;
            }
            
            console.log('Save button clicked - checking generated text data:', generatedTextData.length, 'reports available');
            
            try {
                // Assign group number to vehicles if not already assigned
                const vehiclesInBatch = [...new Set(addedCoils.map(item => item.vehicleNumber))];
                vehiclesInBatch.forEach(vehicleNumber => {
                    if (!vehicleSerialGroupMap[vehicleNumber]) {
                        // Check if this vehicle already has coils in the system
                        const existingCoilsForVehicle = vehicleCoilMap[vehicleNumber] ? vehicleCoilMap[vehicleNumber].length : 0;
                        
                        if (existingCoilsForVehicle === 0) {
                            // New vehicle, assign next group number
                            currentGroupNumber++; // Move to next group for new vehicle
                            vehicleSerialGroupMap[vehicleNumber] = currentGroupNumber;
                            console.log(`Assigned new group ${currentGroupNumber} to vehicle ${vehicleNumber}`);
                        } else {
                            // This vehicle has existing coils, need to find its group from existing data
                            // For now, assign current group (this should be handled by loadOutDataForSerial)
                            vehicleSerialGroupMap[vehicleNumber] = currentGroupNumber;
                        }
                        
                        localStorage.setItem('currentGroupNumber', currentGroupNumber);
                        localStorage.setItem('vehicleSerialGroupMap', JSON.stringify(vehicleSerialGroupMap));
                    }
                });
                
                // Generate OUT entries for storage
                const now = new Date();
                const currentDate = now.toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = now.toLocaleTimeString('en-US', { hour12: true });
                const outEntries = [];
                
                // Process only the newly added coils for storage
                let vehicleCoilCounter = {}; // Counter for coils per vehicle in this batch
                
                // Initialize counters based on existing coils for each vehicle (BEFORE adding current batch)
                addedCoils.forEach(({ vehicleNumber }) => {
                    if (!vehicleCoilCounter[vehicleNumber]) {
                        // Count existing coils for this vehicle to continue numbering properly
                        const existingCoilsForVehicle = vehicleCoilMap[vehicleNumber] ? vehicleCoilMap[vehicleNumber].length : 0;
                        vehicleCoilCounter[vehicleNumber] = existingCoilsForVehicle;
                    }
                });
                
                addedCoils.forEach(({ coilNumber, vehicleNumber }) => {
                    vehicleCoilCounter[vehicleNumber]++;
                    
                    // Get group number and create serial number (e.g., 8.1, 8.2, 8.3, then 9.1, 9.2, etc.)
                    const groupNumber = vehicleSerialGroupMap[vehicleNumber];
                    const serialNumber = `${groupNumber}.${vehicleCoilCounter[vehicleNumber]}`;
                    
                    // Add serial number to coil data
                    const coilIndex = addedCoils.findIndex(item => item.coilNumber === coilNumber && item.vehicleNumber === vehicleNumber);
                    if (coilIndex !== -1) {
                        addedCoils[coilIndex].serialNumber = serialNumber;
                    }
                    // Find transporter for this vehicle
                    let transporter = '';
                    if (vehicleData.length > 0) {
                        const vehicleColumnKey = Object.keys(vehicleData[0]).find(key => 
                            key.trim().toUpperCase().includes('VEHICLE NO')
                        );
                        
                        const transporterColumnKey = Object.keys(vehicleData[0]).find(key => 
                            key.trim().toUpperCase().includes('TRANSPORTER')
                        );
                        
                        if (vehicleColumnKey && transporterColumnKey) {
                            const vehicleRecord = vehicleData.find(row => 
                                String(row[vehicleColumnKey]).trim().toUpperCase() === vehicleNumber
                            );
                            if (vehicleRecord) {
                                transporter = vehicleRecord[transporterColumnKey] || '';
                            }
                        }
                    }
                    
                    // Find coil details to get gross weight
                    const details = findCoilDetails(coilNumber);
                    let grossWeight = '';
                    
                    if (details) {
                        // Look for gross weight column
                        const grossWeightKey = Object.keys(details).find(key => 
                            key.trim().toUpperCase().includes('GROSS') && 
                            key.trim().toUpperCase().includes('WT')
                        );
                        if (grossWeightKey) {
                            grossWeight = details[grossWeightKey] || '';
                        }
                    }
                    
                    const outEntry = {
                        'SERIAL NO': serialNumber,
                        'DATE & TIME': `${currentDate} ${currentTime}`,
                        'VEHICLE NO': vehicleNumber,
                        'MILL COIL NO': coilNumber,
                        'TRANSPORTER': transporter || 'MPT',
                        'GROSS WT': grossWeight
                    };
                    outEntries.push(outEntry);
                });
                
                // Now move current coils to saved map (AFTER serial number calculation)
                addedCoils.forEach(({ coilNumber, vehicleNumber }) => {
                    if (!vehicleCoilMap[vehicleNumber]) vehicleCoilMap[vehicleNumber] = [];
                    vehicleCoilMap[vehicleNumber].push(coilNumber);
                });
                
                // Store data locally and save to Google Sheets
                console.log('=== SAVE OPERATION DEBUG ===');
                console.log('OUT entries to process:', outEntries.length);
                console.log('Added coils count:', addedCoils.length);
                console.log('Sample OUT entry:', outEntries[0]);
                
                if (outEntries.length > 0) {
                    try {
                        // Store in local outData array for app functionality
                        if (!outData) outData = [];
                        outData = [...outData, ...outEntries];
                        
                        // Always generate fresh text reports from the new OUT data during save
                        console.log('Generating fresh text reports from current save operation with', outEntries.length, 'OUT entries');
                        showMessage('Generating text reports...', 'info');
                        
                        // Clear any existing text data for this save operation
                        const existingTextCount = generatedTextData.length;
                        if (existingTextCount > 0) {
                            console.log('Clearing', existingTextCount, 'existing text reports to generate fresh ones');
                        }
                        generatedTextData = []; // Clear existing to generate fresh reports
                        
                        await generateTextReportsFromOutEntries(outEntries);
                        console.log('Fresh text reports generated:', generatedTextData.length, 'reports');
                        if (generatedTextData.length > 0) {
                            showMessage(`Generated ${generatedTextData.length} text reports successfully. Saving directly to Google Sheets...`, 'info');
                        } else {
                            console.error('No text reports were generated despite having', outEntries.length, 'OUT entries');
                        }
                        
                        // Save directly to Google Sheets (no local storage)
                        try {
                            const { spreadsheetId, apiKey, webAppUrl } = window.googleSheetsAPI.getCredentials();
                            if (!spreadsheetId) {
                                throw new Error('Google Sheets not configured. Please connect to Google Sheets first.');
                            }
                            
                            if (!webAppUrl || webAppUrl.includes('YOUR_SCRIPT_ID')) {
                                throw new Error('Google Apps Script Web App URL not configured. Please add your Apps Script URL in the Google Sheets Management section.');
                            }
                            
                            showMessage('Uploading to Google Sheets...', 'info');
                            
                            // Get available sheets to find OUT sheet
                            const sheetNames = await window.googleSheetsAPI.getSheetNames();
                            let outSheetName = sheetNames.find(name => 
                                name.toLowerCase().includes('out') || 
                                name.toLowerCase().includes('output')
                            ) || 'OUT';
                            
                            // Upload OUT data to Google Sheets directly
                            console.log(`Uploading ${outEntries.length} OUT entries to Google Sheets (${outSheetName})`);
                            await window.googleSheetsAPI.appendToSheet(outSheetName, outEntries, false);
                            
                            // Primary focus: Save OUT data to Google Sheets
                            showMessage(`✅ SUCCESS: ${outEntries.length} OUT entries saved to Google Sheets (${outSheetName})!`, 'success');
                            console.log(`Successfully uploaded ${outEntries.length} entries to Google Sheets`);
                            
                            // Clear generated text data after successful OUT upload
                            generatedTextData = [];
                            
                        } catch (sheetsError) {
                            console.error('Google Sheets upload failed:', sheetsError);
                            
                            // Show manual export option as fallback
                            const shouldExport = confirm(`Google Sheets save failed: ${sheetsError.message}\n\nWould you like to download the data as an Excel file instead?`);
                            
                            if (shouldExport) {
                                try {
                                    // Export as Excel file
                                    const wb = XLSX.utils.book_new();
                                    const ws = XLSX.utils.json_to_sheet(outEntries);
                                    XLSX.utils.book_append_sheet(wb, ws, 'OUT Data');
                                    
                                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                                    const filename = `OUT_Data_${timestamp}.xlsx`;
                                    
                                    XLSX.writeFile(wb, filename);
                                    showMessage(`✅ Data exported as ${filename}. Please upload this file to your Google Sheets manually.`, 'success');
                                    console.log(`Exported ${outEntries.length} records to ${filename}`);
                                } catch (exportError) {
                                    console.error('Export failed:', exportError);
                                    showMessage('Export failed: ' + exportError.message, 'error');
                                }
                            } else {
                                showMessage('Data save cancelled. Data remains in local memory until refresh.', 'warning');
                            }
                            
                            // Don't throw error since we handled the fallback
                            return;
                        }
                        
                    } catch (error) {
                        console.error('Failed to save data:', error);
                        showMessage('Warning: Failed to save data - ' + error.message, 'error');
                        return; // Don't proceed if save fails
                    }
                }
                
                // Group number already incremented when assigning to new vehicles
                
                addedCoils = [];
                updateAddedCoilsDisplay();
                
                // Update vehicle count display
                updateVehicleCountDisplay();
                
                // Clear vehicle input after saving
                const vehicleInput = document.getElementById('vehicleInput');
                if (vehicleInput) {
                    vehicleInput.value = '';
                    vehicleInput.disabled = false;
                }
                
                // Hide vehicle suggestions
                document.getElementById('vehicleSuggestions').style.display = 'none';
                
                // Update button states
                const generateBtn = document.getElementById('generateBtn');
                const addBtn = document.getElementById('addBtn');
                const saveBtn = document.getElementById('saveBtn');
                
                if (generateBtn) generateBtn.disabled = false;
                if (addBtn) addBtn.disabled = true;
                if (saveBtn) saveBtn.disabled = true;
                
                // Hide clear vehicle button
                toggleVehicleClearButton();
                
            } catch (error) {
                console.error('Error saving vehicle coils:', error);
                showMessage('Error saving vehicle coils: ' + error.message, 'error');
            }
        }

        // Enhanced generateTextFile function with proper storage permissions
        // Helper function to generate text reports from fresh OUT entries during save
        async function generateTextReportsFromOutEntries(outEntries) {
            try {
                console.log('=== STARTING TEXT REPORT GENERATION ===');
                console.log('Input OUT entries:', outEntries.length);
                console.log('Sample OUT entry:', outEntries[0]);
                
                const now = new Date();
                const currentDate = now.toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = now.toLocaleTimeString('en-US', { hour12: true });
                
                console.log('Generating text reports from', outEntries.length, 'OUT entries');
                
                // Group OUT entries by vehicle
                const vehicleCoilData = {};
                outEntries.forEach(entry => {
                    const vehicle = entry['VEHICLE NO'];
                    if (vehicle) {
                        if (!vehicleCoilData[vehicle]) {
                            vehicleCoilData[vehicle] = [];
                        }
                        vehicleCoilData[vehicle].push(entry);
                    }
                });
                
                console.log('Grouped by vehicles:', Object.keys(vehicleCoilData));
                
                // Generate text reports for each vehicle
                for (const [vehicle, vehicleOutData] of Object.entries(vehicleCoilData)) {
                    const transporter = vehicleOutData[0]['TRANSPORTER'] || 'N/A';
                    const totalGrossWeight = vehicleOutData.reduce((sum, row) => {
                        return sum + (parseFloat(row['GROSS WT']) || 0);
                    }, 0);
                    
                    // Generate detailed content for storage
                    let content = `Text Report - ${vehicle}\nGenerated on: ${currentDate} ${currentTime}\nVessel: ${vesselName}\nTransporter: ${transporter}\nTotal Coils: ${vehicleOutData.length}\nTotal Gross Weight: ${totalGrossWeight.toFixed(2)}\n\nCoil Details:\n`;
                    
                    vehicleOutData.forEach(row => {
                        content += `${row['SERIAL NO']} | ${row['DATE & TIME']} | ${row['VEHICLE NO']} | ${row['MILL COIL NO']} | ${row['GROSS WT']}\n`;
                    });
                    
                    // Store generated text data for Google Sheets upload
                    const textReportEntry = {
                        'Vehicle No': vehicle,
                        'Report Date': currentDate,
                        'Report Time': currentTime,
                        'Vessel Name': vesselName,
                        'Transporter': transporter,
                        'Total Coils': vehicleOutData.length,
                        'Total Gross Weight': totalGrossWeight.toFixed(2),
                        'Report Content': content,
                        'Generated During': 'Save Operation'
                    };
                    generatedTextData.push(textReportEntry);
                    console.log(`Generated text report for vehicle: ${vehicle} (${vehicleOutData.length} coils, ${totalGrossWeight.toFixed(2)} total weight)`);
                }
                
                console.log(`Generated ${generatedTextData.length} text reports from OUT entries`);
                
            } catch (error) {
                console.error('Error generating text reports from OUT entries:', error);
                // Don't throw error, just log it so save can continue
            }
        }

        // Helper function to generate text reports during save without showing modal
        async function generateTextReportsForSave() {
            try {
                const now = new Date();
                const currentDate = now.toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = now.toLocaleTimeString('en-US', { hour12: true });
                
                // Always use OUT data to generate text report
                let allOutData = outData || [];
                console.log('Current outData for text generation:', allOutData.length, 'entries');
                
                // If local outData is empty, try to get from Google Sheets
                if (allOutData.length === 0) {
                    try {
                        console.log('Local outData is empty, trying to load from Google Sheets...');
                        allOutData = await window.googleSheetsAPI.loadOutData();
                        console.log('Loaded from Google Sheets:', allOutData.length, 'entries');
                    } catch (error) {
                        console.error('Error loading Google Sheets OUT data for text generation:', error);
                        // Continue with empty data if loading fails
                        allOutData = [];
                    }
                }
                
                if (allOutData.length === 0) {
                    console.log('No OUT data found to generate text report during save - this is expected if no coils have been processed yet');
                    return;
                }
                
                // Group OUT data by vehicle
                const vehicleCoilData = {};
                allOutData.forEach(entry => {
                    const vehicle = entry['VEHICLE NO'];
                    if (vehicle) {
                        if (!vehicleCoilData[vehicle]) {
                            vehicleCoilData[vehicle] = [];
                        }
                        vehicleCoilData[vehicle].push(entry);
                    }
                });
                
                // Generate text reports for each vehicle (without showing modal)
                for (const [vehicle, vehicleOutData] of Object.entries(vehicleCoilData)) {
                    const transporter = vehicleOutData[0]['TRANSPORTER'] || 'N/A';
                    const totalGrossWeight = vehicleOutData.reduce((sum, row) => {
                        return sum + (parseFloat(row['GROSS WT']) || 0);
                    }, 0);
                    
                    // Generate simplified content for storage
                    let content = `Text Report - ${vehicle}\nGenerated on: ${currentDate} ${currentTime}\nVessel: ${vesselName}\nTransporter: ${transporter}\nTotal Coils: ${vehicleOutData.length}\nTotal Gross Weight: ${totalGrossWeight.toFixed(2)}\n\nCoil Details:\n`;
                    
                    vehicleOutData.forEach(row => {
                        content += `${row['SERIAL NO']} | ${row['DATE & TIME']} | ${row['VEHICLE NO']} | ${row['MILL COIL NO']} | ${row['GROSS WT']}\n`;
                    });
                    
                    // Store generated text data for Google Sheets upload
                    const textReportEntry = {
                        'Vehicle No': vehicle,
                        'Report Date': currentDate,
                        'Report Time': currentTime,
                        'Vessel Name': vesselName,
                        'Transporter': transporter,
                        'Total Coils': vehicleOutData.length,
                        'Total Gross Weight': totalGrossWeight.toFixed(2),
                        'Report Content': content,
                        'Generated During': 'Save Operation'
                    };
                    generatedTextData.push(textReportEntry);
                }
                
                console.log(`Generated ${generatedTextData.length} text reports during save operation`);
                
            } catch (error) {
                console.error('Error generating text reports during save:', error);
                // Don't throw error, just log it so save can continue
            }
        }

        async function generateTextFile() {
            try {
                // Request storage permission first
                if (window.permissionManager && !window.permissionManager.areStoragePermissionsGranted()) {
                    const granted = await window.permissionManager.requestStoragePermission();
                    if (!granted) {
                        showMessage('Storage permission is required to save files', 'error');
                        return;
                    }
                }
                
                const vehicleInput = document.getElementById('vehicleInput');
                if (vehicleInput) {
                    vehicleInput.disabled = false;
                }
                
                const now = new Date();
                const currentDate = now.toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = now.toLocaleTimeString('en-US', { hour12: true });
                
                // Always use OUT data to generate text report
                let allOutData = outData || [];
                
                // If local outData is empty, try to get from Google Sheets
                if (allOutData.length === 0) {
                    try {
                        allOutData = await window.googleSheetsAPI.loadOutData();
                    } catch (error) {
                        console.error('Error loading Google Sheets OUT data:', error);
                        showMessage('Error loading OUT data: ' + error.message, 'error');
                        return;
                    }
                }
                
                if (allOutData.length === 0) {
                    showMessage('No OUT data found to generate text report', 'error');
                    return;
                }
                
                // Group OUT data by vehicle
                const vehicleCoilData = {};
                allOutData.forEach(entry => {
                    const vehicle = entry['VEHICLE NO'];
                    if (vehicle) {
                        if (!vehicleCoilData[vehicle]) {
                            vehicleCoilData[vehicle] = [];
                        }
                        vehicleCoilData[vehicle].push(entry);
                    }
                });
                
                // Generate separate file for each vehicle
                for (const [vehicle, vehicleOutData] of Object.entries(vehicleCoilData)) {
                    // Get transporter from first record (assuming all records have same transporter)
                    const transporter = vehicleOutData[0]['TRANSPORTER'] || 'N/A';
                    
                    // Calculate total gross weight
                    const totalGrossWeight = vehicleOutData.reduce((sum, row) => {
                        return sum + (parseFloat(row['GROSS WT']) || 0);
                    }, 0);
                    
                    // Generate HTML table format matching All OUT Data report
                    let content = `<div style="font-family: Arial, sans-serif; padding: 10px;">
                        <h3 style="text-align: center; margin-bottom: 5px;">A.S.Shipping Agencies Pvt Ltd,</h3>
                        <h4 style="text-align: center; margin-top: 0;">(Greenways Group)</h4>
                        <h4 style="text-align: center; margin-top: 0; color: #2c3e50;">Vessel Name : ${vesselName}</h4>
                        <h3 style="text-align: center; color: #2c3e50;">TEXT REPORT - ${vehicle}</h3>
                        <p style="text-align: center; margin: 5px 0;">Generated on: ${currentDate} ${currentTime}</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #3498db; color: white;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 10%;">Serial No</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 20%;">Date & Time</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Transporter</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Vehicle No</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 25%;">Coil No</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Gross WT</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    // Add data rows with alternating colors
                    vehicleOutData.forEach((row, index) => {
                        const bgColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';
                        content += `<tr style="background-color: ${bgColor};">
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['SERIAL NO'] || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['DATE & TIME'] || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['TRANSPORTER'] || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['VEHICLE NO'] || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['MILL COIL NO'] || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${row['GROSS WT'] || ''}</td>
                        </tr>`;
                    });
                    
                    content += `</tbody>
                            <tfoot>
                                <tr style="background-color: #2c3e50; color: white; font-weight: bold;">
                                    <td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">SUMMARY</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">Total: ${vehicleOutData.length}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalGrossWeight.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div style="margin-top: 20px; padding: 10px; background-color: #ecf0f1; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0;">Summary:</h4>
                            <p style="margin: 5px 0;"><strong>Total Records:</strong> ${vehicleOutData.length}</p>
                            <p style="margin: 5px 0;"><strong>Total Coils:</strong> ${vehicleOutData.length}</p>
                            <p style="margin: 5px 0;"><strong>Total Gross Weight:</strong> ${totalGrossWeight.toFixed(2)}</p>
                        </div>
                    </div>`;
                    
                    // Always show in modal for better display of HTML table content
                    showReportInModal(`Text Report - ${vehicle}`, content);
                    
                    // Store generated text data for Google Sheets upload
                    const textReportEntry = {
                        'Vehicle No': vehicle,
                        'Report Date': currentDate,
                        'Report Time': currentTime,
                        'Vessel Name': vesselName,
                        'Transporter': transporter,
                        'Total Coils': vehicleOutData.length,
                        'Total Gross Weight': totalGrossWeight.toFixed(2),
                        'Report Content': content.replace(/<[^>]*>/g, ''), // Strip HTML tags for plain text
                        'HTML Content': content // Keep HTML version for formatted display
                    };
                    generatedTextData.push(textReportEntry);
                }
                
                // Note: Google Sheets storage is now handled by the Save Button
                
                // Reset for next operation
                vehicleCoilMap = {};
                const generateBtn = document.getElementById('generateBtn');
                const addBtn = document.getElementById('addBtn');
                const saveBtn = document.getElementById('saveBtn');
                
                if (generateBtn) generateBtn.disabled = true;
                if (addBtn) addBtn.disabled = false;
                if (saveBtn) saveBtn.disabled = false;
                
                console.log(`Generated ${generatedTextData.length} text reports ready for upload`);
                showMessage('Text reports generated successfully. Click Save to upload to Google Sheets.', 'success');
                
            } catch (error) {
                console.error('Error generating text file:', error);
                showMessage('Error generating text file: ' + error.message, 'error');
            }
        }

        async function saveTextFile(content, fileName) {
            try {
                // Test if we can create download links (this fails in many APK environments)
                const testBlob = new Blob(['test'], { type: 'text/plain' });
                const testUrl = URL.createObjectURL(testBlob);
                const testLink = document.createElement('a');
                
                // If download attribute is not supported or URL creation fails, we're likely in APK
                if (!testLink.download || testUrl.startsWith('blob:null')) {
                    URL.revokeObjectURL(testUrl);
                    throw new Error('Download not supported in this environment');
                }
                
                URL.revokeObjectURL(testUrl);
                
                // Create blob and download
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log(`Text file ${fileName} saved successfully`);
            } catch (error) {
                console.error('Error saving text file:', error);
                throw error;
            }
        }

        function findCoilDetails(coilNumber) {
            if (coilData.length === 0) return null;
            
            const matchKey = Object.keys(coilData[0]).find(key => 
                key.trim().toUpperCase() === 'MILL COIL NO' || 
                key.trim().toUpperCase() === 'COIL NO' ||
                key.trim().toUpperCase().includes('MILL COIL')
            );
            
            if (!matchKey) return null;
            
            return coilData.find(row => 
                String(row[matchKey]).trim().toUpperCase() === coilNumber.trim().toUpperCase()
            );
        }

        function showReportVehicleSuggestions() {
            const input = document.getElementById('reportVehicleInput').value.trim().toUpperCase();
            const suggestions = document.getElementById('reportVehicleSuggestions');
            
            if (input.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const matches = vehicleData.filter(row => {
                const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
            }).slice(0, 10);
            
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(row => {
                    const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
                    return `<div onclick="selectReportVehicleSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
                }).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        function selectReportVehicleSuggestion(vehicleNumber) {
            document.getElementById('reportVehicleInput').value = vehicleNumber;
            document.getElementById('reportVehicleSuggestions').style.display = 'none';
            toggleReportVehicleClearButton();
        }

        function toggleReportVehicleClearButton() {
            const input = document.getElementById('reportVehicleInput').value.trim();
            const clearBtn = document.getElementById('clearReportVehicleBtn');
            if (clearBtn) {
                clearBtn.style.display = input ? 'block' : 'none';
            }
        }

        function clearReportVehicleInput() {
            document.getElementById('reportVehicleInput').value = '';
            document.getElementById('coilSerialInput').value = '';
            document.getElementById('reportVehicleSuggestions').style.display = 'none';
            document.getElementById('coilSerialSuggestions').style.display = 'none';
            toggleReportVehicleClearButton();
        }

        // Calculate and update shipment summary statistics
        async function updateShipmentSummary() {
            try {
                // Get fresh data from all sources
                let outData = [];
                let pnrData = coilData; // Use the global coilData variable
                
                try {
                    // Load OUT data
                    outData = await window.googleSheetsAPI.loadOutData();
                } catch (error) {
                    console.error('Error loading OUT data for shipment summary:', error);
                    return;
                }
                
                // Calculate statistics
                const totalVehicles = new Set(outData.map(row => 
                    String(row['VEHICLE NO'] || '').trim().toUpperCase()
                ).filter(v => v)).size;
                
                const totalCoils = outData.length;
                
                const totalPnrCoils = pnrData.length;
                const balanceCoils = totalPnrCoils - totalCoils;
                
                const uniqueTransporters = new Set(outData.map(row => 
                    String(row['TRANSPORTER'] || '').trim()
                ).filter(t => t)).size;
                
                // Update UI
                document.getElementById('totalVehicles').textContent = `Vehicles Used: ${totalVehicles}`;
                document.getElementById('totalCoils').textContent = `Loaded Coils: ${totalCoils}`;
                document.getElementById('balanceCoils').textContent = `Balance Coils: ${balanceCoils}`;
                document.getElementById('usedTransporter').textContent = `Used Transporter: ${uniqueTransporters}`;
                
                // Show the summary section
                document.getElementById('shipmentSummary').style.display = 'block';
                
                console.log('Shipment summary updated:', {
                    totalVehicles,
                    totalCoils,
                    totalPnrCoils,
                    balanceCoils,
                    uniqueTransporters
                });
                
            } catch (error) {
                console.error('Error updating shipment summary:', error);
            }
        }

        // Enhanced APK Detection Function
        function isRunningInAPK() {
            // Multiple detection methods for different APK builders
            return (
                // Cordova/PhoneGap detection
                typeof cordova !== 'undefined' ||
                typeof window.cordova !== 'undefined' ||
                // WebView detection
                typeof window.AndroidInterface !== 'undefined' ||
                typeof window.webkit !== 'undefined' ||
                // User agent detection for WebView
                navigator.userAgent.includes('wv') ||
                navigator.userAgent.includes('Android') && navigator.userAgent.includes('Version/') ||
                // App protocol detection
                window.location.protocol === 'file:' ||
                // Origin detection for APK
                window.location.origin === 'null' ||
                window.location.hostname === '' ||
                // Additional WebView indicators
                window.navigator.standalone ||
                window.matchMedia('(display-mode: standalone)').matches ||
                // Check if download attribute doesn't work (APK limitation)
                !document.createElement('a').download === undefined
            );
        }

        // APK-Compatible Report Functions - ENHANCED APK DETECTION  
        async function generateAllOutDataReport(event) {
            try {
                // Prevent any default form submission or page refresh
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                showMessage('Generating all OUT data report...', 'info');
                
                // Force data reload to ensure we have the latest data
                let reportData = [];
                
                // First try to get fresh data from Google Sheets/local storage
                try {
                    console.log('Loading fresh data...');
                    reportData = await window.googleSheetsAPI.loadOutData();
                    console.log('Data loaded, valid records:', reportData.length);
                    
                    // Update local outData with fresh data
                    outData = reportData;
                    
                    // Debug logging for discrepancy investigation
                    console.log('Report data sample (first 3 records):', reportData.slice(0, 3));
                    console.log('Report data sample (last 3 records):', reportData.slice(-3));
                    
                } catch (error) {
                    console.error('Error loading OUT data:', error);
                    // Fallback to local data if loading fails
                    reportData = outData || [];
                    console.log('Using local outData as fallback, length:', reportData.length);
                }
                
                console.log('Final reportData for All OUT Report:', reportData.length, 'records');
                console.log('Sample data:', reportData.slice(0, 3));
                
                if (reportData.length === 0) {
                    showMessage('⚠️ WARNING: No OUT data found to generate report', 'error');
                    return;
                }
                
                // Generate Excel-like HTML table format report
                const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = new Date().toLocaleTimeString('en-US', { hour12: true });
                
                let content = `<div style="font-family: Arial, sans-serif; padding: 10px;">
                    <h3 style="text-align: center; margin-bottom: 5px;">A.S.Shipping Agencies Pvt Ltd,</h3>
                    <h4 style="text-align: center; margin-top: 0;">(Greenways Group)</h4>
                    <h4 style="text-align: center; margin-top: 0; color: #2c3e50;">Vessel Name : ${vesselName}</h4>
                    <h3 style="text-align: center; color: #2c3e50;">ALL OUT DATA REPORT</h3>
                    <p style="text-align: center; margin: 5px 0;">Generated on: ${currentDate} ${currentTime}</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px;">
                        <thead>
                            <tr style="background-color: #3498db; color: white;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 10%;">Serial No</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 20%;">Date & Time</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Transporter</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Vehicle No</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 25%;">Coil No</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Gross WT</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                // Data rows with alternating colors
                reportData.forEach((row, index) => {
                    const bgColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';
                    content += `<tr style="background-color: ${bgColor};">
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['DATE & TIME'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['TRANSPORTER'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['VEHICLE NO'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['MILL COIL NO'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${row['GROSS WT'] || ''}</td>
                    </tr>`;
                });
                
                // Calculate total gross weight
                const totalGrossWT = reportData.reduce((sum, row) => {
                    return sum + (parseFloat(row['GROSS WT']) || 0);
                }, 0);
                
                content += `</tbody>
                        <tfoot>
                            <tr style="background-color: #2c3e50; color: white; font-weight: bold;">
                                <td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">SUMMARY</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">Total: ${reportData.length}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalGrossWT.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 20px; padding: 10px; background-color: #ecf0f1; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0;">Summary:</h4>
                        <p style="margin: 5px 0;"><strong>Total Records:</strong> ${reportData.length}</p>
                        <p style="margin: 5px 0;"><strong>Total Coils:</strong> ${reportData.length}</p>
                        <p style="margin: 5px 0;"><strong>Total Gross Weight:</strong> ${totalGrossWT.toFixed(2)}</p>
                    </div>
                </div>`;
                
                console.log('Final report content length:', content.length);
                console.log('Report data used:', reportData.length, 'records');
                
                // Store report data for PDF generation
                sessionStorage.setItem('currentReportData', JSON.stringify(reportData));
                
                // Always show in modal for better display of HTML table content
                showReportInModal('All OUT Data Report', content);
                
                showMessage(`All OUT data report generated successfully - ${reportData.length} records`, 'success');
                
            } catch (error) {
                console.error('Error generating all OUT data report:', error);
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        async function generateVehicleOutReport() {
            try {
                const vehicleNumber = document.getElementById('reportVehicleInput').value.trim().toUpperCase();
                const coilSerial = document.getElementById('coilSerialInput').value.trim();
                
                if (!vehicleNumber) {
                    showMessage('Please enter a vehicle number', 'error');
                    return;
                }
                
                showMessage('Generating vehicle report...', 'info');
                
                // Use local outData if available, otherwise try to get from Google Sheets
                let allOutData = outData || [];
                
                if (allOutData.length === 0) {
                    try {
                        allOutData = await window.googleSheetsAPI.loadOutData();
                    } catch (error) {
                        console.error('Error loading Google Sheets OUT data:', error);
                        // Continue with empty data if both local and Google Sheets fail
                    }
                }
                
                let vehicleOutData = allOutData.filter(row => 
                    String(row['VEHICLE NO']).trim().toUpperCase() === vehicleNumber
                );
                
                // Filter by coil serial number if specified
                if (coilSerial) {
                    vehicleOutData = vehicleOutData.filter(row => {
                        const serialNo = String(row['SERIAL NO'] || '').trim();
                        // Match exact serial number or partial match
                        return serialNo === coilSerial || serialNo.includes(coilSerial);
                    });
                    
                    if (vehicleOutData.length === 0) {
                        showMessage(`⚠️ WARNING: No coils found with serial number ${coilSerial} for vehicle ${vehicleNumber}`, 'error');
                        return;
                    }
                }
                
                if (vehicleOutData.length === 0) {
                    showMessage(`⚠️ WARNING: No OUT data found for vehicle ${vehicleNumber}`, 'error');
                    return;
                }
                
                // Generate HTML table format matching All OUT Data report
                const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = new Date().toLocaleTimeString('en-US', { hour12: true });
                
                // Get transporter from first record (assuming all records have same transporter)
                const transporter = vehicleOutData[0]['TRANSPORTER'] || 'N/A';
                
                // Calculate total gross weight
                const totalGrossWT = vehicleOutData.reduce((sum, row) => {
                    return sum + (parseFloat(row['GROSS WT']) || 0);
                }, 0);
                
                let content = `<div style="font-family: Arial, sans-serif; padding: 10px;">
                    <h3 style="text-align: center; margin-bottom: 5px;">A.S.Shipping Agencies Pvt Ltd,</h3>
                    <h4 style="text-align: center; margin-top: 0;">(Greenways Group)</h4>
                    <h4 style="text-align: center; margin-top: 0; color: #2c3e50;">Vessel Name : ${vesselName}</h4>
                    <h3 style="text-align: center; color: #2c3e50;">GENERATE VEHICLE REPORT - ${vehicleNumber}${coilSerial ? ` (Serial: ${coilSerial})` : ''}</h3>
                    <p style="text-align: center; margin: 5px 0;">Generated on: ${currentDate} ${currentTime}</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px;">
                        <thead>
                            <tr style="background-color: #3498db; color: white;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 10%;">Serial No</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 20%;">Date & Time</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Transporter</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Vehicle No</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 25%;">Coil No</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 15%;">Gross WT</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                // Add data rows with alternating colors
                vehicleOutData.forEach((row, index) => {
                    const bgColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';
                    content += `<tr style="background-color: ${bgColor};">
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['DATE & TIME'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['TRANSPORTER'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['VEHICLE NO'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${row['MILL COIL NO'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${row['GROSS WT'] || ''}</td>
                    </tr>`;
                });
                
                content += `</tbody>
                        <tfoot>
                            <tr style="background-color: #2c3e50; color: white; font-weight: bold;">
                                <td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">SUMMARY</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">Total: ${vehicleOutData.length}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalGrossWT.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 20px; padding: 10px; background-color: #ecf0f1; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0;">Summary:</h4>
                        <p style="margin: 5px 0;"><strong>Total Records:</strong> ${vehicleOutData.length}</p>
                        <p style="margin: 5px 0;"><strong>Total Coils:</strong> ${vehicleOutData.length}</p>
                        <p style="margin: 5px 0;"><strong>Total Gross Weight:</strong> ${totalGrossWT.toFixed(2)}</p>
                    </div>
                </div>`;
                
                // Always show in modal for better display
                showReportInModal(`Text Report - ${vehicleNumber}`, content);
                
                showMessage('Vehicle report generated successfully', 'success');
                
            } catch (error) {
                console.error('Error generating vehicle report:', error);
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        // APK Modal Functions - NEW FOR APK COMPATIBILITY
        function showReportInModal(title, content) {
            const modal = document.getElementById('reportModal');
            const modalTitle = document.getElementById('reportModalTitle');
            const modalContent = document.getElementById('reportModalContent');
            
            // Clear previous content first
            modalContent.innerHTML = '';
            modalTitle.textContent = '';
            
            // Use setTimeout to ensure DOM is ready
            setTimeout(() => {
                modalTitle.textContent = title;
                
                // Check if content is HTML or plain text
                if (content.includes('<table') || content.includes('<div')) {
                    modalContent.innerHTML = content;
                    modalContent.classList.remove('text-content');
                } else {
                    modalContent.textContent = content;
                    modalContent.classList.add('text-content');
                }
                
                // Ensure modal is visible and force reflow
                modal.classList.add('show');
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                
                // Force browser to recalculate layout
                modal.offsetHeight;
                
                console.log('Modal shown with content length:', content.length);
                console.log('Modal content element:', modalContent);
                console.log('Modal display style:', modal.style.display);
                
            }, 100);
        }

        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
        }

        // Print function for reports
        function printReport() {
            try {
                window.print();
                showMessage('Print dialog opened', 'success');
            } catch (error) {
                console.error('Error printing report:', error);
                showMessage('Error opening print dialog: ' + error.message, 'error');
            }
        }

        // Enhanced PDF download function for mobile/APK compatibility
        function downloadReportAsPDF() {
            try {
                const title = document.getElementById('reportModalTitle').textContent;
                const modalContent = document.getElementById('reportModalContent');
                
                // Show user feedback immediately
                const pdfBtn = document.querySelector('.report-modal-pdf');
                if (pdfBtn) {
                    pdfBtn.textContent = 'Generating...';
                    pdfBtn.disabled = true;
                    pdfBtn.classList.add('pdf-generating');
                }
                
                // Check if jsPDF is available
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    throw new Error('PDF library not loaded. Please refresh and try again.');
                }
                
                // Initialize jsPDF in landscape mode for better mobile compatibility
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // Landscape mode for tables
                
                // Add header - centered with mobile-friendly formatting
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('A.S.Shipping Agencies Pvt Ltd', 148, 20, { align: 'center' });
                doc.text('(Greenways Group)', 148, 28, { align: 'center' });
                
                // Add vessel name with gap
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                if (typeof vesselName !== 'undefined' && vesselName) {
                    doc.text(`Vessel Name : ${vesselName}`, 148, 40, { align: 'center' });
                } else {
                    doc.text('Vessel Name : N/A', 148, 40, { align: 'center' });
                }
                
                // Add title
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(title, 148, 48, { align: 'center' });
                
                // Add generation date with mobile-friendly format
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
                const currentTime = new Date().toLocaleTimeString('en-US', { hour12: true });
                doc.text(`Generated on: ${currentDate} ${currentTime}`, 148, 56, { align: 'center' });
                
                let yPosition = 69;
                
                // Generate PDF that matches the HTML table exactly with mobile optimization
                if (modalContent.innerHTML.includes('<table')) {
                    const table = modalContent.querySelector('table');
                    if (table) {
                        // Enhanced column widths for better mobile compatibility
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const availableWidth = pageWidth - 20; // Leave margins
                        const columnWidths = [
                            Math.floor(availableWidth * 0.08),  // Serial No - 8%
                            Math.floor(availableWidth * 0.18),  // Date & Time - 18%
                            Math.floor(availableWidth * 0.15),  // Transporter - 15%
                            Math.floor(availableWidth * 0.15),  // Vehicle No - 15%
                            Math.floor(availableWidth * 0.32),  // Coil No - 32%
                            Math.floor(availableWidth * 0.12)   // Gross WT - 12%
                        ];
                        
                        let xPos = 10;
                        let yPos = yPosition;
                        
                        // Draw table header with mobile-optimized styling
                        const headers = ['Serial No', 'Date & Time', 'Transporter', 'Vehicle No', 'Coil No', 'Gross WT'];
                        headers.forEach((header, index) => {
                            // Blue header background to match HTML
                            doc.setFillColor(52, 152, 219);
                            doc.rect(xPos, yPos, columnWidths[index], 8, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10); // Smaller font for mobile
                            doc.setFont(undefined, 'bold');
                            
                            // Handle text wrapping for mobile
                            const text = doc.splitTextToSize(header, columnWidths[index] - 2);
                            doc.text(text, xPos + 1, yPos + 5);
                            xPos += columnWidths[index];
                        });
                        yPos += 8;
                        
                        // Extract data from HTML table with enhanced processing
                        const rows = table.querySelectorAll('tbody tr');
                        const reportData = [];
                        
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length >= 6) {
                                reportData.push({
                                    serialNo: cells[0].textContent.trim(),
                                    dateTime: cells[1].textContent.trim(),
                                    transporter: cells[2].textContent.trim(),
                                    vehicleNo: cells[3].textContent.trim(),
                                    coilNo: cells[4].textContent.trim(),
                                    grossWT: cells[5].textContent.trim()
                                });
                            }
                        });
                        
                        // Add data rows with mobile optimization
                        reportData.forEach((row, index) => {
                            // Check if we need a new page
                            if (yPos + 8 > doc.internal.pageSize.height - 20) {
                                doc.addPage();
                                yPos = 20;
                                
                                // Re-add header on new page
                                xPos = 10;
                                headers.forEach((header, headerIndex) => {
                                    doc.setFillColor(52, 152, 219);
                                    doc.rect(xPos, yPos, columnWidths[headerIndex], 8, 'F');
                                    doc.setTextColor(255, 255, 255);
                                    doc.setFontSize(10);
                                    doc.setFont(undefined, 'bold');
                                    const text = doc.splitTextToSize(header, columnWidths[headerIndex] - 2);
                                    doc.text(text, xPos + 1, yPos + 5);
                                    xPos += columnWidths[headerIndex];
                                });
                                yPos += 8;
                            }
                            
                            xPos = 10;
                            const bgColor = index % 2 === 0 ? [249, 249, 249] : [255, 255, 255];
                            
                            // Draw cells with alternating background colors
                            const rowData = [row.serialNo, row.dateTime, row.transporter, row.vehicleNo, row.coilNo, row.grossWT];
                            rowData.forEach((cellText, cellIndex) => {
                                // Set background color
                                doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
                                doc.rect(xPos, yPos, columnWidths[cellIndex], 6, 'F');
                                
                                // Set border
                                doc.setDrawColor(221, 221, 221);
                                doc.rect(xPos, yPos, columnWidths[cellIndex], 6);
                                
                                // Set text with mobile optimization
                                doc.setTextColor(0, 0, 0);
                                doc.setFontSize(9); // Smaller font for mobile
                                doc.setFont(undefined, 'normal');
                                
                                // Handle text wrapping and trimming for mobile
                                let displayText = cellText;
                                if (displayText.length > 20 && cellIndex !== 4) { // Don't trim coil numbers
                                    displayText = displayText.substring(0, 17) + '...';
                                }
                                
                                const text = doc.splitTextToSize(displayText, columnWidths[cellIndex] - 2);
                                
                                // Add text with proper alignment
                                if (cellIndex === 5) { // Gross WT column - right align
                                    doc.text(text, xPos + columnWidths[cellIndex] - 1, yPos + 4, { align: 'right' });
                                } else {
                                    doc.text(text, xPos + 1, yPos + 4);
                                }
                                
                                xPos += columnWidths[cellIndex];
                            });
                            
                            yPos += 6;
                        });
                        
                        // Add summary footer row with mobile optimization
                        if (yPos + 8 > doc.internal.pageSize.height - 20) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        xPos = 10;
                        
                        // Dark summary background
                        const summaryWidth = columnWidths[0] + columnWidths[1] + columnWidths[2] + columnWidths[3];
                        doc.setFillColor(44, 62, 80);
                        doc.rect(xPos, yPos, summaryWidth, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        doc.text('SUMMARY', xPos + 2, yPos + 5);
                        
                        // Total count
                        xPos += summaryWidth;
                        doc.setFillColor(44, 62, 80);
                        doc.rect(xPos, yPos, columnWidths[4], 8, 'F');
                        doc.text(`Total: ${reportData.length}`, xPos + 2, yPos + 5);
                        
                        // Total weight
                        xPos += columnWidths[4];
                        const totalWeight = reportData.reduce((sum, row) => sum + (parseFloat(row.grossWT) || 0), 0);
                        doc.setFillColor(44, 62, 80);
                        doc.rect(xPos, yPos, columnWidths[5], 8, 'F');
                        doc.text(totalWeight.toFixed(2), xPos + columnWidths[5] - 1, yPos + 5, { align: 'right' });
                        
                        yPos += 15;
                        
                        // Add summary section below table
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('Summary:', 10, yPos);
                        yPos += 8;
                        
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Total Records: ${reportData.length}`, 20, yPos);
                        yPos += 6;
                        doc.text(`Total Coils: ${reportData.length}`, 20, yPos);
                        yPos += 6;
                        doc.text(`Total Gross Weight: ${totalWeight.toFixed(2)}`, 20, yPos);
                    }
                } else {
                    // Handle plain text content with mobile optimization
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const lines = doc.splitTextToSize(modalContent.textContent, pageWidth - 40);
                    doc.text(lines, 20, yPosition);
                }
                
                // Generate mobile-friendly filename
                const cleanTitle = title.replace(/[^a-z0-9\s]/gi, '').replace(/\s+/g, '_').toLowerCase();
                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `${cleanTitle}_${timestamp}.pdf`;
                
                // Enhanced save method for mobile devices
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // For mobile devices, use blob and create download link
                    const pdfBlob = doc.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    document.body.appendChild(downloadLink);
                    
                    // Trigger download
                    downloadLink.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showMessage('PDF downloaded successfully! Check your Downloads folder', 'success');
                } else {
                    // Desktop method
                    doc.save(filename);
                    showMessage('PDF downloaded successfully', 'success');
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                
                // Provide more specific error messages for mobile users
                let errorMessage = 'Error generating PDF: ';
                if (error.message.includes('not loaded')) {
                    errorMessage += 'PDF library not available. Please refresh the page and try again.';
                } else if (error.message.includes('quota')) {
                    errorMessage += 'Storage space full. Please free up space and try again.';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
                
                // Fallback: offer alternative download methods
                try {
                    const title = document.getElementById('reportModalTitle').textContent;
                    const modalContent = document.getElementById('reportModalContent');
                    const content = modalContent.textContent;
                    
                    // Create text file as fallback
                    const textBlob = new Blob([`${title}\n\n${content}`], { type: 'text/plain' });
                    const url = URL.createObjectURL(textBlob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = `${title.replace(/[^a-z0-9]/gi, '_')}.txt`;
                    downloadLink.style.display = 'none';
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    showMessage('PDF failed, but text file downloaded instead', 'info');
                } catch (fallbackError) {
                    console.error('Fallback download also failed:', fallbackError);
                }
                
            } finally {
                // Reset button state
                const pdfBtn = document.querySelector('.report-modal-pdf');
                if (pdfBtn) {
                    pdfBtn.textContent = 'PDF';
                    pdfBtn.disabled = false;
                    pdfBtn.classList.remove('pdf-generating');
                }
            }
        }

        // Enhanced Share functionality for APK compatibility
        async function shareReport() {
            try {
                const title = document.getElementById('reportModalTitle').textContent;
                const modalContent = document.getElementById('reportModalContent');
                
                // Extract text content from HTML or get plain text
                let content;
                if (modalContent.innerHTML.includes('<table')) {
                    // Convert HTML table to plain text format
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = modalContent.innerHTML;
                    
                    // Remove HTML tags and format as plain text
                    const tables = tempDiv.querySelectorAll('table');
                    let textContent = '';
                    
                    if (tables.length > 0) {
                        const table = tables[0];
                        const rows = table.querySelectorAll('tr');
                        
                        // Add header info
                        const headers = tempDiv.querySelectorAll('h3, h4, p');
                        headers.forEach(header => {
                            if (header.closest('table')) return; // Skip headers inside tables
                            textContent += header.textContent.trim() + '\n';
                        });
                        textContent += '\n';
                        
                        // Process table rows
                        rows.forEach((row, index) => {
                            const cells = row.querySelectorAll('th, td');
                            const rowText = Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
                            textContent += rowText + '\n';
                            
                            // Add separator after header row
                            if (index === 0 && row.querySelector('th')) {
                                textContent += '='.repeat(80) + '\n';
                            }
                        });
                        
                        // Add summary section
                        const summaryDiv = tempDiv.querySelector('div');
                        if (summaryDiv && !summaryDiv.querySelector('table')) {
                            textContent += '\n' + summaryDiv.textContent.trim();
                        }
                    }
                    
                    content = textContent;
                } else {
                    content = modalContent.textContent;
                }
                
                // Show user feedback immediately
                const shareBtn = document.querySelector('.report-modal-share');
                if (shareBtn) {
                    shareBtn.textContent = 'Sharing...';
                    shareBtn.disabled = true;
                }
                
                // Method 1: Enhanced Android WebView Interface (APK environment)
                if (typeof Android !== 'undefined' && Android.shareText) {
                    try {
                        Android.shareText(title, content);
                        showMessage('Report shared successfully', 'success');
                        return;
                    } catch (error) {
                        console.log('Android WebView share failed:', error);
                    }
                }
                
                // Method 2: Enhanced Android Intent handling
                if (window.AndroidInterface && window.AndroidInterface.share) {
                    try {
                        window.AndroidInterface.share(title, content);
                        showMessage('Report shared successfully', 'success');
                        return;
                    } catch (error) {
                        console.log('AndroidInterface share failed:', error);
                    }
                }
                
                // Method 3: Web Share API with enhanced mobile support
                if (navigator.share) {
                    try {
                        // First try with just text (most compatible)
                        await navigator.share({
                            title: title,
                            text: content
                        });
                        showMessage('Report shared successfully', 'success');
                        return;
                    } catch (error) {
                        console.log('Web Share API failed:', error);
                        // Continue to next method instead of stopping
                    }
                }
                
                // Method 4: Create and share file (mobile-optimized)
                if (navigator.share && typeof File !== 'undefined') {
                    try {
                        const timestamp = new Date().toISOString().slice(0, 10);
                        const fileName = `${title.replace(/[^a-z0-9]/gi, '_')}_${timestamp}.txt`;
                        const blob = new Blob([`${title}\n\n${content}`], { type: 'text/plain' });
                        const file = new File([blob], fileName, { type: 'text/plain' });
                        
                        await navigator.share({
                            title: title,
                            files: [file]
                        });
                        showMessage('Report file shared successfully', 'success');
                        return;
                    } catch (error) {
                        console.log('File share method failed:', error);
                    }
                }
                
                // Method 5: Enhanced Clipboard API for mobile
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        const shareText = `${title}\n\n${content}`;
                        await navigator.clipboard.writeText(shareText);
                        showMessage('Report copied to clipboard successfully! You can now paste it in any messaging app', 'success');
                        return;
                    } catch (error) {
                        console.log('Modern clipboard API failed:', error);
                    }
                }
                
                // Method 6: Force download with mobile optimization
                try {
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const fileName = `${title.replace(/[^a-z0-9]/gi, '_')}_${timestamp}.txt`;
                    const shareText = `${title}\n\n${content}`;
                    const blob = new Blob([shareText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    // For mobile devices, create a more visible download link
                    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (isMobile) {
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = fileName;
                        downloadLink.style.display = 'none';
                        document.body.appendChild(downloadLink);
                        
                        // Trigger download
                        downloadLink.click();
                        
                        // Clean up
                        setTimeout(() => {
                            document.body.removeChild(downloadLink);
                            URL.revokeObjectURL(url);
                        }, 100);
                        
                        showMessage('Report downloaded successfully! Check your Downloads folder to share the file', 'success');
                        return;
                    } else {
                        // Desktop fallback
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showMessage('Report downloaded - you can share the file from your downloads', 'success');
                        return;
                    }
                } catch (error) {
                    console.log('Download method failed:', error);
                }
                
                // Method 7: Enhanced fallback with better mobile handling
                try {
                    const shareText = `${title}\n\n${content}`;
                    
                    // Try modern clipboard first for mobile
                    if (navigator.clipboard) {
                        try {
                            await navigator.clipboard.writeText(shareText);
                            showMessage('Report copied to clipboard! You can now paste it in any app to share', 'success');
                            return;
                        } catch (clipError) {
                            console.log('Modern clipboard failed, trying legacy method');
                        }
                    }
                    
                    // Legacy clipboard method with mobile optimization
                    const textArea = document.createElement('textarea');
                    textArea.value = shareText;
                    textArea.style.position = 'fixed';
                    textArea.style.top = '50%';
                    textArea.style.left = '50%';
                    textArea.style.transform = 'translate(-50%, -50%)';
                    textArea.style.width = '90%';
                    textArea.style.height = '200px';
                    textArea.style.padding = '10px';
                    textArea.style.border = '2px solid #3498db';
                    textArea.style.borderRadius = '8px';
                    textArea.style.background = 'white';
                    textArea.style.color = '#2c3e50';
                    textArea.style.fontSize = '14px';
                    textArea.style.fontFamily = 'monospace';
                    textArea.style.zIndex = '10000';
                    textArea.setAttribute('readonly', true);
                    
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    // For mobile, show instructions
                    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        showMessage('Please select all text and copy it to share the report', 'info');
                        
                        // Auto-remove after 10 seconds
                        setTimeout(() => {
                            if (document.body.contains(textArea)) {
                                document.body.removeChild(textArea);
                            }
                        }, 10000);
                    } else {
                        try {
                            const successful = document.execCommand('copy');
                            document.body.removeChild(textArea);
                            if (successful) {
                                showMessage('Report copied to clipboard! You can now paste it in any app to share', 'success');
                            } else {
                                showMessage('Please manually copy the report text to share', 'info');
                            }
                        } catch (error) {
                            document.body.removeChild(textArea);
                            showMessage('Please manually copy the report text to share', 'info');
                        }
                    }
                    
                } catch (error) {
                    console.log('Fallback method failed:', error);
                    showMessage('Unable to share report automatically. Please copy the text manually', 'error');
                }
                
            } catch (error) {
                console.error('All share methods failed:', error);
                showMessage('Unable to share report. Please copy the text manually', 'error');
            } finally {
                // Reset button state
                const shareBtn = document.querySelector('.report-modal-share');
                if (shareBtn) {
                    shareBtn.textContent = 'Share';
                    shareBtn.disabled = false;
                }
            }
        }



        async function uploadExcel() {
            try {
                const fileInput = document.getElementById('excelFile') || document.querySelector('input[type="file"]');
                if (!fileInput) {
                    showMessage('No file input available - please use Google Sheets integration', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                if (!file) {
                    showMessage('⚠️ WARNING: Please select an Excel file to upload', 'error');
                    return;
                }
                
                showMessage('Processing Excel file for Google Sheets...', 'info');
                
                // Read the file as array buffer
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Convert to base64 for processing
                const base64String = btoa(String.fromCharCode(...uint8Array));
                
                // Process with Google Sheets integration
                const result = await window.googleSheetsAPI.uploadExcelFile(base64String, file.name);
                
                if (result.success) {
                    showMessage(`Excel file "${file.name}" processed successfully`, 'success');
                    
                    // Clear the file input
                    fileInput.value = '';
                    document.getElementById('fileName').textContent = '';
                    
                    // Optionally refresh the coil data from the uploaded file
                    await loadCoilDataFromFile();
                } else {
                    showMessage(`Error uploading Excel file: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error uploading Excel file:', error);
                showMessage('Error uploading Excel file: ' + error.message, 'error');
            }
        }

        function clearInputs() {
            document.getElementById('coilInput').value = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            toggleClearButton();
        }

        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear all local storage data?')) {
                localStorage.clear();
                showMessage('Local storage cleared', 'success');
            }
        }

        function resetApp() {
            if (confirm('Are you sure you want to reset the app? This will clear all data and reload the page.')) {
                localStorage.clear();
                location.reload();
            }
        }

        function setGoogleSheetsCredentials() {
            // Check if credentials are already set
            const existingSpreadsheetId = localStorage.getItem('googleSheets_spreadsheetId');
            if (existingSpreadsheetId) {
                const confirm = window.confirm('Google Sheets credentials are already set. Do you want to update them?');
                if (!confirm) {
                    showMessage('Using existing Google Sheets credentials. App is working normally.', 'info');
                    return;
                }
            }
            
            const spreadsheetUrl = prompt('Enter your Google Sheets URL or Spreadsheet ID:');
            if (spreadsheetUrl) {
                const apiKey = prompt('Enter your Google Sheets API Key (optional - leave empty for public sheets):');
                const storedWebAppUrl = localStorage.getItem('googleSheets_webAppUrl') || '';
                window.googleSheetsAPI.setCredentials(spreadsheetUrl, apiKey || '', storedWebAppUrl);
                showMessage('Google Sheets credentials set successfully', 'success');
                updateGoogleSheetsButtonStatus();
                
                // Try to auto-load data after setting credentials
                autoLoadFromGoogleSheets().catch(error => {
                    console.error('Auto-load after credential setup failed:', error);
                });
            }
        }

        function updateGoogleSheetsButtonStatus() {
            const button = document.getElementById('googleSheetsBtn');
            const existingSpreadsheetId = localStorage.getItem('googleSheets_spreadsheetId');
            
            if (existingSpreadsheetId && button) {
                button.textContent = 'Google Sheets Set ✓';
                button.style.backgroundColor = '#27ae60';
                button.title = 'Google Sheets is already configured. Click to change it.';
            } else if (button) {
                button.textContent = 'Set Google Sheets';
                button.style.backgroundColor = '#e74c3c';
                button.title = 'Click to set Google Sheets credentials.';
            }
        }

        async function uploadLocalDataToSheets() {
            try {
                showMessage('Uploading local data to Google Sheets...', 'info');
                
                // Get local OUT data
                const localOutData = JSON.parse(localStorage.getItem('outData') || '[]');
                if (localOutData.length === 0) {
                    showMessage('No local OUT data found to upload', 'warning');
                    return;
                }
                
                console.log(`Uploading ${localOutData.length} local OUT entries to Google Sheets`);
                
                // Check Google Sheets credentials
                const { spreadsheetId, apiKey } = window.googleSheetsAPI.getCredentials();
                if (!spreadsheetId) {
                    showMessage('Please connect to Google Sheets first using "Connect Sheets" button', 'error');
                    return;
                }
                
                if (!apiKey || apiKey.trim() === '') {
                    showMessage('Google Sheets API key is required to write data. Please add your API key in the Google Sheets section.', 'error');
                    return;
                }
                
                // Get available sheets to find OUT sheet
                const sheetNames = await window.googleSheetsAPI.getSheetNames();
                let outSheetName = sheetNames.find(name => 
                    name.toLowerCase().includes('out')
                );
                
                if (!outSheetName) {
                    // Use first sheet or create OUT sheet name
                    outSheetName = sheetNames[0] || 'OUT';
                    console.log(`No OUT sheet found, using: ${outSheetName}`);
                }
                
                // Upload data to Google Sheets
                const result = await window.googleSheetsAPI.appendToSheet(outSheetName, localOutData, false);
                
                const metaData = JSON.parse(localStorage.getItem('outDataMeta') || '{}');
                const vesselName = metaData.vesselName || 'coil-data';
                
                showMessage(`Successfully uploaded ${localOutData.length} records to Google Sheets (${outSheetName}) for vessel "${vesselName}"`, 'success');
                console.log('Upload successful:', result);
                
            } catch (error) {
                console.error('Error uploading to Google Sheets:', error);
                if (error.message.includes('API key required')) {
                    showMessage('Google Sheets API key is required for writing data. Please add your API key to enable uploads.', 'error');
                } else {
                    showMessage('Error uploading to Google Sheets: ' + error.message, 'error');
                }
            }
        }

        async function syncWithGoogleSheets() {
            try {
                showMessage('Syncing with Google Sheets...', 'info');
                
                // Load data from Google Sheets
                const sheetsData = await window.googleSheetsAPI.loadOutData();
                
                if (sheetsData && sheetsData.length > 0) {
                    // Update local storage with Google Sheets data
                    localStorage.setItem('outData', JSON.stringify(sheetsData));
                    
                    // Update global outData variable
                    window.outData = sheetsData;
                    
                    showMessage(`Successfully synced ${sheetsData.length} records from Google Sheets`, 'success');
                    console.log('Synced data from Google Sheets:', sheetsData.length, 'records');
                } else {
                    showMessage('No data found in Google Sheets to sync', 'warning');
                }
                
            } catch (error) {
                console.error('Error syncing with Google Sheets:', error);
                showMessage('Error syncing with Google Sheets: ' + error.message, 'error');
            }
        }

        async function connectToGoogleSheets() {
            try {
                const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                const webAppUrl = document.getElementById('webAppUrl').value.trim();
                
                if (!spreadsheetId) {
                    showMessage('Please enter a Google Sheets URL or ID', 'error');
                    return;
                }
                
                window.googleSheetsAPI.setCredentials(spreadsheetId, apiKey, webAppUrl);
                
                // Test connection
                await window.googleSheetsAPI.testConnection();
                
                let connectionStatus = 'Successfully connected to Google Sheets!';
                if (webAppUrl) {
                    connectionStatus += ' Web App URL configured for writing data.';
                } else {
                    connectionStatus += ' Note: Web App URL needed for writing data to sheets.';
                }
                
                showMessage(connectionStatus, 'success');
                
                const button = document.getElementById('connectSheetsBtn');
                if (button) {
                    button.textContent = 'Connected ✓';
                    button.style.backgroundColor = '#27ae60';
                }
                
            } catch (error) {
                console.error('Error connecting to Google Sheets:', error);
                showMessage('Connection failed: ' + error.message, 'error');
            }
        }

        async function loadDataFromGoogleSheets() {
            try {
                showMessage('Loading data from Google Sheets...', 'info');
                await autoLoadFromGoogleSheets();
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                showMessage('Error loading data: ' + error.message, 'error');
            }
        }

        function showMessage(text, type = 'info') {
            if (window.permissionManager) {
                window.permissionManager.showMessage(text, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${text}`);
            }
        }

        // Test Google Apps Script connection
        async function testGoogleAppsScript() {
            try {
                const { webAppUrl } = window.googleSheetsAPI.getCredentials();
                
                if (!webAppUrl || webAppUrl.includes('YOUR_SCRIPT_ID')) {
                    showMessage('Please enter your Google Apps Script Web App URL first', 'error');
                    return;
                }
                
                showMessage('Testing Google Apps Script connection...', 'info');
                
                const response = await fetch(webAppUrl + '?test=true');
                const result = await response.json();
                
                if (result.success === false && result.error === 'No data provided') {
                    showMessage('✅ Google Apps Script is working correctly!', 'success');
                } else {
                    showMessage('✅ Google Apps Script responded successfully', 'success');
                }
                
            } catch (error) {
                console.error('Google Apps Script test failed:', error);
                showMessage(`❌ Test failed: ${error.message}. Please check your setup.`, 'error');
            }
        }
        
        // Show setup instructions
        function showSetupInstructions() {
            const instructions = `
STEP-BY-STEP GOOGLE APPS SCRIPT SETUP:

Your script URL: https://script.google.com/home/projects/1EIK4xnwIzrV7qg6OXCEXuiejyCOuC9jdwRun6Ex3jVs336jThqmMquA-/edit

REQUIRED STEPS:
1. Click the URL above to open your Google Apps Script
2. DELETE ALL existing code in the script editor
3. PASTE this complete code:

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    const spreadsheetId = '18VjUGZ-dGFMEq1oIlxIssRlwkfcPZZJfH6GD7UdgOyc';
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    let data, sheetName;
    
    if (e.postData && e.postData.contents) {
      const formData = e.parameter;
      if (formData.payload) {
        const payload = JSON.parse(formData.payload);
        data = payload.records;
        sheetName = payload.sheetName || 'OUT';
      }
    } else if (e.parameter) {
      sheetName = e.parameter.sheetName || 'OUT';
      if (e.parameter.data) {
        data = JSON.parse(e.parameter.data);
      }
    }
    
    if (data && data.length > 0) {
      const sheet = spreadsheet.getSheetByName(sheetName);
      if (!sheet) {
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: "Sheet '" + sheetName + "' not found"
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      data.forEach(record => {
        const values = Object.values(record);
        sheet.appendRow(values);
      });
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        recordsAdded: data.length,
        message: "Data added to " + sheetName
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "No data provided"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

4. Save the script (Ctrl+S)
5. Click "Deploy" → "New deployment" (blue button)
6. Choose "Web app" as type
7. Set "Execute as": Me (your email)  
8. Set "Who has access": Anyone
9. Click "Deploy"
10. IMPORTANT: When you see "This app isn't verified", click "Advanced" then "Go to [your script] (unsafe)"
11. Click "Allow" to grant permissions
12. Copy the Web App URL that appears
13. Test it by opening the URL in a new tab - you should see JSON response

Current status: ${window.googleSheetsAPI.getCredentials().webAppUrl ? 'URL configured' : 'URL not set'}
`;
            
            // Create a better modal dialog
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: #2c3e50; color: #ecf0f1; padding: 20px; 
                border-radius: 8px; max-width: 600px; max-height: 80vh; 
                overflow-y: auto; font-family: monospace; font-size: 12px;
                line-height: 1.4;
            `;
            
            content.innerHTML = `
                <h3 style="margin-top: 0;">Google Apps Script Setup</h3>
                <pre style="white-space: pre-wrap; background: #34495e; padding: 15px; border-radius: 4px; overflow-x: auto;">${instructions}</pre>
                <button onclick="this.parentElement.parentElement.remove()" 
                    style="margin-top: 15px; padding: 10px 20px; background: #3498db; 
                    color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // Open Google Apps Script directly
        function openGoogleScript() {
            const scriptUrl = 'https://script.google.com/home/projects/1EIK4xnwIzrV7qg6OXCEXuiejyCOuC9jdwRun6Ex3jVs336jThqmMquA-/edit';
            window.open(scriptUrl, '_blank');
            
            // Show quick instructions
            showMessage('📝 Opening your Google Apps Script. After it opens: 1) Delete all existing code, 2) Paste the new code from Setup Instructions, 3) Deploy as Web App with "Anyone" access', 'info');
        }

        // Initialize when permissions are ready
        document.addEventListener('deviceready', async () => {
            console.log('Device ready - initializing permissions');
            await window.permissionManager.initialize();
        }, false);

        // Fallback for browser testing
        if (typeof cordova === 'undefined') {
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('Browser mode - initializing permissions');
                await window.permissionManager.initialize();
            });
        }
    </script>

    <!-- PWA Features - Single File Mode -->
    <script>
        console.log('PWA running in single file mode - service worker disabled for portability');
        // Service worker disabled to maintain single-file structure

        // Add to home screen prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button or notification
            console.log('App can be installed');
        });

        // Handle app installation
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }
    </script>
</body>
</html>