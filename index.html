<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Coil Data Checker</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Comic Neue', cursive, sans-serif;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 8px;
      overflow-x: hidden;
    }
    
    .header-title {
      text-align: center;
      margin-bottom: 15px;
    }
    
    .header-title h1 {
      font-size: 24px;
      font-weight: bold;
      color: #00ff66;
      text-shadow: 1px 1px 3px #000;
      margin: 0;
      line-height: 1.3;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 500px;
    }
    
    .section {
      background: rgba(255, 255, 255, 0.05);
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .button-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    
    .half-width {
      flex: 1;
      margin: 0 !important;
    }
    
    .third-width {
      flex: 1;
      margin: 0 !important;
    }
    
    .coil-details-display {
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      min-height: 60px;
      margin-top: 10px;
    }
    
    /* Mobile-optimized input styling */
    input, button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      touch-action: manipulation;
    }
    
    input[type="text"], input[type="file"] {
      background: #ecf0f1;
      color: #2c3e50;
      font-family: 'Comic Neue', cursive, sans-serif;
    }
    
    input[type="text"]:focus {
      outline: none;
      box-shadow: 0 0 0 2px #00ff66;
    }
    
    button {
      background-color: #1abc9c;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-family: 'Comic Neue', cursive, sans-serif;
      transition: all 0.2s ease;
    }
    
    button:active {
      transform: scale(0.98);
      background-color: #16a085;
    }
    
    button.clear-button {
      background-color: #e74c3c;
    }
    
    button.clear-button:active {
      background-color: #c0392b;
    }
    
    button:disabled {
      background-color: #7f8c8d;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    /* Section headers */
    h2 {
      font-size: 18px;
      margin: 0 0 15px 0;
      text-align: left;
      color: #fff;
      font-weight: bold;
    }
    
    /* Suggestion dropdowns */
    #suggestions, #vehicleSuggestions, #reportVehicleSuggestions {
      background: white;
      color: #2c3e50;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      width: calc(100% - 30px);
      z-index: 10;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      border: 1px solid #ddd;
    }
    
    #suggestions div, #vehicleSuggestions div, #reportVehicleSuggestions div {
      padding: 14px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 16px;
      font-family: 'Comic Neue', cursive, sans-serif;
    }
    
    #suggestions div:hover, #vehicleSuggestions div:hover, #reportVehicleSuggestions div:hover {
      background-color: #f8f9fa;
    }
    
    #suggestions div:last-child, #vehicleSuggestions div:last-child, #reportVehicleSuggestions div:last-child {
      border-bottom: none;
    }
    
    /* Result display - remove default styles since we're using coil-details-display */
    
    #result table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    #result table td {
      padding: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      word-wrap: break-word;
      vertical-align: top;
    }
    
    #result table tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.1);
    }
    
    /* QR Code Scanner */
    #reader {
      width: 100%;
      margin-top: 15px;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
      min-height: 50px;
    }
    
    .input-container {
      position: relative;
    }
    
    /* File name display */
    #fileName {
      color: #ecf0f1;
      font-size: 14px;
      margin: 5px 0;
      text-align: center;
      word-wrap: break-word;
    }
    
    /* Added coils display */
    #addedCoils {
      margin-top: 15px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      min-height: 20px;
    }
    
    #addedCoils h3 {
      margin: 0 0 10px 0;
      color: #00ff66;
      font-size: 16px;
    }
    
    /* Touch-friendly file input */
    input[type="file"] {
      background: rgba(255, 255, 255, 0.9);
      border: 2px dashed #3498db;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 14px;
      padding: 20px;
    }
    
    input[type="file"]::-webkit-file-upload-button {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 480px) {
      body {
        padding: 10px 5px;
      }
      
      .header-title h1 {
        font-size: 20px;
      }
      
      .container {
        padding: 12px;
      }
      
      input, button {
        font-size: 16px;
        padding: 12px;
      }
      
      h2 {
        font-size: 16px;
      }
      
      #suggestions, #vehicleSuggestions, #reportVehicleSuggestions {
        font-size: 14px;
      }
      
      #suggestions div, #vehicleSuggestions div, #reportVehicleSuggestions div {
        padding: 12px;
      }
    }
    
    /* Very small screens */
    @media (max-width: 320px) {
      .header-title h1 {
        font-size: 18px;
      }
      
      input, button {
        font-size: 14px;
        padding: 10px;
      }
      
      .container {
        padding: 10px;
      }
    }
    
    /* Prevent zoom on iOS */
    @media screen and (-webkit-min-device-pixel-ratio: 0) {
      input, textarea, select {
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>
  <div class="header-title">
    <h1>A.S.Shipping Agencies Pvt Ltd,<br>(Greenways Group)</h1>
  </div>

  <div class="container">
    <!-- Coil Details Section -->
    <div class="section">
      <h2>Coil Details</h2>
      <div id="result" class="coil-details-display"></div>
    </div>

    <!-- Coil Processing Section -->
    <div class="section">
      <h2>Coil Processing</h2>
      <div class="input-container">
        <input type="text" id="coilInput" placeholder="Enter Coil Number" oninput="showSuggestions(); toggleClearButton();" autocomplete="off" />
        <div id="suggestions"></div>
      </div>
      <div class="input-container">
        <input type="text" id="vehicleInput" placeholder="Enter Vehicle Number" oninput="showVehicleSuggestions(); toggleVehicleClearButton();" autocomplete="off" />
        <div id="vehicleSuggestions"></div>
      </div>
      
      <div class="button-row">
        <button class="third-width" onclick="startScanner()">Scan QR</button>
        <button class="third-width" id="addBtn" onclick="addCoilToVehicle()">Add Coil</button>
        <button class="third-width clear-button" onclick="clearInputs()">Clear</button>
      </div>
      
      <div class="button-row">
        <button class="third-width" id="saveBtn" onclick="saveVehicleCoils()">Save</button>
        <button class="third-width" id="generateBtn" onclick="generateTextFile()" disabled>Generate Text</button>
        <button class="third-width clear-button" id="clearVehicleBtn" onclick="clearVehicleInput()" style="display: none;">Clear Vehicle</button>
      </div>
      
      <div id="reader" ondblclick="closeScanner()"></div>
      <div id="addedCoils"></div>
    </div>

    <!-- Generate Reports Section -->
    <div class="section">
      <h2>Generate Reports</h2>
      <div class="input-container">
        <input type="text" id="reportVehicleInput" placeholder="Enter Vehicle Number for Report" oninput="showReportVehicleSuggestions(); toggleReportVehicleClearButton();" autocomplete="off" />
        <div id="reportVehicleSuggestions"></div>
      </div>
      <div class="button-row">
        <button class="half-width" onclick="generateAllOutDataReport()">All OUT Data Report</button>
        <button class="half-width" onclick="generateVehicleOutReport()">Generate Vehicle Report</button>
      </div>
      <button id="clearReportVehicleBtn" class="clear-button" onclick="clearReportVehicleInput()" style="display: none;">Clear Report Vehicle</button>
    </div>

    <!-- File Management Section -->
    <div class="section">
      <h2>File Management</h2>
      <input type="file" id="excelFile" accept=".xlsx, .xls" />
      <p id="fileName"></p>
      <div class="button-row">
        <button class="third-width" onclick="downloadExcel()">Download Excel</button>
        <button class="third-width clear-button" onclick="clearLocalStorage()">Clear Storage</button>
        <button class="third-width clear-button" onclick="resetApp()">Clear All</button>
      </div>
    </div>
  </div>

  <!-- EXACT SAME JAVASCRIPT AS ORIGINAL -->
  <script>
    let coilData = [];
    let vehicleData = [];
    let outData = [];
    let loadedFileName = '';
    let addedCoils = [];
    let vehicleCoilMap = {};
    let html5QrCode;
    let serialCounter = 1;
    const GITHUB_EXCEL_URL = 'https://raw.githubusercontent.com/gmanand23/Coil_Info/main/coil-data.xlsx?' + new Date().getTime();

    // Function to format date in DD-MM-YYYY HH:MM:SS AM/PM format
    function formatDateTime(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      hours = String(hours).padStart(2, '0');
      
      return `${day}-${month}-${year} ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const cachedCoilData = localStorage.getItem('coilData');
      const cachedVehicleData = localStorage.getItem('vehicleData');
      const cachedOutData = localStorage.getItem('outData');
      const cachedFileName = localStorage.getItem('loadedFileName');
      const cachedSerialCounter = localStorage.getItem('serialCounter');
      
      if (cachedCoilData && cachedVehicleData && cachedFileName) {
        coilData = JSON.parse(cachedCoilData);
        vehicleData = JSON.parse(cachedVehicleData);
        outData = cachedOutData ? JSON.parse(cachedOutData) : [];
        serialCounter = cachedSerialCounter ? parseInt(cachedSerialCounter) : 1;
        loadedFileName = cachedFileName;
        document.getElementById('fileName').textContent = `Loaded from Local Storage: ${loadedFileName}`;
      } else {
        await fetchAndLoadExcelFromUrl(GITHUB_EXCEL_URL);
      }
      
      // Initialize button states
      document.getElementById('generateBtn').disabled = Object.keys(vehicleCoilMap).length === 0;
    });

    function clearLocalStorage() {
      localStorage.removeItem('coilData');
      localStorage.removeItem('vehicleData');
      localStorage.removeItem('outData');
      localStorage.removeItem('loadedFileName');
      localStorage.removeItem('serialCounter');
      alert('Local storage cleared!');
      fetchAndLoadExcelFromUrl(GITHUB_EXCEL_URL);
    }

    function resetApp() {
      localStorage.clear();
      alert('App data cleared. Reloading...');
      window.location.href = window.location.origin + window.location.pathname + '?cachebust=' + new Date().getTime();
    }

    async function fetchAndLoadExcelFromUrl(url) {
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Load coil data from first sheet
        const coilSheet = workbook.Sheets[workbook.SheetNames[0]];
        coilData = XLSX.utils.sheet_to_json(coilSheet);
        
        // Load vehicle data from VEH sheet if it exists
        vehicleData = [];
        const vehSheetName = workbook.SheetNames.find(name => name.toUpperCase() === 'VEH');
        if (vehSheetName) {
          const vehSheet = workbook.Sheets[vehSheetName];
          vehicleData = XLSX.utils.sheet_to_json(vehSheet);
        }
        
        // Load OUT data from OUT sheet if it exists
        outData = [];
        const outSheetName = workbook.SheetNames.find(name => name.toUpperCase() === 'OUT');
        if (outSheetName) {
          const outSheet = workbook.Sheets[outSheetName];
          outData = XLSX.utils.sheet_to_json(outSheet);
          // Set serial counter to next available number
          if (outData.length > 0) {
            const maxSerial = Math.max(...outData.map(row => parseInt(row['Serial No']) || 0));
            serialCounter = maxSerial + 1;
          }
        }
        
        loadedFileName = 'coil-data.xlsx';
        localStorage.setItem('coilData', JSON.stringify(coilData));
        localStorage.setItem('vehicleData', JSON.stringify(vehicleData));
        localStorage.setItem('outData', JSON.stringify(outData));
        localStorage.setItem('serialCounter', serialCounter.toString());
        localStorage.setItem('loadedFileName', loadedFileName);
        document.getElementById('fileName').textContent = `Loaded File: ${loadedFileName}`;
      } catch (error) {
        console.error('Error loading Excel file:', error);
        alert('Error loading Excel file from GitHub. Please upload a file manually.');
      }
    }

    document.getElementById('excelFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Load coil data from first sheet
          const coilSheet = workbook.Sheets[workbook.SheetNames[0]];
          coilData = XLSX.utils.sheet_to_json(coilSheet);
          
          // Load vehicle data from VEH sheet if it exists
          vehicleData = [];
          const vehSheetName = workbook.SheetNames.find(name => name.toUpperCase() === 'VEH');
          if (vehSheetName) {
            const vehSheet = workbook.Sheets[vehSheetName];
            vehicleData = XLSX.utils.sheet_to_json(vehSheet);
          }
          
          // Load OUT data from OUT sheet if it exists
          outData = [];
          const outSheetName = workbook.SheetNames.find(name => name.toUpperCase() === 'OUT');
          if (outSheetName) {
            const outSheet = workbook.Sheets[outSheetName];
            outData = XLSX.utils.sheet_to_json(outSheet);
            // Set serial counter to next available number
            if (outData.length > 0) {
              const maxSerial = Math.max(...outData.map(row => parseInt(row['Serial No']) || 0));
              serialCounter = maxSerial + 1;
            }
          }
          
          loadedFileName = file.name;
          localStorage.setItem('coilData', JSON.stringify(coilData));
          localStorage.setItem('vehicleData', JSON.stringify(vehicleData));
          localStorage.setItem('outData', JSON.stringify(outData));
          localStorage.setItem('serialCounter', serialCounter.toString());
          localStorage.setItem('loadedFileName', loadedFileName);
          document.getElementById('fileName').textContent = `Loaded File: ${loadedFileName}`;
        } catch (error) {
          console.error('Error parsing Excel file:', error);
          alert('Error parsing Excel file. Please check the file format.');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function downloadExcel() {
      if (coilData.length === 0) return alert('No data loaded.');
      const worksheet = XLSX.utils.json_to_sheet(coilData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Coil Data");
      
      // Add VEH sheet if vehicle data exists
      if (vehicleData.length > 0) {
        const vehWorksheet = XLSX.utils.json_to_sheet(vehicleData);
        XLSX.utils.book_append_sheet(workbook, vehWorksheet, "VEH");
      }
      
      // Add OUT sheet if out data exists
      if (outData.length > 0) {
        const outWorksheet = XLSX.utils.json_to_sheet(outData);
        XLSX.utils.book_append_sheet(workbook, outWorksheet, "OUT");
      }
      
      XLSX.writeFile(workbook, loadedFileName || 'coil-data.xlsx');
    }

    function searchCoil() {
      const coilNumber = document.getElementById('coilInput').value.trim().toUpperCase();
      const result = coilData.find(row => {
        const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
        return matchKey && String(row[matchKey]).trim().toUpperCase() === coilNumber;
      });
      displayResult(result);
    }

    function displayResult(data) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = data
        ? `<table>${Object.entries(data).map(([k, v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join('')}</table>`
        : '<p>Coil number not found.</p>';
    }

    function showSuggestions() {
      const input = document.getElementById('coilInput').value.trim().toUpperCase();
      const suggestions = document.getElementById('suggestions');
      
      if (input.length === 0) {
        suggestions.style.display = 'none';
        return;
      }
      
      const matches = coilData.filter(row => {
        const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
        return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
      }).slice(0, 10);
      
      if (matches.length > 0) {
        suggestions.innerHTML = matches.map(row => {
          const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
          return `<div onclick="selectSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
        }).join('');
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    }

    function selectSuggestion(coilNumber) {
      document.getElementById('coilInput').value = coilNumber;
      document.getElementById('suggestions').style.display = 'none';
      searchCoil();
      toggleClearButton();
    }

    function toggleClearButton() {
      // This function exists for compatibility but doesn't need to do anything
      // since there's no clearInputBtn in the original design
    }

    function startScanner() {
      const reader = document.getElementById('reader');
      if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
        return;
      }
      
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          document.getElementById('coilInput').value = decodedText;
          searchCoil();
          toggleClearButton();
          html5QrCode.stop();
        },
        (errorMessage) => {
          // Ignore errors for cleaner console
        }
      );
    }

    function closeScanner() {
      if (html5QrCode) {
        html5QrCode.stop();
      }
    }

    // Vehicle functions
    function showVehicleSuggestions() {
      const input = document.getElementById('vehicleInput').value.trim().toUpperCase();
      const suggestions = document.getElementById('vehicleSuggestions');
      
      if (input.length === 0) {
        suggestions.style.display = 'none';
        return;
      }
      
      const matches = vehicleData.filter(row => {
        const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
        return matchKey && String(row[matchKey]).trim().toUpperCase().includes(input);
      }).slice(0, 10);
      
      if (matches.length > 0) {
        suggestions.innerHTML = matches.map(row => {
          const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'VEHICLE NO');
          return `<div onclick="selectVehicleSuggestion('${row[matchKey]}')">${row[matchKey]}</div>`;
        }).join('');
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    }

    function selectVehicleSuggestion(vehicleNumber) {
      document.getElementById('vehicleInput').value = vehicleNumber;
      document.getElementById('vehicleSuggestions').style.display = 'none';
      toggleVehicleClearButton();
    }

    function toggleVehicleClearButton() {
      const input = document.getElementById('vehicleInput').value.trim();
      const clearBtn = document.getElementById('clearVehicleBtn');
      clearBtn.style.display = input ? 'block' : 'none';
    }

    function clearVehicleInput() {
      document.getElementById('vehicleInput').value = '';
      document.getElementById('vehicleSuggestions').style.display = 'none';
      toggleVehicleClearButton();
    }

    function addCoilToVehicle() {
    document.getElementById('vehicleInput').disabled = true;
    const coilInput = document.getElementById('coilInput'); // Get the coil input element
    const coil = coilInput.value.trim().toUpperCase();
    const vehicle = document.getElementById('vehicleInput').value.trim().toUpperCase();
    if (!coil || !vehicle) return alert('Enter both coil and vehicle number.');
    addedCoils.push({ coilNumber: coil, vehicleNumber: vehicle });
    updateAddedCoilsDisplay();
    coilInput.value = ''; // Clear the coil input field
    document.getElementById('result').innerHTML = ''; // Clear the displayed coil details
    document.getElementById('suggestions').style.display = 'none'; // Hide suggestions
    }

    function updateAddedCoilsDisplay() {
      const div = document.getElementById('addedCoils');
      if (addedCoils.length === 0) {
        div.innerHTML = '';
        return;
      }
      
      let html = '<h3>Added Coils:</h3>';
      addedCoils.forEach((item, index) => {
        html += `<div style="background: rgba(255,255,255,0.1); padding: 8px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
          <span>${item.coilNumber} â†’ ${item.vehicleNumber}</span>
          <button onclick="removeCoil(${index})" style="padding: 2px 4px; font-size: 9px; background: #e74c3c; color: white; border: none; border-radius: 2px; cursor: pointer; min-width: 45px;">Remove</button>
        </div>`;
      });
      div.innerHTML = html;
    }

    function removeCoil(index) {
      addedCoils.splice(index, 1);
      updateAddedCoilsDisplay();
    }

    function saveVehicleCoils() {
      if (!addedCoils.length) return alert('No coils to save.');
      addedCoils.forEach(({ coilNumber, vehicleNumber }) => {
        if (!vehicleCoilMap[vehicleNumber]) vehicleCoilMap[vehicleNumber] = [];
        vehicleCoilMap[vehicleNumber].push(coilNumber);
      });
      addedCoils = [];
      updateAddedCoilsDisplay();
      document.getElementById('generateBtn').disabled = false;
      document.getElementById('addBtn').disabled = true;
      document.getElementById('saveBtn').disabled = true;
    }

    // Enhanced generateTextFile function with proper storage permission handling
    async function generateTextFile() {
      document.getElementById('vehicleInput').disabled = false;
      
      // Request storage permission explicitly
      try {
        if ('permissions' in navigator) {
          const permission = await navigator.permissions.query({name: 'persistent-storage'});
          if (permission.state !== 'granted') {
            // For browsers that support the API, request permission
            if ('storage' in navigator && 'persist' in navigator.storage) {
              await navigator.storage.persist();
            }
          }
        }
      } catch (error) {
        // Permission API not supported, continue anyway
        console.log('Storage permission API not supported, continuing...');
      }
      
      const now = new Date();
      const currentDate = now.toLocaleDateString('en-GB').replace(/\//g, '-'); // DD-MM-YYYY format
      const currentTime = now.toLocaleTimeString('en-US', { hour12: true }); // 12-hour format with AM/PM
      
      // Generate separate file for each vehicle
      for (const [vehicle, coils] of Object.entries(vehicleCoilMap)) {
        // Find transporter for this vehicle from VEH sheet
        let transporter = '';
        if (vehicleData.length > 0) {
          const vehicleColumnKey = Object.keys(vehicleData[0]).find(key => 
            key.trim().toUpperCase().includes('VEHICLE NO') || 
            key.trim().toUpperCase().includes('VEHICLENO') ||
            key.trim().toUpperCase() === 'VEHICLE NO'
          );
          
          const transporterColumnKey = Object.keys(vehicleData[0]).find(key => 
            key.trim().toUpperCase().includes('TRANSPORTER') || 
            key.trim().toUpperCase().includes('TRANSPORT')
          );
          
          if (vehicleColumnKey && transporterColumnKey) {
            const vehicleRecord = vehicleData.find(row => 
              String(row[vehicleColumnKey]).trim().toUpperCase() === vehicle
            );
            if (vehicleRecord) {
              transporter = vehicleRecord[transporterColumnKey] || '';
            }
          }
        }
        
        // Create content for text file in exact original format
        let content = `A.S.Shipping Agencies Pvt Ltd,\n`;
        content += `(Greenways Group)\n`;
        content += `--------------------------------------------\n`;
        content += `Vehicle: ${vehicle}`;
        if (transporter) {
          content += ` | Transporter: ${transporter}`;
        }
        content += `\n`;
        content += `Generated On: ${currentDate} at ${currentTime}\n`;
        content += `--------------------------------------------\n`;
        
        let vehicleGrossTotal = 0;
        coils.forEach(coil => {
          const found = coilData.find(row => {
            const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
            return matchKey && String(row[matchKey]).trim().toUpperCase() === coil;
          });
          const grossWT = found ? (found['GROSS WT'] || found['Gross WT'] || 0) : 0;
          vehicleGrossTotal += parseFloat(grossWT) || 0;
          content += `Coil No: ${coil}, Gross WT: ${grossWT}\n`;
        });
        
        content += `\nTotal No of Coils : ${coils.length}\n`;
        content += `Total Gross WT : ${vehicleGrossTotal.toFixed(2)}\n`;
        content += `--------------------------------------------\n`;
        
        // Create and trigger download
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${vehicle}_${currentDate.replace(/-/g, '')}.txt`;
        
        // Use modern File System Access API if available
        if ('showSaveFilePicker' in window) {
          try {
            const fileHandle = await window.showSaveFilePicker({
              suggestedName: `${vehicle}_${currentDate.replace(/-/g, '')}.txt`,
              types: [{
                description: 'Text files',
                accept: { 'text/plain': ['.txt'] }
              }]
            });
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
          } catch (error) {
            if (error.name !== 'AbortError') {
              // Fallback to traditional download
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          }
        } else {
          // Fallback for browsers without File System Access API
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
        
        URL.revokeObjectURL(url);
        
        // Add to outData for tracking in exact Excel format
        coils.forEach(coilNumber => {
          const coilDetails = coilData.find(row => {
            const matchKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'MILL COIL NO');
            return matchKey && String(row[matchKey]).trim().toUpperCase() === coilNumber;
          });
          
          if (coilDetails) {
            const grossWT = coilDetails['GROSS WT'] || coilDetails['Gross WT'] || 0;
            outData.push({
              'Serial No': serialCounter++,
              'Date & Time': formatDateTime(new Date()),
              'Vehicle No': vehicle,
              'Mill Coil No': coilNumber,
              'TRANSPORTER': transporter,
              'GROSS WT': grossWT
            });
          }
        });
      }
      
      // Save updated OUT data and serial counter to localStorage
      localStorage.setItem('outData', JSON.stringify(outData));
      localStorage.setItem('serialCounter', serialCounter.toString());
      
      // Reset button states like the original
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('vehicleInput').value = '';
      document.getElementById('addBtn').disabled = false;
      document.getElementById('saveBtn').disabled = false;
      
      // Clear the vehicle coil map
      vehicleCoilMap = {};
      
      alert('Text files generated successfully!');
    }

    function clearInputs() {
      document.getElementById('coilInput').value = '';
      document.getElementById('result').innerHTML = '';
      document.getElementById('suggestions').style.display = 'none';
    }

    // Report generation functions
    function showReportVehicleSuggestions() {
      const input = document.getElementById('reportVehicleInput').value.trim().toUpperCase();
      const suggestions = document.getElementById('reportVehicleSuggestions');
      
      if (input.length === 0) {
        suggestions.style.display = 'none';
        return;
      }
      
      const matches = outData.filter(row => {
        const vehicle = row['Vehicle No'] || '';
        return String(vehicle).trim().toUpperCase().includes(input);
      }).slice(0, 10);
      
      // Get unique vehicle numbers
      const uniqueVehicles = [...new Set(matches.map(row => row['Vehicle No']))];
      
      if (uniqueVehicles.length > 0) {
        suggestions.innerHTML = uniqueVehicles.map(vehicle => 
          `<div onclick="selectReportVehicleSuggestion('${vehicle}')">${vehicle}</div>`
        ).join('');
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    }

    function selectReportVehicleSuggestion(vehicleNumber) {
      document.getElementById('reportVehicleInput').value = vehicleNumber;
      document.getElementById('reportVehicleSuggestions').style.display = 'none';
      toggleReportVehicleClearButton();
    }

    function toggleReportVehicleClearButton() {
      const input = document.getElementById('reportVehicleInput').value.trim();
      const clearBtn = document.getElementById('clearReportVehicleBtn');
      clearBtn.style.display = input ? 'block' : 'none';
    }

    function clearReportVehicleInput() {
      document.getElementById('reportVehicleInput').value = '';
      document.getElementById('reportVehicleSuggestions').style.display = 'none';
      toggleReportVehicleClearButton();
    }

    // Enhanced generateAllOutDataReport function with exact format match
    function generateAllOutDataReport() {
      if (outData.length === 0) {
        return alert('No OUT data available for report generation.');
      }
      
      // Calculate total Gross WT
      const totalGrossWT = outData.reduce((sum, row) => {
        const grossWT = parseFloat(row['GROSS WT'] || 0);
        return sum + (isNaN(grossWT) ? 0 : grossWT);
      }, 0);
      
      // Create filtered data with exact column structure
      const reportData = outData.map(row => ({
        'Serial No': row['Serial No'],
        'Date & Time': row['Date & Time'],
        'Vehicle No': row['Vehicle No'],
        'Mill Coil No': row['Mill Coil No'],
        'TRANSPORTER': row['TRANSPORTER'],
        'GROSS WT': row['GROSS WT']
      }));
      
      // Add total row exactly as shown in image
      reportData.push({
        'Serial No': '',
        'Date & Time': '',
        'Vehicle No': '',
        'Mill Coil No': '',
        'TRANSPORTER': 'TOTAL',
        'GROSS WT': totalGrossWT
      });
      
      // Create Excel workbook
      const worksheet = XLSX.utils.json_to_sheet(reportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "All OUT Data Report");
      
      // Generate filename with current date
      const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
      const fileName = `All_OUT_Data_Report_${currentDate.replace(/-/g, '')}.xlsx`;
      
      XLSX.writeFile(workbook, fileName);
      alert(`All OUT Data Report generated with total Gross WT: ${totalGrossWT.toFixed(2)}`);
    }

    function generateVehicleOutReport() {
      const vehicleNumber = document.getElementById('reportVehicleInput').value.trim().toUpperCase();
      
      if (!vehicleNumber) {
        return alert('Please enter a vehicle number for the report.');
      }
      
      const vehicleOutData = outData.filter(row => {
        const vehicle = row['Vehicle No'] || '';
        return String(vehicle).trim().toUpperCase() === vehicleNumber;
      });
      
      if (vehicleOutData.length === 0) {
        return alert(`No OUT data found for vehicle: ${vehicleNumber}`);
      }
      
      // Calculate total Gross WT for this vehicle
      const totalGrossWT = vehicleOutData.reduce((sum, row) => {
        const grossWT = parseFloat(row['GROSS WT'] || 0);
        return sum + (isNaN(grossWT) ? 0 : grossWT);
      }, 0);
      
      // Create filtered data with exact column structure (same as All OUT report)
      const reportData = vehicleOutData.map(row => ({
        'Serial No': row['Serial No'],
        'Date & Time': row['Date & Time'],
        'Vehicle No': row['Vehicle No'],
        'Mill Coil No': row['Mill Coil No'],
        'TRANSPORTER': row['TRANSPORTER'],
        'GROSS WT': row['GROSS WT']
      }));
      
      // Add total row exactly as shown in All OUT report format
      reportData.push({
        'Serial No': '',
        'Date & Time': '',
        'Vehicle No': '',
        'Mill Coil No': '',
        'TRANSPORTER': 'TOTAL',
        'GROSS WT': totalGrossWT
      });
      
      // Create Excel workbook
      const worksheet = XLSX.utils.json_to_sheet(reportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, `${vehicleNumber} OUT Report`);
      
      // Generate filename with current date
      const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
      const fileName = `${vehicleNumber}_OUT_Report_${currentDate.replace(/-/g, '')}.xlsx`;
      
      XLSX.writeFile(workbook, fileName);
      alert(`Vehicle report generated for ${vehicleNumber} with total Gross WT: ${totalGrossWT.toFixed(2)}`);
    }

    // Auto-search when typing in coil input
    document.getElementById('coilInput').addEventListener('input', function() {
      const value = this.value.trim();
      if (value.length > 0) {
        searchCoil();
      } else {
        document.getElementById('result').innerHTML = '';
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.input-container')) {
        document.getElementById('suggestions').style.display = 'none';
        document.getElementById('vehicleSuggestions').style.display = 'none';
        document.getElementById('reportVehicleSuggestions').style.display = 'none';
      }
    });

    // Mobile-specific optimizations
    document.addEventListener('touchstart', function() {}, {passive: true});
    document.addEventListener('touchmove', function() {}, {passive: true});
  </script>
</body>
</html>